{% extends 'admin/base_site.html' %}
{% load static %}

{% block extrastyle %}
<style>
.progress-container {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    border: 2px solid #e9ecef;
}

.progress-bar {
    background: #e9ecef;
    border-radius: 20px;
    height: 30px;
    margin: 15px 0;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    background: linear-gradient(45deg, #28a745, #20c997);
    height: 100%;
    border-radius: 20px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.progress-message {
    text-align: center;
    font-size: 16px;
    font-weight: 500;
    margin: 10px 0;
    color: #495057;
}

.superuser-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.copy-btn {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 10px;
}

.copy-btn:hover {
    background: #138496;
}

.control-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 20px 0;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.log-container {
    background: #1e1e1e;
    color: #00ff00;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    height: 300px;
    overflow-y: auto;
    margin: 20px 0;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-active {
    background: #28a745;
    animation: pulse 1.5s infinite;
}

.status-inactive {
    background: #dc3545;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>
{% endblock %}

{% block content %}
<div class="progress-container">
    <h2>ğŸš€ Ù¾Ù†Ù„ Ú©Ù†ØªØ±Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h2>

    <!-- Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª -->
    <div class="progress-message" id="progressMessage">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹...</div>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
    </div>

    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙˆÙ¾Ø±ÛŒÙˆØ²Ø± -->
    <div class="superuser-info" id="superuserInfo" style="display: none;">
        <h4>ğŸ‘‘ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ù…Ø¯ÛŒØ±</h4>
        <div id="superuserContent"></div>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ -->
    <div class="control-buttons">
        <button class="btn btn-success" onclick="startFullTransfer()">
            ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ù…Ø­Ù„ÛŒ
        </button>
        <button class="btn btn-danger" onclick="clearLocalDB()">
            ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ÙˆÚ©Ø§Ù„
        </button>
        <button class="btn btn-primary" onclick="checkProgress()">
            ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
        </button>
    </div>

    <!-- ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒÙ†Ú© -->
    <div style="margin: 20px 0;">
        <h4>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒÙ†Ú©</h4>
        <p>
            <span class="status-indicator status-inactive" id="syncStatus"></span>
            ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒÙ†Ú© Ø®ÙˆØ¯Ú©Ø§Ø±: <span id="syncStatusText">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
        </p>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ -->
    <div class="log-container" id="logContent">
        Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯...
    </div>
</div>

<script>
let progressInterval;

function startFullTransfer() {
    if (confirm('âš ï¸ Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ø§ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.')) {
        executeCommand('full_data_transfer');
        startProgressMonitor();
    }
}

function clearLocalDB() {
    if (confirm('ğŸš¨ âš ï¸  Ù‡Ø´Ø¯Ø§Ø±! Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ÙˆÚ©Ø§Ù„ Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
        executeCommand('clear_local_db');
        startProgressMonitor();
    }
}

function executeCommand(command) {
    fetch('/sync/execute-command/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({command: command})
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
    })
    .catch(error => {
        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±', 'error');
    });
}

function startProgressMonitor() {
    if (progressInterval) clearInterval(progressInterval);

    progressInterval = setInterval(() => {
        checkProgress();
    }, 2000);
}

function checkProgress() {
    fetch('/sync/command-status/')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('logContent').innerText = data.content;
        }
    });

    fetch('/sync/transfer-progress/')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const progress = data.data;
            document.getElementById('progressMessage').innerText = progress.message;
            document.getElementById('progressFill').style.width = progress.percentage + '%';
            document.getElementById('progressFill').innerText = progress.percentage + '%';

            if (progress.completed) {
                clearInterval(progressInterval);
                if (progress.superuser_info) {
                    showSuperuserInfo(progress.superuser_info);
                }
                showNotification('âœ… Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª completed!', 'success');
            }

            if (progress.error) {
                clearInterval(progressInterval);
                showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'error');
            }
        }
    });
}

function showSuperuserInfo(info) {
    const content = `
        <p><strong>${info.message}</strong></p>
        <p>ğŸ“ Ù†Ø§Ù… Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±: ${info.hostname}</p>
        <p>ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${info.username}</code>
            <button class="copy-btn" onclick="copyToClipboard('${info.username}')">ğŸ“‹ Ú©Ù¾ÛŒ</button>
        </p>
        <p>ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: <code>${info.password}</code>
            <button class="copy-btn" onclick="copyToClipboard('${info.password}')">ğŸ“‹ Ú©Ù¾ÛŒ</button>
        </p>
        <p>ğŸ’¡ Ù†Ú©ØªÙ‡: Ø§Ø² Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>
    `;

    document.getElementById('superuserContent').innerHTML = content;
    document.getElementById('superuserInfo').style.display = 'block';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('âœ… Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
    });
}

function showNotification(message, type) {
    // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
    alert(message);
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', function() {
    checkProgress();
});
</script>
{% endblock %}
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم صدور فاکتور فروش</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #388E3C;
            --accent-color: #1B5E20;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --gradient-primary: linear-gradient(135deg, #2E7D32, #4CAF50);
            --gradient-success: linear-gradient(135deg, #4CAF50, #66BB6A);
            --gradient-warning: linear-gradient(135deg, #FF9800, #FFB74D);
            --gradient-danger: linear-gradient(135deg, #F44336, #EF5350);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-color);
            direction: rtl;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        .branch-info {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
        }

        .section-card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            font-size: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            border-color: var(--accent-color);
        }

        .search-results {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--light-bg);
        }

        .low-stock {
            background-color: #ffebee !important;
            color: #d32f2f !important;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .invoice-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .invoice-table td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: background 0.2s;
        }

        .invoice-table tr:hover td {
            background-color: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--gradient-success);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #66BB6A, #81C784);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #FFB74D, #FFCC80);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #EF5350, #E57373);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #78909c;
            color: white;
        }

        .btn-secondary:hover {
            background: #546e7a;
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid var(--success-color);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #bdbdbd;
            font-size: 0.95rem;
        }

        .summary-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 10px;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-bottom: none;
            padding: 15px 20px;
        }

        .modal-title {
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            outline: none;
        }

        .form-control-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        .payment-method-btn {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .payment-method-btn:hover {
            border-color: var(--primary-color);
            background: #f1f8e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .payment-method-btn.active {
            border-color: var(--accent-color);
            background: #e8f5e9;
            box-shadow: 0 2px 6px rgba(46, 125, 50, 0.2);
        }

        .discount-input {
            max-width: 200px;
        }

        .date-picker-container {
            position: relative;
        }

        .date-picker-container .form-control {
            padding-left: 40px;
        }

        .date-picker-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .device-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .device-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .device-card .card-body {
            padding: 12px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .bg-success {
            background: var(--success-color) !important;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card {
            animation: fadeIn 0.5s ease-out;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .form-text {
            font-size: 0.8rem;
            color: #78909c;
            margin-top: 4px;
        }

        .text-muted {
            color: #78909c !important;
        }

        .border {
            border: 1px solid var(--border-color) !important;
        }

        .rounded {
            border-radius: 8px !important;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        /* استایل‌های مودال وضعیت پرداخت */
        .payment-status-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .payment-success {
            color: var(--success-color);
        }
        
        .payment-error {
            color: var(--danger-color);
        }
        
        .payment-warning {
            color: var(--warning-color);
        }
        
        .payment-info {
            color: var(--primary-color);
        }

        .status-message {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }

            .invoice-table {
                font-size: 0.8rem;
            }

            .invoice-table th,
            .invoice-table td {
                padding: 8px 5px;
            }

            .section-card {
                padding: 12px;
            }

            .payment-method-btn {
                padding: 12px;
                font-size: 0.85rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                min-width: 100%;
            }
            
            .payment-status-icon {
                font-size: 3rem;
            }
            
            .status-message {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-receipt"></i> سیستم صدور فاکتور فروش</h1>
        </div>

        {% if not branch_selected %}
        <!-- فرم انتخاب شعبه -->
        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-store"></i> انتخاب شعبه</h2>
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_branch">شعبه:</label>
                    {{ form.branch }}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> تایید شعبه
                </button>
            </form>
        </div>
        {% else %}
        <!-- صفحه اصلی فاکتور -->
        <div class="branch-info">
            <i class="fas fa-store"></i> شعبه: {{ branch.name }} |
            <i class="fas fa-user"></i> کاربر: {{ user.get_full_name|default:user.username }}
        </div>

        <!-- بخش مدیریت دستگاه‌های پوز -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-pos-terminal"></i> مدیریت دستگاه‌های پرداخت</h3>
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#posDeviceModal">
                        <i class="fas fa-plus-circle"></i> افزودن دستگاه پوز جدید
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="showAllPOSDevices()">
                        <i class="fas fa-list"></i> مشاهده دستگاه‌های موجود
                    </button>
                </div>
            </div>

            {% if default_pos %}
            <div class="alert alert-info mt-2">
                <strong><i class="fas fa-star"></i> دستگاه پیش‌فرض:</strong>
                {{ default_pos.name }} - {{ default_pos.bank_name }}
            </div>
            {% endif %}
        </div>

        <!-- بخش اطلاعات فاکتور -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-user"></i> اطلاعات فاکتور</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="customer-name">نام خریدار:</label>
                        <input type="text" id="customer-name" class="form-control" value="{{ customer_name }}" placeholder="نام خریدار">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="customer-phone">تلفن خریدار:</label>
                        <input type="text" id="customer-phone" class="form-control" value="{{ customer_phone }}" placeholder="تلفن خریدار">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="invoice-date">تاریخ فاکتور:</label>
                        <div class="date-picker-container">
                            <i class="fas fa-calendar-alt date-picker-icon" onclick="openDatePicker()"></i>
                            <input type="text" id="invoice-date" class="form-control" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- بخش روش پرداخت -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-credit-card"></i> روش پرداخت</h3>
            <div class="row">
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'pos' %}active{% endif %}" data-method="pos">
                        <i class="fas fa-pos-terminal"></i>
                        <span>
                            دستگاه پوز
                            {% if default_pos %}
                            <br><small>{{ default_pos.name }}</small>
                            {% endif %}
                        </span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'cash' %}active{% endif %}" data-method="cash">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>نقدی</span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'check' %}active{% endif %}" data-method="check">
                        <i class="fas fa-money-check"></i>
                        <span>چک</span>
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="payment-method-btn {% if payment_method == 'credit' %}active{% endif %}" data-method="credit">
                        <i class="fas fa-calendar-day"></i>
                        <span>نسیه</span>
                    </button>
                </div>
            </div>

            <!-- بخش دستگاه‌های پوز -->
            <div id="pos-devices-section" class="mt-3" style="display: {% if payment_method == 'pos' %}block{% else %}none{% endif %};">
                <div class="form-group">
                    <label for="pos-device">انتخاب دستگاه پوز:</label>
                    <select id="pos-device" class="form-control">
                        {% for device in pos_devices %}
                            <option value="{{ device.id }}" {% if default_pos and device.id == default_pos.id %}selected{% endif %}>
                                {{ device.name }} - {{ device.bank_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- بخش جستجو و افزودن کالا -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-search"></i> جستجو و افزودن کالا</h3>
            <div class="search-container">
                <input type="text" id="product-search" class="search-input" placeholder="نام یا بارکد کالا را وارد کنید...">
                <div id="search-results" class="search-results"></div>
            </div>
            <small class="text-muted">برای جستجو، حداقل 2 کاراکتر وارد کنید</small>
        </div>

        <!-- لیست کالاهای فاکتور -->
        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-list"></i> لیست کالاهای فاکتور</h3>
            <div class="table-responsive">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>نام کالا</th>
                            <th>تعداد</th>
                            <th>قیمت واحد</th>
                            <th>تخفیف آیتم</th>
                            <th>قیمت کل</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-list">
                        {% for item in items %}
                        <tr id="item-{{ item.product_id }}">
                            <td>{{ item.product_name }}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm quantity-input"
                                       value="{{ item.quantity }}" min="1"
                                       data-product-id="{{ item.product_id }}"
                                       style="width: 80px; display: inline-block;">
                            </td>
                            <td>{{ item.price|floatformat:"0" }} تومان</td>
                            <td>
                                <input type="number" class="form-control form-control-sm discount-input"
                                       value="{{ item.discount|default:0 }}" min="0"
                                       data-product-id="{{ item.product_id }}"
                                       style="width: 100px; display: inline-block;">
                            </td>
                            <td>{{ item.total|floatformat:"0" }} تومان</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="removeItem({{ item.product_id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- خلاصه فاکتور و تخفیف -->
        <div class="section-card summary-card">
            <h3 class="section-title"><i class="fas fa-calculator"></i> خلاصه فاکتور</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="summary-item">
                        <span>تعداد آیتم‌ها:</span>
                        <span id="total-items">{{ items|length }}</span>
                    </div>
                    <div class="summary-item">
                        <span>جمع کل بدون تخفیف:</span>
                        <span id="total-without-discount">0 تومان</span>
                    </div>
                    <div class="summary-item">
                        <span>تخفیف آیتم‌ها:</span>
                        <span id="items-discount">0 تومان</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="total-discount">تخفیف کل فاکتور (تومان):</label>
                        <input type="number" id="total-discount" class="form-control discount-input"
                               value="{{ discount }}" min="0" style="max-width: 200px;">
                    </div>
                    <div class="summary-item summary-total">
                        <span>مبلغ قابل پرداخت:</span>
                        <span id="total-amount">{{ total_amount|floatformat:"0" }} تومان</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌های اقدام -->
        <div class="section-card">
            <div class="action-buttons">
                <button type="button" class="btn btn-danger" id="cancel-invoice-btn">
                    <i class="fas fa-times"></i> انصراف و لغو فاکتور
                </button>
                <div class="d-flex" style="gap: 10px;">
                    <button type="button" class="btn btn-secondary" id="save-invoice-btn">
                        <i class="fas fa-save"></i> ثبت فاکتور
                    </button>
                </div>
            </div>
        </div>

        <!-- سیستم پیام‌ها -->
        <div id="toast-container" class="toast-container"></div>
        {% endif %}
    </div>

    <!-- مودال وضعیت پرداخت -->
    <div class="modal fade" id="paymentStatusModal" tabindex="-1" aria-labelledby="paymentStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="paymentStatusModalLabel">
                        <i class="fas fa-credit-card me-2"></i>
                        وضعیت پرداخت
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <!-- آیکون وضعیت -->
                    <div id="payment-status-icon" class="payment-status-icon">
                        <i class="fas fa-spinner fa-spin payment-info"></i>
                    </div>
                    
                    <!-- پیام وضعیت -->
                    <div id="payment-status-message" class="status-message">
                        در حال پردازش پرداخت...
                    </div>
                    
                    <!-- جزئیات تراکنش -->
                    <div id="transaction-details" class="mt-3 p-3 bg-light rounded" style="display: none;">
                        <h6 class="border-bottom pb-2">جزئیات تراکنش</h6>
                        <div class="row text-start small">
                            <div class="col-6">
                                <span class="text-muted">مبلغ:</span>
                                <div id="transaction-amount" class="fw-bold"></div>
                            </div>
                            <div class="col-6">
                                <span class="text-muted">زمان:</span>
                                <div id="transaction-time" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <!-- دکمه‌های حالت موفق -->
                    <div id="success-buttons" style="display: none;">
                        <button type="button" class="btn btn-success me-2" onclick="createNewInvoice()">
                            <i class="fas fa-plus-circle me-1"></i>
                            فاکتور جدید
                        </button>
                        <button type="button" class="btn btn-primary" onclick="printCurrentInvoice()">
                            <i class="fas fa-print me-1"></i>
                            پرینت فاکتور
                        </button>
                    </div>

                    <!-- دکمه‌های حالت خطا -->
                    <div id="error-buttons" style="display: none;">
                        <button type="button" class="btn btn-warning me-2" onclick="retryPayment()">
                            <i class="fas fa-redo me-1"></i>
                            تلاش مجدد
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            بستن
                        </button>
                    </div>

                    <!-- دکمه حالت پردازش -->
                    <div id="processing-buttons">
                        <button type="button" class="btn btn-secondary" onclick="cancelPayment()">
                            <i class="fas fa-times me-1"></i>
                            لغو پرداخت
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال دستگاه پوز -->
    <div class="modal fade" id="posDeviceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-pos-terminal"></i> مدیریت دستگاه‌های پوز</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- فرم افزودن دستگاه جدید -->
                    <div class="mb-4">
                        <h6><i class="fas fa-plus-circle"></i> افزودن دستگاه جدید:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="device-name" class="form-label">نام دستگاه *</label>
                                    <input type="text" class="form-control" id="device-name" placeholder="مثال: پوز بانک ملت" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="account-holder" class="form-label">نام صاحب حساب *</label>
                                    <input type="text" class="form-control" id="account-holder" placeholder="نام کامل صاحب حساب" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="card-number" class="form-label">شماره کارت *</label>
                                    <input type="text" class="form-control" id="card-number" maxlength="16" placeholder="16 رقم شماره کارت" required>
                                    <small class="form-text text-muted">شماره کارت باید 16 رقم باشد</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="account-number" class="form-label">شماره حساب *</label>
                                    <input type="text" class="form-control" id="account-number" placeholder="شماره حساب بانکی" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="bank-name" class="form-label">نام بانک *</label>
                            <input type="text" class="form-control" id="bank-name" placeholder="مثال: بانک ملت" required>
                        </div>
                    </div>

                    <hr>

                    <!-- لیست دستگاه‌های موجود -->
                    <h6><i class="fas fa-list"></i> دستگاه‌های موجود:</h6>
                    <div id="pos-devices-list" class="mb-3">
                        {% for device in pos_devices %}
                        <div class="card device-card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ device.name }}</strong> - {{ device.bank_name }}
                                        {% if device.is_default %}
                                            <span class="badge bg-success me-2"><i class="fas fa-star"></i> پیش فرض</span>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-credit-card"></i> شماره کارت: {{ device.card_number }} |
                                            <i class="fas fa-user"></i> صاحب حساب: {{ device.account_holder }}
                                        </small>
                                    </div>
                                    <div>
                                        {% if not device.is_default %}
                                        <button class="btn btn-sm btn-outline-success me-1 set-default-btn"
                                                data-device-id="{{ device.id }}" title="تنظیم پیش‌فرض">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-device-btn"
                                                data-device-id="{{ device.id }}" title="حذف دستگاه">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted p-3 border rounded">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>هیچ دستگاهی ثبت نشده است</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> بستن
                    </button>
                    <button type="button" class="btn btn-success" id="addDeviceButton">
                        <i class="fas fa-plus-circle"></i> افزودن دستگاه جدید
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال پرداخت چک -->
    <div class="modal fade" id="checkPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-money-check"></i> اطلاعات پرداخت چک</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>مبلغ کل فاکتور: <span id="check-invoice-total">0</span> تومان</strong>
                    </div>

                    <form id="check-payment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام صاحب چک *</label>
                                    <input type="text" name="owner_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام خانوادگی صاحب چک *</label>
                                    <input type="text" name="owner_family" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>کد ملی *</label>
                                    <input type="text" name="national_id" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>تلفن *</label>
                                    <input type="text" name="phone" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>آدرس</label>
                            <textarea name="address" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>شماره چک *</label>
                                    <input type="text" name="check_number" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>مبلغ چک (تومان) *</label>
                                    <input type="number" name="amount" class="form-control" id="check-amount" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>تاریخ چک *</label>
                            <div class="date-picker-container">
                                <i class="fas fa-calendar-alt date-picker-icon" onclick="openCheckDatePicker()"></i>
                                <input type="text" name="check_date" class="form-control" id="check-date" readonly required>
                            </div>
                        </div>

                        <!-- بخش مبلغ باقیمانده -->
                        <div class="border-top pt-3 mt-3">
                            <h6><i class="fas fa-calculator"></i> محاسبه مبلغ باقیمانده</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>مبلغ باقیمانده</label>
                                        <input type="number" name="remaining_amount" class="form-control" id="remaining-amount" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>روش پرداخت باقیمانده *</label>
                                        <select name="remaining_payment_method" class="form-control" id="remaining-payment-method" required>
                                            <option value="cash">نقدی</option>
                                            <option value="pos">دستگاه پوز</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- انتخاب دستگاه پوز برای باقیمانده -->
                            <div id="remaining-pos-section" style="display: none;">
                                <div class="form-group">
                                    <label>انتخاب دستگاه پوز برای پرداخت باقیمانده</label>
                                    <select name="remaining_pos_device_id" class="form-control" id="remaining-pos-device">
                                        {% for device in pos_devices %}
                                            <option value="{{ device.id }}">{{ device.name }} - {{ device.bank_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    <button type="button" class="btn btn-warning" onclick="saveCheckPayment()">
                        <i class="fas fa-save"></i> ذخیره اطلاعات چک
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال پرداخت نسیه -->
    <div class="modal fade" id="creditPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar-day"></i> اطلاعات پرداخت نسیه</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>مبلغ کل فاکتور: <span id="credit-invoice-total">0</span> تومان</strong>
                    </div>

                    <form id="credit-payment-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام *</label>
                                    <input type="text" name="customer_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>نام خانوادگی *</label>
                                    <input type="text" name="customer_family" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>کد ملی *</label>
                                    <input type="text" name="national_id" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>تلفن *</label>
                                    <input type="text" name="phone" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>آدرس</label>
                            <textarea name="address" class="form-control" rows="2"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>مبلغ نسیه (تومان) *</label>
                                    <input type="number" name="credit_amount" class="form-control" id="credit-amount" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>تاریخ سررسید *</label>
                                    <div class="date-picker-container">
                                        <i class="fas fa-calendar-alt date-picker-icon" onclick="openDueDatePicker()"></i>
                                        <input type="text" name="due_date" class="form-control" id="due-date" readonly required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- بخش مبلغ باقیمانده -->
                        <div class="border-top pt-3 mt-3">
                            <h6><i class="fas fa-calculator"></i> محاسبه مبلغ باقیمانده</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>مبلغ باقیمانده</label>
                                        <input type="number" name="remaining_amount" class="form-control" id="credit-remaining-amount" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>روش پرداخت باقیمانده *</label>
                                        <select name="remaining_payment_method" class="form-control" id="credit-remaining-payment-method" required>
                                            <option value="cash">نقدی</option>
                                            <option value="pos">دستگاه پوز</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- انتخاب دستگاه پوز برای باقیمانده -->
                            <div id="credit-remaining-pos-section" style="display: none;">
                                <div class="form-group">
                                    <label>انتخاب دستگاه پوز برای پرداخت باقیمانده</label>
                                    <select name="remaining_pos_device_id" class="form-control" id="credit-remaining-pos-device">
                                        {% for device in pos_devices %}
                                            <option value="{{ device.id }}">{{ device.name }} - {{ device.bank_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    <button type="button" class="btn btn-primary" onclick="saveCreditPayment()">
                        <i class="fas fa-save"></i> ذخیره اطلاعات نسیه
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/jQueryv3.7.1.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <script>
    // =============================================
    // متغیرهای global و تنظیمات اولیه
    // =============================================
    let currentPaymentMethod = '{{ payment_method|default:"pos" }}';
    let searchTimeout = null;
    let invoiceDatePicker, checkDatePicker, dueDatePicker;
    let barcodeBuffer = "";
    let barcodeTimeout = null;
    const BARCODE_DELAY = 150;
    let lastBarcodeTime = 0;
    let currentInvoiceId = null;
    let currentPaymentAmount = 0;

    // =============================================
    // تابع getCookie
    // =============================================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // =============================================
    // تابع نمایش پیام (Toast)
    // =============================================
    function showToast(message, type = 'info') {
        const toast = $(`
            <div class="toast ${type}">
                <div class="toast-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${message}</span>
                        <button type="button" class="btn-close" onclick="$(this).closest('.toast').remove()"></button>
                    </div>
                </div>
            </div>
        `);

        $('#toast-container').append(toast);

        setTimeout(() => {
            toast.fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }

    // =============================================
    // توابع مدیریت تاریخ‌ها
    // =============================================
    function initializeDatePickers() {
        // تاریخ فاکتور
        invoiceDatePicker = $('#invoice-date').persianDatepicker({
            format: 'YYYY/MM/DD',
            initialValue: true,
            initialValueType: 'persian',
            autoClose: true,
            observer: true,
            position: 'auto'
        });

        // تاریخ چک
        checkDatePicker = $('#check-date').persianDatepicker({
            format: 'YYYY/MM/DD',
            initialValue: true,
            initialValueType: 'persian',
            autoClose: true,
            observer: true,
            position: 'auto'
        });

        // تاریخ سررسید نسیه
        dueDatePicker = $('#due-date').persianDatepicker({
            format: 'YYYY/MM/DD',
            initialValue: false,
            initialValueType: 'persian',
            autoClose: true,
            observer: true,
            position: 'auto'
        });
    }

    function openDatePicker() {
        invoiceDatePicker.persianDatepicker('show');
    }

    function openCheckDatePicker() {
        checkDatePicker.persianDatepicker('show');
    }

    function openDueDatePicker() {
        dueDatePicker.persianDatepicker('show');
    }

    // =============================================
    // توابع محاسبات فاکتور
    // =============================================
    function calculateInvoiceTotal() {
        let totalItems = 0;
        let totalWithoutDiscount = 0;
        let itemsDiscount = 0;
        let totalAmount = 0;

        $('#invoice-items-list tr').each(function() {
            if ($(this).find('.quantity-input').length > 0) {
                const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
                const price = parseFloat($(this).find('.quantity-input').data('price')) || 0;
                const discount = parseInt($(this).find('.discount-input').val()) || 0;

                totalItems += quantity;
                totalWithoutDiscount += quantity * price;
                itemsDiscount += discount;
            }
        });

        const totalDiscount = parseInt($('#total-discount').val()) || 0;
        totalAmount = Math.max(0, totalWithoutDiscount - itemsDiscount - totalDiscount);

        $('#total-items').text(totalItems);
        $('#total-without-discount').text(totalWithoutDiscount.toLocaleString('fa-IR') + ' تومان');
        $('#items-discount').text(itemsDiscount.toLocaleString('fa-IR') + ' تومان');
        $('#total-amount').text(totalAmount.toLocaleString('fa-IR') + ' تومان');

        return { totalItems, totalWithoutDiscount, itemsDiscount, totalDiscount, totalAmount };
    }

    function updateItemRowTotal(productId) {
        const row = $(`#item-${productId}`);
        if (row.length === 0) return;

        const quantityInput = row.find('.quantity-input');
        const quantity = parseInt(quantityInput.val()) || 0;
        const price = parseFloat(quantityInput.data('price')) || 0;
        const discount = parseInt(row.find('.discount-input').val()) || 0;
        const total = (quantity * price) - discount;

        row.find('td').eq(4).text(total.toLocaleString('fa-IR') + ' تومان');
        calculateInvoiceTotal();
    }

    // =============================================
    // توابع جستجو و بارکد
    // =============================================
    function setupBarcodeScanner() {
        $('#product-search').on('keydown', function(e) {
            const currentTime = new Date().getTime();

            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();

                if (barcodeBuffer.length >= 6) {
                    processBarcodeScan(barcodeBuffer);
                }

                barcodeBuffer = "";
                $(this).val('');
                return;
            }

            if (e.key.length === 1 && e.key !== ' ' && e.key !== 'Enter') {
                if (currentTime - lastBarcodeTime < BARCODE_DELAY) {
                    barcodeBuffer += e.key;
                } else {
                    barcodeBuffer = e.key;
                }

                lastBarcodeTime = currentTime;

                clearTimeout(barcodeTimeout);
                barcodeTimeout = setTimeout(function() {
                    if (barcodeBuffer.length >= 8 && /^\d+$/.test(barcodeBuffer)) {
                        processBarcodeScan(barcodeBuffer);
                        barcodeBuffer = "";
                        $('#product-search').val('');
                    }
                }, BARCODE_DELAY + 50);
            }
        });

        $('#product-search').on('input', function(e) {
            const value = $(this).val().trim();

            if (value.length >= 8 && /^\d+$/.test(value)) {
                clearTimeout(barcodeTimeout);

                barcodeTimeout = setTimeout(() => {
                    processBarcodeScan(value);
                    $(this).val('');
                }, 300);
            }
        });
    }

    function processBarcodeScan(barcode) {
        showToast('در حال جستجوی کالا...', 'info');

        $.ajax({
            url: "{% url 'invoice_app:invoice_search_product' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ query: barcode }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.error) {
                    showToast('خطا در جستجو: ' + data.error, 'error');
                    return;
                }

                if (!data.results || data.results.length === 0) {
                    showToast('کالایی با این بارکد یافت نشد', 'warning');
                    $('#product-search').val('').focus();
                    return;
                }

                if (data.results.length === 1) {
                    const product = data.results[0];
                    if (product.quantity <= 0) {
                        if (confirm(`کالای "${product.name}" موجودی صفر دارد. آیا می‌خواهید ادامه دهید؟`)) {
                            addToInvoice(product.id, 1, true);
                        }
                    } else {
                        addToInvoice(product.id, 1, true);
                    }
                } else {
                    showToast('چند کالا یافت شد. لطفا انتخاب کنید', 'info');
                    displaySearchResults(data.results);
                }
            },
            error: function() {
                showToast('خطا در ارتباط با سرور', 'error');
                $('#product-search').val('').focus();
            }
        });
    }

    function searchProduct(query) {
        $.ajax({
            url: "{% url 'invoice_app:invoice_search_product' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ query: query }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (!data.error) {
                    displaySearchResults(data.results);
                }
            },
            error: function() {
                showToast('خطا در جستجوی محصول', 'error');
            }
        });
    }

    function displaySearchResults(results) {
        const container = $('#search-results');
        container.empty();

        results.forEach((product) => {
            const stockStatus = product.quantity <= 0 ?
                '<span class="badge bg-danger">موجودی صفر</span>' :
                `<span class="badge bg-success">موجودی: ${product.quantity}</span>`;

            const item = $(`
                <div class="search-result-item" data-product-id="${product.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${product.name}</strong>
                            <div class="text-muted small">قیمت: ${product.price.toLocaleString('fa-IR')}</div>
                        </div>
                        ${stockStatus}
                    </div>
                    ${product.barcode ? `<div class="small text-muted">بارکد: ${product.barcode}</div>` : ''}
                </div>
            `);

            container.append(item);
        });

        container.show();
    }

    // =============================================
    // توابع مدیریت آیتم‌های فاکتور
    // =============================================
    function addToInvoice(productId, quantity = 1, isAutoAdd = false) {
        $.ajax({
            url: "{% url 'invoice_app:invoice_add_item' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                product_id: productId,
                quantity: quantity,
                is_auto_add: isAutoAdd
            }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    updateInvoiceTable(data.items);
                    showToast('کالا با موفقیت اضافه شد', 'success');
                    $('#product-search').val('').focus();
                    $('#search-results').hide();
                } else if (data.status === 'error') {
                    if (data.message.includes('موجودی کافی نیست')) {
                        if (confirm(data.message + '\n\nآیا می‌خواهید ادامه دهید؟')) {
                            forceAddToInvoice(productId, quantity);
                        }
                    } else {
                        showToast(data.message, 'error');
                        $('#product-search').val('').focus();
                    }
                }
            },
            error: function() {
                showToast('خطا در ارتباط با سرور', 'error');
                $('#product-search').val('').focus();
            }
        });
    }

    function forceAddToInvoice(productId, quantity = 1) {
        $.ajax({
            url: "{% url 'invoice_app:invoice_add_item' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                product_id: productId,
                quantity: quantity,
                ignore_stock: true
            }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    updateInvoiceTable(data.items);
                    showToast('کالا با موفقیت اضافه شد (با وجود محدودیت موجودی)', 'warning');
                    $('#product-search').val('').focus();
                }
            },
            error: function() {
                showToast('خطا در افزودن کالا', 'error');
            }
        });
    }

    function updateInvoiceTable(items) {
        const tbody = $('#invoice-items-list');
        tbody.empty();

        if (items.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center text-muted py-3">هیچ کالایی در فاکتور وجود ندارد</td></tr>');
            calculateInvoiceTotal();
            return;
        }

        items.forEach(item => {
            const totalAmount = (item.quantity * item.price) - (item.discount || 0);

            const row = `
                <tr id="item-${item.product_id}">
                    <td>${item.product_name}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm quantity-input"
                               value="${item.quantity}" min="1"
                               data-product-id="${item.product_id}"
                               data-price="${item.price}"
                               style="width: 80px; display: inline-block;">
                    </td>
                    <td>${item.price.toLocaleString('fa-IR')} تومان</td>
                    <td>
                        <input type="number" class="form-control form-control-sm discount-input"
                               value="${item.discount || 0}" min="0"
                               data-product-id="${item.product_id}"
                               style="width: 100px; display: inline-block;">
                    </td>
                    <td>${totalAmount.toLocaleString('fa-IR')} تومان</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeItem(${item.product_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        calculateInvoiceTotal();
    }

    function removeItem(productId) {
        if (!confirm('آیا از حذف این کالا اطمینان دارید؟')) return;

        $.ajax({
            url: "{% url 'invoice_app:invoice_remove_item' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ product_id: productId }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    updateInvoiceTable(data.items);
                    showToast('کالا حذف شد', 'success');
                }
            },
            error: function() {
                showToast('خطا در حذف کالا', 'error');
            }
        });
    }

    function updateItemQuantity(productId, quantity) {
        $.ajax({
            url: "{% url 'invoice_app:update_item_quantity' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ product_id: productId, quantity: quantity }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    showToast('تعداد به روز شد', 'success');
                }
            },
            error: function() {
                showToast('خطا در به روزرسانی تعداد', 'error');
            }
        });
    }

    function updateItemDiscount(productId, discount) {
        $.ajax({
            url: "{% url 'invoice_app:update_item_discount' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ product_id: productId, discount: discount }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    showToast('تخفیف به روز شد', 'success');
                }
            },
            error: function() {
                showToast('خطا در به روزرسانی تخفیف', 'error');
            }
        });
    }

    // =============================================
    // توابع مدیریت پرداخت
    // =============================================
    function savePaymentMethod(method) {
        $.ajax({
            url: "{% url 'invoice_app:save_payment_method' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ payment_method: method }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    console.log("✅ روش پرداخت ذخیره شد:", method);
                }
            },
            error: function() {
                showToast('خطا در ذخیره روش پرداخت', 'error');
            }
        });
    }

    function saveSelectedPosDevice() {
        const deviceId = $('#pos-device').val();

        if (!deviceId) {
            showToast('لطفا یک دستگاه پوز انتخاب کنید', 'error');
            return false;
        }

        $.ajax({
            url: "{% url 'invoice_app:save_pos_device' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ device_id: deviceId }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    console.log('✅ دستگاه پوز ذخیره شد');
                }
            },
            error: function() {
                showToast('خطا در ذخیره دستگاه پوز', 'error');
            }
        });

        return true;
    }

    function saveCustomerInfo() {
        const name = $('#customer-name').val();
        const phone = $('#customer-phone').val();

        $.ajax({
            url: "{% url 'invoice_app:save_customer_info' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ customer_name: name, customer_phone: phone }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    console.log('✅ اطلاعات مشتری ذخیره شد');
                }
            },
            error: function() {
                showToast('خطا در ذخیره اطلاعات مشتری', 'error');
            }
        });
    }

    function saveDiscount() {
        const discount = parseInt($('#total-discount').val()) || 0;

        $.ajax({
            url: "{% url 'invoice_app:save_discount' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ discount: discount }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    console.log('✅ تخفیف ذخیره شد');
                }
            },
            error: function() {
                showToast('خطا در ذخیره تخفیف', 'error');
            }
        });
    }

    // =============================================
    // توابع مدیریت دستگاه‌های POS
    // =============================================
    function addPosDevice() {
        const formData = {
            'name': $('#device-name').val().trim(),
            'account_holder': $('#account-holder').val().trim(),
            'card_number': $('#card-number').val().trim(),
            'account_number': $('#account-number').val().trim(),
            'bank_name': $('#bank-name').val().trim()
        };

        // اعتبارسنجی
        if (!formData.name) {
            showToast('لطفا نام دستگاه را وارد کنید', 'error');
            $('#device-name').focus();
            return;
        }
        if (!formData.account_holder) {
            showToast('لطفا نام صاحب حساب را وارد کنید', 'error');
            $('#account-holder').focus();
            return;
        }
        if (!formData.card_number || formData.card_number.length !== 16 || !/^\d+$/.test(formData.card_number)) {
            showToast('شماره کارت باید 16 رقم باشد', 'error');
            $('#card-number').focus();
            return;
        }
        if (!formData.account_number) {
            showToast('لطفا شماره حساب را وارد کنید', 'error');
            $('#account-number').focus();
            return;
        }
        if (!formData.bank_name) {
            showToast('لطفا نام بانک را وارد کنید', 'error');
            $('#bank-name').focus();
            return;
        }

        $('#addDeviceButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> در حال ثبت...');

        $.ajax({
            url: "{% url 'invoice_app:manage_pos_devices' %}",
            method: 'POST',
            data: { ...formData, action: 'add' },
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    showToast('دستگاه با موفقیت اضافه شد', 'success');
                    setTimeout(() => {
                        $('#posDeviceModal').modal('hide');
                        location.reload();
                    }, 1500);
                } else {
                    showToast(data.message || 'خطا در ثبت دستگاه', 'error');
                }
            },
            error: function() {
                showToast('خطا در ارتباط با سرور', 'error');
            },
            complete: function() {
                $('#addDeviceButton').prop('disabled', false).html('<i class="fas fa-plus-circle"></i> افزودن دستگاه جدید');
            }
        });
    }

    function deletePosDevice(deviceId) {
        const deviceName = $(`[data-device-id="${deviceId}"]`).closest('.card').find('strong').text();

        if (confirm(`آیا از حذف دستگاه "${deviceName}" اطمینان دارید؟`)) {
            $.ajax({
                url: "{% url 'invoice_app:manage_pos_devices' %}",
                method: 'POST',
                data: { action: 'delete', device_id: deviceId },
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('دستگاه با موفقیت حذف شد', 'success');
                        location.reload();
                    } else {
                        showToast('خطا در حذف دستگاه', 'error');
                    }
                },
                error: function() {
                    showToast('خطا در ارتباط با سرور', 'error');
                }
            });
        }
    }

    function setDefaultPosDevice(deviceId) {
        const deviceName = $(`[data-device-id="${deviceId}"]`).closest('.card').find('strong').text();

        if (confirm(`آیا می‌خواهید دستگاه "${deviceName}" را به عنوان پیش‌فرض تنظیم کنید؟`)) {
            $.ajax({
                url: "{% url 'invoice_app:manage_pos_devices' %}",
                method: 'POST',
                data: { action: 'set_default', device_id: deviceId },
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('دستگاه پیش‌فرض با موفقیت تغییر کرد', 'success');
                        location.reload();
                    } else {
                        showToast('خطا در تغییر دستگاه پیش‌فرض', 'error');
                    }
                },
                error: function() {
                    showToast('خطا در ارتباط با سرور', 'error');
                }
            });
        }
    }

    function showAllPOSDevices() {
        if ($('#pos-devices-list .card').length > 0) {
            $('#posDeviceModal').modal('show');
        } else {
            showToast('هیچ دستگاه پوزی ثبت نشده است. لطفا ابتدا یک دستگاه اضافه کنید.', 'warning');
        }
    }

    // =============================================
    // توابع مدیریت وضعیت پرداخت
    // =============================================
    function showPaymentStatusModal() {
        // پنهان کردن همه دکمه‌ها
        $('#success-buttons').hide();
        $('#error-buttons').hide();
        $('#processing-buttons').show();
        
        // تنظیم حالت پیش‌فرض
        $('#payment-status-icon').html('<i class="fas fa-spinner fa-spin payment-info"></i>');
        $('#payment-status-message').text('در حال اتصال به کارت خوان...');
        $('#transaction-details').hide();
        
        // نمایش مودال
        const modal = new bootstrap.Modal(document.getElementById('paymentStatusModal'));
        modal.show();
    }

    function updatePaymentStatus(status, message, transactionData = null) {
        console.log(`🔄 به‌روزرسانی وضعیت پرداخت: ${status} - ${message}`);
        
        let icon = '';
        let iconClass = '';
        
        switch(status) {
            case 'processing':
                icon = '<i class="fas fa-spinner fa-spin payment-info"></i>';
                iconClass = 'payment-info';
                $('#processing-buttons').show();
                $('#success-buttons').hide();
                $('#error-buttons').hide();
                break;
                
            case 'success':
                icon = '<i class="fas fa-check-circle payment-success"></i>';
                iconClass = 'payment-success';
                $('#processing-buttons').hide();
                $('#success-buttons').show();
                $('#error-buttons').hide();
                
                // نمایش جزئیات تراکنش
                if (transactionData) {
                    $('#transaction-amount').text(transactionData.amount_toman.toLocaleString('fa-IR') + ' تومان');
                    $('#transaction-time').text(new Date().toLocaleTimeString('fa-IR'));
                    $('#transaction-details').show();
                }
                break;
                
            case 'error':
                icon = '<i class="fas fa-times-circle payment-error"></i>';
                iconClass = 'payment-error';
                $('#processing-buttons').hide();
                $('#success-buttons').hide();
                $('#error-buttons').show();
                break;
                
            case 'cancelled':
                icon = '<i class="fas fa-ban payment-warning"></i>';
                iconClass = 'payment-warning';
                $('#processing-buttons').hide();
                $('#success-buttons').hide();
                $('#error-buttons').show();
                break;
                
            case 'timeout':
                icon = '<i class="fas fa-clock payment-warning"></i>';
                iconClass = 'payment-warning';
                $('#processing-buttons').hide();
                $('#success-buttons').hide();
                $('#error-buttons').show();
                break;
        }
        
        $('#payment-status-icon').html(icon);
        $('#payment-status-message').text(message);
    }

    function processPosPayment(amount, posDeviceId) {
    console.log('💰 شروع فرآیند پرداخت POS:', { amount, posDeviceId });
    
    currentPaymentAmount = amount;
    showPaymentStatusModal();
    updatePaymentStatus('processing', 'در حال اتصال به کارت خوان...');

    // تنظیم timeout کلی برای کل فرآیند پرداخت
    const paymentTimeout = setTimeout(() => {
        console.log('⏰ timeout کلی پرداخت');
        updatePaymentStatus('timeout', 'زمان پرداخت به پایان رسید. لطفاً مجدداً تلاش کنید.');
    }, 25000); // 25 ثانیه timeout کلی

    // ارسال درخواست پرداخت به سرور
    $.ajax({
        url: "{% url 'invoice_app:process_pos_payment' %}",
        method: 'POST',
        contentType: 'application/json',
        timeout: 20000, // 20 ثانیه timeout برای AJAX
        data: JSON.stringify({
            amount: amount,
            pos_device_id: posDeviceId
        }),
        headers: {'X-CSRFToken': getCookie('csrftoken')},
        success: function(data) {
            clearTimeout(paymentTimeout); // پاک کردن timeout
            console.log('✅ پاسخ پرداخت POS:', data);
            
            if (data.status === 'success') {
                const transactionStatus = data.transaction_status;
                
                if (transactionStatus.status_type === 'success') {
                    // پرداخت موفق
                    updatePaymentStatus('success', transactionStatus.message, {
                        amount_toman: data.amount_toman,
                        amount_rial: data.amount_rial
                    });
                    
                    // ثبت فاکتور
                    registerFinalInvoice(amount, 'pos');
                } else {
                    // خطا در پرداخت
                    updatePaymentStatus(transactionStatus.status_type, transactionStatus.message);
                }
            } else {
                // خطا در ارتباط
                updatePaymentStatus('error', data.message);
            }
        },
        error: function(xhr, status, error) {
            clearTimeout(paymentTimeout); // پاک کردن timeout
            console.error('❌ خطا در ارسال درخواست پرداخت:', error);
            
            if (status === 'timeout') {
                updatePaymentStatus('timeout', 'زمان اتصال به سرور به پایان رسید. لطفاً مجدداً تلاش کنید.');
            } else {
                updatePaymentStatus('error', 'خطا در ارتباط با سرور: ' + error);
            }
        }
    });
}
    
    function registerFinalInvoice(amount, paymentMethod) {
        console.log('📝 در حال ثبت نهایی فاکتور...');

        $.ajax({
            url: "{% url 'invoice_app:finalize_invoice' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action: 'save_only',
                payment_method: paymentMethod,
                paid_amount: amount,
                timestamp: new Date().getTime()
            }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    console.log('✅ فاکتور ثبت شد:', data.invoice_id);
                    currentInvoiceId = data.invoice_id;
                    
                    // به‌روزرسانی پیام موفقیت
                    updatePaymentStatus('success', 
                        'پرداخت با موفقیت انجام شد. فاکتور ثبت گردید.',
                        { amount_toman: amount }
                    );
                } else {
                    console.error('❌ خطا در ثبت فاکتور:', data.message);
                    updatePaymentStatus('error', 'خطا در ثبت فاکتور: ' + data.message);
                }
            },
            error: function(xhr) {
                console.error('❌ خطا در ارتباط با سرور:', xhr);
                updatePaymentStatus('error', 'خطا در ثبت فاکتور');
            }
        });
    }

    // =============================================
    // توابع مدیریت دکمه‌ها
    // =============================================
    function createNewInvoice() {
        console.log('🆕 ایجاد فاکتور جدید');
        
        // بستن مودال
        bootstrap.Modal.getInstance(document.getElementById('paymentStatusModal')).hide();
        
        // ریدایرکت به صفحه ایجاد فاکتور جدید
        setTimeout(() => {
            window.location.href = "{% url 'invoice_app:create_invoice' %}";
        }, 500);
    }

    function printCurrentInvoice() {
        if (currentInvoiceId) {
            console.log('🖨️ پرینت فاکتور:', currentInvoiceId);
            const printUrl = "{% url 'invoice_app:invoice_print' 0 %}".replace('0', currentInvoiceId);
            window.open(printUrl, '_blank');
        } else {
            alert('فاکتور یافت نشد. لطفاً از لیست فاکتورها اقدام به چاپ کنید.');
        }
    }

    function retryPayment() {
        console.log('🔄 تلاش مجدد پرداخت');
        
        // بستن مودال فعلی
        bootstrap.Modal.getInstance(document.getElementById('paymentStatusModal')).hide();
        
        // تلاش مجدد پرداخت
        setTimeout(() => {
            const amount = calculateInvoiceTotal().totalAmount;
            const posDeviceId = $('#pos-device').val();
            processPosPayment(amount, posDeviceId);
        }, 300);
    }

    function cancelPayment() {
        console.log('❌ پرداخت توسط کاربر لغو شد');
        updatePaymentStatus('cancelled', 'پرداخت توسط کاربر لغو شد');
        
        // بستن خودکار مودال پس از 2 ثانیه
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('paymentStatusModal')).hide();
        }, 2000);
    }

    // =============================================
    // توابع اصلی - لغو و نهایی کردن فاکتور
    // =============================================
    function validateInvoiceBeforeSubmit() {
        const items = $('#invoice-items-list tr');
        const hasRealItems = items.length > 0 &&
                            !(items.length === 1 && items.find('td').hasClass('text-muted'));

        if (!hasRealItems) {
            showToast('فاکتور باید حداقل یک آیتم داشته باشد', 'error');
            return false;
        }

        if (!currentPaymentMethod) {
            currentPaymentMethod = 'pos';
            savePaymentMethod('pos');
        }

        if (currentPaymentMethod === 'pos' && !$('#pos-device').val()) {
            showToast('لطفا یک دستگاه پوز انتخاب کنید', 'error');
            return false;
        }

        return true;
    }

    function cancelInvoice() {
        if (confirm('آیا از انصراف اطمینان دارید؟ تمام تغییرات از بین خواهد رفت.')) {
            showToast('در حال لغو فاکتور...', 'info');

            // استفاده از redirect مستقیم به جای AJAX
            window.location.href = "{% url 'invoice_app:invoice_cancel' %}";
        }
    }

    function finalizeInvoice(action) {
        console.log('🔄 شروع فرآیند ثبت فاکتور...');

        // اعتبارسنجی اولیه
        if (!validateInvoiceBeforeSubmit()) {
            return;
        }

        const paymentMethod = currentPaymentMethod;
        const amount = calculateInvoiceTotal().totalAmount;

        console.log('💳 روش پرداخت:', paymentMethod, 'مبلغ:', amount);

        // برای پرداخت POS از فرآیند جدید استفاده کن
        if (paymentMethod === 'pos') {
            const posDeviceId = $('#pos-device').val();
            if (!posDeviceId) {
                showToast('لطفا یک دستگاه پوز انتخاب کنید', 'error');
                return;
            }

            processPosPayment(amount, posDeviceId);
        }
        // برای سایر روش‌های پرداخت از تابع قدیمی استفاده کن
        else if (paymentMethod === 'check') {
            // نمایش مودال چک
            $('#checkPaymentModal').modal('show');
        }
        else if (paymentMethod === 'credit') {
            // نمایش مودال نسیه
            $('#creditPaymentModal').modal('show');
        }
        else {
            // برای نقدی و سایر روش‌ها
            submitFinalInvoice(action, paymentMethod, amount);
        }
    }

    // تابع ارسال نهایی فاکتور برای روش‌های غیر POS
    function submitFinalInvoice(action, paymentMethod, amount) {
        $.ajax({
            url: "{% url 'invoice_app:finalize_invoice' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action: action,
                payment_method: paymentMethod,
                paid_amount: amount,
                timestamp: new Date().getTime()
            }),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            success: function(data) {
                if (data.status === 'success') {
                    showToast('فاکتور با موفقیت ثبت شد', 'success');
                    currentInvoiceId = data.invoice_id;

                    if (action === 'print_and_save') {
                        const printUrl = "{% url 'invoice_app:invoice_print' 0 %}".replace('0', data.invoice_id);
                        window.open(printUrl, '_blank');

                        setTimeout(() => {
                            const successUrl = "{% url 'invoice_app:invoice_success' 0 %}".replace('0', data.invoice_id);
                            window.location.href = successUrl;
                        }, 2000);
                    } else {
                        const successUrl = "{% url 'invoice_app:invoice_success' 0 %}".replace('0', data.invoice_id);
                        window.location.href = successUrl;
                    }
                } else {
                    showToast('خطا در ثبت فاکتور: ' + data.message, 'error');
                }
            },
            error: function(xhr) {
                let errorMessage = 'خطا در ارتباط با سرور';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += ': ' + xhr.responseJSON.message;
                }
                showToast(errorMessage, 'error');
            }
        });
    }

    // =============================================
    // توابع پرداخت چک و نسیه
    // =============================================
    function updateRemainingAmount() {
        const invoiceTotal = calculateInvoiceTotal().totalAmount;
        const checkAmount = parseInt($('#check-amount').val()) || 0;
        const remainingAmount = Math.max(0, invoiceTotal - checkAmount);

        $('#remaining-amount').val(remainingAmount);

        // نمایش/پنهان کردن بخش دستگاه پوز
        const remainingMethod = $('#remaining-payment-method').val();
        $('#remaining-pos-section').toggle(remainingMethod === 'pos');
    }

    function updateCreditRemainingAmount() {
        const invoiceTotal = calculateInvoiceTotal().totalAmount;
        const creditAmount = parseInt($('#credit-amount').val()) || 0;
        const remainingAmount = Math.max(0, invoiceTotal - creditAmount);

        $('#credit-remaining-amount').val(remainingAmount);

        // نمایش/پنهان کردن بخش دستگاه پوز
        const remainingMethod = $('#credit-remaining-payment-method').val();
        $('#credit-remaining-pos-section').toggle(remainingMethod === 'pos');
    }

    function updateCheckModalInvoiceTotal() {
        const invoiceTotal = calculateInvoiceTotal().totalAmount;
        $('#check-invoice-total').text(invoiceTotal.toLocaleString('fa-IR'));
        updateRemainingAmount();
    }

    function updateCreditModalInvoiceTotal() {
        const invoiceTotal = calculateInvoiceTotal().totalAmount;
        $('#credit-invoice-total').text(invoiceTotal.toLocaleString('fa-IR'));
        updateCreditRemainingAmount();
    }

    function saveCheckPayment() {
        const formData = {
            'owner_name': $('input[name="owner_name"]').val(),
            'owner_family': $('input[name="owner_family"]').val(),
            'national_id': $('input[name="national_id"]').val(),
            'phone': $('input[name="phone"]').val(),
            'address': $('textarea[name="address"]').val(),
            'check_number': $('input[name="check_number"]').val(),
            'amount': parseInt($('input[name="amount"]').val()) || 0,
            'remaining_amount': parseInt($('input[name="remaining_amount"]').val()) || 0,
            'remaining_payment_method': $('select[name="remaining_payment_method"]').val(),
            'remaining_pos_device_id': $('select[name="remaining_pos_device_id"]').val(),
            'check_date': $('input[name="check_date"]').val()
        };

        // اعتبارسنجی
        const requiredFields = ['owner_name', 'owner_family', 'national_id', 'phone', 'check_number', 'amount', 'check_date'];
        for (const field of requiredFields) {
            if (!formData[field]) {
                showToast(`لطفا فیلد ${field} را پر کنید`, 'error');
                return;
            }
        }

        // بررسی منطقی بودن مبلغ چک
        const invoiceTotal = calculateInvoiceTotal().totalAmount;
        if (formData.amount > invoiceTotal) {
            showToast('مبلغ چک نمی‌تواند از مبلغ کل فاکتور بیشتر باشد', 'error');
            return;
        }

        // نمایش پیام تأیید
        if (confirm(`آیا از ذخیره اطلاعات چک اطمینان دارید؟\n\nبا تأیید این عمل، فاکتور ثبت نهایی خواهد شد.`)) {
            $.ajax({
                url: "{% url 'invoice_app:save_check_payment' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('اطلاعات چک با موفقیت ذخیره شد', 'success');
                        $('#checkPaymentModal').modal('hide');

                        // ثبت نهایی فاکتور
                        setTimeout(() => {
                            submitFinalInvoice('save_only', 'check', formData.amount);
                        }, 1000);
                    } else {
                        showToast('خطا در ذخیره اطلاعات چک: ' + data.message, 'error');
                    }
                },
                error: function() {
                    showToast('خطا در ارتباط با سرور', 'error');
                }
            });
        }
    }

    function saveCreditPayment() {
        const creditAmount = parseInt($('#credit-amount').val()) || 0;

        const formData = {
            'customer_name': document.querySelector('#creditPaymentModal input[name="customer_name"]').value,
            'customer_family': document.querySelector('#creditPaymentModal input[name="customer_family"]').value,
            'phone': document.querySelector('#creditPaymentModal input[name="phone"]').value,
            'national_id': document.querySelector('#creditPaymentModal input[name="national_id"]').value,
            'address': document.querySelector('#creditPaymentModal textarea[name="address"]').value,
            'due_date': document.querySelector('#creditPaymentModal input[name="due_date"]').value,
            'credit_amount': creditAmount,
            'remaining_amount': parseInt($('#credit-remaining-amount').val()) || 0,
            'remaining_payment_method': $('#credit-remaining-payment-method').val(),
            'remaining_pos_device_id': $('#credit-remaining-pos-device').val()
        };

        console.log("📋 داده‌های فرم نسیه:", formData);

        // بررسی فیلدهای ضروری
        if (!formData.customer_name || !formData.customer_family || !formData.phone ||
            !formData.national_id || !formData.due_date) {
            alert('لطفا تمام فیلدهای ضروری را پر کنید');
            return;
        }

        // ارسال درخواست AJAX
        fetch("{% url 'invoice_app:save_credit_payment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log("✅ پاسخ سرور:", data);
            if (data.status === 'success') {
                alert('اطلاعات نسیه با موفقیت ذخیره شد');
                // بستن مودال
                var modal = bootstrap.Modal.getInstance(document.getElementById('creditPaymentModal'));
                modal.hide();

                // ثبت نهایی فاکتور
                setTimeout(() => {
                    console.log("🟢 در حال ثبت نهایی فاکتور...");
                    submitFinalInvoice('save_only', 'credit', creditAmount);
                }, 1000);
            } else {
                alert('خطا در ذخیره اطلاعات نسیه: ' + data.message);
            }
        })
        .catch(error => {
            console.error('❌ خطا:', error);
            alert('خطا در ارتباط با سرور');
        });
    }

    // =============================================
    // تنظیم event listeners
    // =============================================
    function setupEventListeners() {
        // جستجوی محصول
        $('#product-search').on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val().trim();

            if (query.length < 2) {
                $('#search-results').hide().empty();
                return;
            }

            searchTimeout = setTimeout(() => searchProduct(query), 300);
        });

        // کلیک روی نتایج جستجو
        $(document).on('click', '.search-result-item', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const productId = $(this).data('product-id');
            addToInvoice(productId);
            $('#product-search').val('');
            $('#search-results').hide();
        });

        // تغییر تعداد محصول
        $(document).on('change', '.quantity-input', function() {
            const productId = $(this).data('product-id');
            const newQuantity = parseInt($(this).val());

            if (newQuantity < 1) {
                $(this).val(1);
                showToast('تعداد نمی‌تواند کمتر از ۱ باشد', 'warning');
                return;
            }

            updateItemRowTotal(productId);
            updateItemQuantity(productId, newQuantity);
        });

        // تغییر real-time در تعداد محصول
        $(document).on('input', '.quantity-input', function() {
            const productId = $(this).data('product-id');
            const newQuantity = parseInt($(this).val()) || 0;

            if (newQuantity >= 1) {
                updateItemRowTotal(productId);
            }
        });

        // تغییر تخفیف آیتم
        $(document).on('change', '.discount-input', function() {
            const productId = $(this).data('product-id');
            const discount = parseInt($(this).val()) || 0;

            if (discount < 0) {
                $(this).val(0);
                showToast('تخفیف نمی‌تواند منفی باشد', 'warning');
                return;
            }

            updateItemRowTotal(productId);
            updateItemDiscount(productId, discount);
        });

        // تغییر real-time در تخفیف آیتم
        $(document).on('input', '.discount-input', function() {
            const productId = $(this).data('product-id');
            const discount = parseInt($(this).val()) || 0;

            if (discount >= 0) {
                updateItemRowTotal(productId);
            }
        });

        // تغییرات real-time در تخفیف کل
        $('#total-discount').on('input', function() {
            const discount = parseInt($(this).val()) || 0;
            if (discount >= 0) {
                calculateInvoiceTotal();
                saveDiscount();
            }
        });

        // ذخیره اطلاعات خریدار
        $('#customer-name, #customer-phone').on('blur', saveCustomerInfo);

        // انتخاب روش پرداخت
        $('.payment-method-btn').click(function() {
            const method = $(this).data('method');
            currentPaymentMethod = method;

            $('.payment-method-btn').removeClass('active');
            $(this).addClass('active');

            $('#pos-devices-section').toggle(method === 'pos');

            if (method === 'check') {
                $('#checkPaymentModal').modal('show');
            } else if (method === 'credit') {
                $('#creditPaymentModal').modal('show');
            }

            savePaymentMethod(method);

            if (method === 'pos') {
                setTimeout(saveSelectedPosDevice, 100);
            }
        });

        // تغییر دستگاه POS
        $('#pos-device').on('change', saveSelectedPosDevice);

        // جلوگیری از ارسال فرم با Enter
        $('input').on('keydown', function(e) {
            if (e.keyCode === 13) {
                e.preventDefault();
                return false;
            }
        });

        // مدیریت دستگاه‌های POS
        $(document).on('click', '.delete-device-btn', function() {
            const deviceId = $(this).data('device-id');
            deletePosDevice(deviceId);
        });

        $(document).on('click', '.set-default-btn', function() {
            const deviceId = $(this).data('device-id');
            setDefaultPosDevice(deviceId);
        });

        $('#addDeviceButton').on('click', addPosDevice);

        // رویدادهای مودال چک
        $('#check-amount').on('input', updateRemainingAmount);
        $('#remaining-payment-method').on('change', updateRemainingAmount);

        // رویدادهای مودال نسیه
        $('#credit-amount').on('input', updateCreditRemainingAmount);
        $('#credit-remaining-payment-method').on('change', updateCreditRemainingAmount);

        // هنگام باز کردن مودال چک
        $('#checkPaymentModal').on('show.bs.modal', function() {
            updateCheckModalInvoiceTotal();
        });

        // هنگام باز کردن مودال نسیه
        $('#creditPaymentModal').on('show.bs.modal', function() {
            updateCreditModalInvoiceTotal();
        });
    }

    // =============================================
    // Event Listeners ساده و مستقیم
    // =============================================
    function setupButtonListeners() {
        console.log("🟢 تنظیم event listeners برای دکمه‌ها");

        // دکمه ثبت فاکتور
        $('#save-invoice-btn').off('click').on('click', function(e) {
            e.preventDefault();
            console.log("🟢 دکمه 'ثبت فاکتور' کلیک شد");
            finalizeInvoice('save_only');
        });

        // دکمه انصراف
        $('#cancel-invoice-btn').off('click').on('click', function(e) {
            e.preventDefault();
            console.log("🟢 دکمه 'انصراف' کلیک شد");
            cancelInvoice();
        });
    }

    // =============================================
    // مقداردهی اولیه صفحه
    // =============================================
    $(document).ready(function() {
        console.log("🚀 صفحه کاملاً بارگذاری شد");

        // تنظیم event listeners برای دکمه‌ها
        setupButtonListeners();

        // تنظیم روش پرداخت پیش‌فرض
        if (!currentPaymentMethod || currentPaymentMethod === 'None') {
            currentPaymentMethod = 'pos';
            $('[data-method="pos"]').addClass('active');
            $('#pos-devices-section').show();
            savePaymentMethod('pos');
        }

        // بقیه تنظیمات...
        initializeDatePickers();
        setupBarcodeScanner();
        setupEventListeners();

        setTimeout(function() {
            $('#product-search').focus();
        }, 500);

        calculateInvoiceTotal();

        // تست: چک کردن وجود دکمه‌ها
        console.log("دکمه ثبت فاکتور وجود دارد:", $('#save-invoice-btn').length > 0);
        console.log("دکمه انصراف وجود دارد:", $('#cancel-invoice-btn').length > 0);
    });

{#    function processPosPayment(amount, posDeviceId) {#}
{#    console.log('💰 شروع فرآیند پرداخت POS:', { amount, posDeviceId });#}
{#    #}
{#    currentPaymentAmount = amount;#}
{#    showPaymentStatusModal();#}
{#    updatePaymentStatus('processing', 'در حال اتصال به کارت خوان...');#}
{##}
{#    // تنظیم timeout کلی برای کل فرآیند پرداخت#}
{#    const paymentTimeout = setTimeout(() => {#}
{#        console.log('⏰ timeout کلی پرداخت');#}
{#        updatePaymentStatus('timeout', 'زمان پرداخت به پایان رسید. لطفاً مجدداً تلاش کنید.');#}
{#    }, 25000); // 25 ثانیه timeout کلی#}
{##}
{#    // ارسال درخواست پرداخت به سرور#}
{#    $.ajax({#}
{#        url: "{% url 'invoice_app:process_pos_payment' %}",#}
{#        method: 'POST',#}
{#        contentType: 'application/json',#}
{#        timeout: 20000, // 20 ثانیه timeout برای AJAX#}
{#        data: JSON.stringify({#}
{#            amount: amount,#}
{#            pos_device_id: posDeviceId#}
{#        }),#}
{#        headers: {'X-CSRFToken': getCookie('csrftoken')},#}
{#        success: function(data) {#}
{#            clearTimeout(paymentTimeout); // پاک کردن timeout#}
{#            console.log('✅ پاسخ پرداخت POS:', data);#}
{#            #}
{#            if (data.status === 'success') {#}
{#                const transactionStatus = data.transaction_status;#}
{#                #}
{#                if (transactionStatus.status_type === 'success') {#}
{#                    // پرداخت موفق#}
{#                    updatePaymentStatus('success', transactionStatus.message, {#}
{#                        amount_toman: data.amount_toman,#}
{#                        amount_rial: data.amount_rial#}
{#                    });#}
{#                    #}
{#                    // ثبت فاکتور#}
{#                    registerFinalInvoice(amount, 'pos');#}
{#                } else {#}
{#                    // خطا در پرداخت#}
{#                    updatePaymentStatus(transactionStatus.status_type, transactionStatus.message);#}
{#                }#}
{#            } else {#}
{#                // خطا در ارتباط#}
{#                updatePaymentStatus('error', data.message);#}
{#            }#}
{#        },#}
{#        error: function(xhr, status, error) {#}
{#            clearTimeout(paymentTimeout); // پاک کردن timeout#}
{#            console.error('❌ خطا در ارسال درخواست پرداخت:', error);#}
{#            #}
{#            if (status === 'timeout') {#}
{#                updatePaymentStatus('timeout', 'زمان اتصال به سرور به پایان رسید. لطفاً مجدداً تلاش کنید.');#}
{#            } else {#}
{#                updatePaymentStatus('error', 'خطا در ارتباط با سرور: ' + error);#}
{#            }#}
{#        }#}
{#    });#}
{#}#}
    // =============================================
    // قرار دادن توابع در scope جهانی
    // =============================================
    window.finalizeInvoice = finalizeInvoice;
    window.cancelInvoice = cancelInvoice;
    window.removeItem = removeItem;
    window.openDatePicker = openDatePicker;
    window.openCheckDatePicker = openCheckDatePicker;
    window.openDueDatePicker = openDueDatePicker;
    window.saveCheckPayment = saveCheckPayment;
    window.saveCreditPayment = saveCreditPayment;
    window.showAllPOSDevices = showAllPOSDevices;
    window.addPosDevice = addPosDevice;
    window.processPosPayment = processPosPayment;
    window.createNewInvoice = createNewInvoice;
    window.printCurrentInvoice = printCurrentInvoice;
    window.retryPayment = retryPayment;
    window.cancelPayment = cancelPayment;
    </script>
</body>
</html>
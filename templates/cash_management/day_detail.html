
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جزئیات روز {{ jalali_date }}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container-main {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.2);
        }

        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.2s;
            background: white;
        }

        .card-custom:hover {
            transform: translateY(-2px);
        }

        .card-header-custom {
            background-color: var(--light-bg);
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
            padding: 18px 25px;
            border-radius: 12px 12px 0 0 !important;
        }

        .status-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .status-verified {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .amount-input {
            text-align: left;
            direction: ltr;
            font-family: monospace;
            font-weight: bold;
            border: 2px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .amount-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
            transform: scale(1.02);
        }

        .amount-input:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary-custom:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-primary-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .verify-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }

        .verify-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .verify-checkbox:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .total-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            height: 100%;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .total-box:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .total-amount {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 15px 0;
            color: var(--dark);
        }

        .back-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background-color: #5a6268;
            color: white;
            transform: translateX(-5px);
        }

        .action-buttons {
            position: fixed;
            bottom: 30px;
            left: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            justify-content: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .action-btn {
            padding: 15px 35px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-3px);
        }

        .btn-verify {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        .btn-verify:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }

        .table-custom {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .table-custom th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 18px 15px;
            font-weight: 600;
            text-align: center;
        }

        .table-custom td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .table-custom tbody tr {
            transition: all 0.2s;
        }

        .table-custom tbody tr:hover {
            background-color: rgba(76, 175, 80, 0.05);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container-main {
                padding: 0 10px;
            }

            .header {
                padding: 20px;
            }

            .action-buttons {
                flex-direction: column;
                left: 10px;
                right: 10px;
                bottom: 10px;
                padding: 15px;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .table-custom {
                font-size: 0.9rem;
            }

            .table-custom th,
            .table-custom td {
                padding: 10px 8px;
            }

            .amount-input {
                font-size: 0.9rem;
                padding: 8px 10px;
            }

            .total-amount {
                font-size: 1.8rem;
            }
        }

        .date-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }

        .date-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 25px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            color: #6b7280;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .form-select:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .form-select {
            border: 2px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
        }

        .account-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .verified-list {
            border-top: 3px solid var(--primary-color);
        }

        .account-badge {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .pos-device-row {
            background-color: #f8f9fa;
        }

        .pos-device-row td {
            padding-left: 40px !important;
            font-size: 0.9rem;
        }

        .branch-section {
            border-left: 4px solid var(--primary-color);
        }

        /* استایل‌های جدید */
        .calculated-row {
            background-color: #f8f9fa;
        }

        .user-input-row {
            background-color: #fff3cd;
        }

        .user-input-row td {
            border-top: 2px dashed #ffc107;
        }

        .separator-row {
            height: 10px;
            background-color: #f0f0f0;
        }

        .device-detail-row {
            background-color: #f1f3f4;
            font-size: 0.9rem;
        }

        .device-detail-row td {
            padding-left: 50px;
        }

        .total-row {
            background-color: #e9ecef;
            font-weight: bold;
            border-top: 2px solid #dee2e6;
        }

        .verification-status {
            font-size: 0.85rem;
        }

        .verification-badge {
            background-color: #d4edda;
            color: #155724;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        /* ... استایل‌های قبلی باقی می‌مانند ... */

        /* استایل‌های جدید برای دستگاه‌های پوز */
        .pos-device-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .pos-device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .pos-device-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .pos-device-bank {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .pos-device-details {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .pos-device-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2e7d32;
            text-align: left;
            direction: ltr;
        }

        .account-badge {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .bank-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        .bank-info small {
            display: block;
            color: #6c757d;
        }

        .device-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        /* استایل برای جدول‌ها */
        .table-sm th, .table-sm td {
            padding: 8px;
            font-size: 0.85rem;
        }

        .table-separator {
            border-top: 2px solid #dee2e6 !important;
        }

        .device-row {
            background-color: #f8f9fa !important;
        }

        .device-row td {
            padding-left: 40px !important;
        }

        .no-device-row {
            background-color: #fff3cd !important;
            color: #856404;
        }

        .account-cell {
            max-width: 200px;
            word-wrap: break-word;
        }

        /* استایل‌های responsive */
        @media (max-width: 768px) {
            .pos-device-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .pos-device-bank {
                margin-top: 5px;
            }

            .bank-info {
                font-size: 0.8rem;
            }
        }
        
        <style>
    /* ... استایل‌های قبلی ... */
    
    /* استایل برای لودر */
    .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }
    
    /* استایل برای دکمه‌های غیرفعال */
    .verify-checkbox:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .user-amount-input:disabled {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }
    
    
</style>

    </style>
</head>
<body>
    <div class="container-main">
        <!-- هدر - بدون تغییر -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <a href="{% url 'cash_management:calendar' %}" class="back-btn">
                        <i class="bi bi-arrow-right"></i>
                        بازگشت به تقویم
                    </a>
                </div>
                <div class="user-info">
                    <i class="bi bi-person-circle"></i>
                    <span>{{ user.get_full_name|default:user.username }}</span>
                </div>
            </div>

            <div class="date-header">
                <div class="date-badge">
                    <i class="bi bi-calendar-date"></i>
                    تاریخ شمسی: {{ jalali_date }}
                </div>
                <div class="date-badge">
                    <i class="bi bi-calendar"></i>
                    تاریخ میلادی: {{ gregorian_date }}
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-cash-stack me-2"></i>
                    جزئیات گردش مالی روزانه
                </h1>
                <div>
                    {% if daily_status.is_verified %}
                    <span class="status-badge status-verified">
                        <i class="bi bi-check-circle me-2"></i> تایید شده
                        {% if daily_status.verified_by %}
                        <span class="ms-2">توسط: {{ daily_status.verified_by.get_full_name|default:daily_status.verified_by.username }}</span>
                        {% endif %}
                    </span>
                    {% else %}
                    <span class="status-badge status-pending">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        {% if has_unverified_non_zero %}
                            نیاز به بررسی
                        {% else %}
                            آماده تایید
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- اطلاعات روز -->
        <input type="hidden" id="currentDate" value="{{ date_str }}">
        <input type="hidden" id="isVerified" value="{{ daily_status.is_verified|yesno:'true,false' }}">
        {% csrf_token %}

        <!-- کارت‌های مجموع - بدون تغییر -->
        <div class="row mb-5">
            <!-- ... کارت‌های مجموع ... -->
        </div>

        <!-- بخش اصلی -->
        <div class="row">
            <!-- بخش شعب با دستگاه‌های پوز -->
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-shop me-2"></i> گردش شعب
                        </span>
                        <span class="badge bg-primary">{{ branch_data|length }} شعبه</span>
                    </div>
                    <div class="card-body">
                        {% if branch_data %}
                            {% for item in branch_data %}
                            <div class="branch-section mb-4 p-3 border rounded">
                                <!-- هدر شعبه -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="bi bi-building me-2"></i>
                                        <strong>{{ item.branch.name }}</strong>
                                    </h5>
                                    {% if item.branch_cash.is_verified %}
                                    <span class="badge bg-success">تایید شده</span>
                                    {% endif %}
                                </div>

                                <!-- جدول اطلاعات فاکتورها -->
                                <div class="table-responsive mb-3">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th colspan="4" class="text-center">
                                                    گزارش فاکتورهای {{ item.branch.name }}
                                                    <small class="text-muted">
                                                        ({{ item.total_invoices }} فاکتور)
                                                    </small>
                                                </th>
                                            </tr>
                                            <tr>
                                                <th>نوع</th>
                                                <th>دستگاه/حساب</th>
                                                <th>تعداد</th>
                                                <th class="text-end">مبلغ (تومان)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- ردیف نقدی -->
                                            <tr class="calculated-row">
                                                <td>
                                                    <i class="bi bi-cash-coin text-success me-2"></i>
                                                    <strong>نقدی</strong>
                                                </td>
                                                <td>-</td>
                                                <td>{{ item.cash_invoice_count }}</td>
                                                <td class="text-end fw-bold">
                                                    {{ item.cash_total|floatformat:0 }}
                                                </td>
                                            </tr>

                                            <!-- ردیف پوز با تفکیک دستگاه -->
                                            {% if item.pos_devices_details %}
                                                {% for pos in item.pos_devices_details %}
                                                <tr class="device-row">
                                                    <td>
                                                        {% if forloop.first %}
                                                        <i class="bi bi-credit-card text-primary me-2"></i>
                                                        <strong>پوز</strong>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="d-flex flex-column">
                                                            <strong>{{ pos.device_name }}</strong>
                                                            <small class="text-muted">{{ pos.bank_name }}</small>
                                                            {% if pos.account_holder %}
                                                            <small class="text-muted">صاحب حساب: {{ pos.account_holder }}</small>
                                                            {% endif %}
                                                            {% if pos.account_number %}
                                                            <small class="text-muted">شماره حساب: {{ pos.account_number }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                    <td>{{ pos.count }}</td>
                                                    <td class="text-end">
                                                        {{ pos.amount|floatformat:0 }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="calculated-row">
                                                    <td>
                                                        <i class="bi bi-credit-card text-primary me-2"></i>
                                                        <strong>پوز</strong>
                                                    </td>
                                                    <td>بدون دستگاه</td>
                                                    <td>{{ item.pos_invoice_count }}</td>
                                                    <td class="text-end fw-bold">
                                                        {{ item.pos_total|floatformat:0 }}
                                                    </td>
                                                </tr>
                                            {% endif %}

                                            <!-- ردیف جمع کل -->
                                            <tr class="table-success table-separator">
                                                <td colspan="2"><strong>جمع کل این شعبه</strong></td>
                                                <td>{{ item.cash_invoice_count|add:item.pos_invoice_count }}</td>
                                                <td class="text-end fw-bold">
                                                    {{ item.cash_total|add:item.pos_total|floatformat:0 }}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- فیلدهای ورودی مبالغ -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-cash-coin text-success"></i>
                                            </span>
                                            <input type="text"
                                                   class="form-control amount-input user-amount-input"
                                                   data-item-type="branch_cash"
                                                   data-branch-id="{{ item.branch.id }}"
                                                   data-payment-type="cash"
                                                   data-calculated="{{ item.cash_total }}"
                                                   placeholder="مبلغ نقدی واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                            <span class="input-group-text">تومان</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input type="checkbox"
                                                       class="form-check-input verify-checkbox"
                                                       data-item-type="branch_cash"
                                                       data-branch-id="{{ item.branch.id }}"
                                                       data-payment-type="cash"
                                                       {% if daily_status.is_verified %}disabled{% endif %}
                                                       id="verify-cash-{{ item.branch.id }}">
                                                <label class="form-check-label small" for="verify-cash-{{ item.branch.id }}">
                                                    تایید نقدی
                                                </label>
                                            </div>
                                            <span class="verification-status small" id="status-cash-{{ item.branch.id }}"></span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-credit-card text-primary"></i>
                                            </span>
                                            <input type="text"
                                                   class="form-control amount-input user-amount-input"
                                                   data-item-type="branch_pos"
                                                   data-branch-id="{{ item.branch.id }}"
                                                   data-payment-type="pos"
                                                   data-calculated="{{ item.pos_total }}"
                                                   placeholder="مبلغ پوز واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                            <span class="input-group-text">تومان</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input type="checkbox"
                                                       class="form-check-input verify-checkbox"
                                                       data-item-type="branch_pos"
                                                       data-branch-id="{{ item.branch.id }}"
                                                       data-payment-type="pos"
                                                       {% if daily_status.is_verified %}disabled{% endif %}
                                                       id="verify-pos-{{ item.branch.id }}">
                                                <label class="form-check-label small" for="verify-pos-{{ item.branch.id }}">
                                                    تایید پوز
                                                </label>
                                            </div>
                                            <span class="verification-status small" id="status-pos-{{ item.branch.id }}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="bi bi-shop"></i>
                                <h5>هیچ شعبه‌ای یافت نشد</h5>
                                <p class="text-muted">لطفاً ابتدا شعبه‌ها را در سیستم تعریف کنید.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- بخش سرمایه‌گذاری‌ها با حساب بانکی -->
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-graph-up me-2"></i> سرمایه‌گذاری‌ها
                        </span>
                        <span class="badge bg-primary">{{ investments|length }} مورد</span>
                    </div>
                    <div class="card-body">
                        {% if investments %}
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>سرمایه‌گذار</th>
                                        <th>روش پرداخت</th>
                                        <th>حساب بانکی</th>
                                        <th>مبلغ محاسبه شده</th>
                                        <th class="text-center">ورود مبلغ</th>
                                        <th class="text-center">تایید</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for investment in investments %}
                                    <tr class="calculated-row">
                                        <td>
                                            <div class="fw-bold">{{ investment.investor.firstname }} {{ investment.investor.lastname }}</div>
                                            <small class="text-muted">{{ investment.investor.melicode }}</small>
                                        </td>
                                        <td>
                                            {% if investment.payment_method == 'cash' %}
                                                <span class="badge bg-success">نقدی</span>
                                            {% elif investment.payment_method == 'bank_transfer' %}
                                                <span class="badge bg-primary">واریز به حساب</span>
                                            {% endif %}
                                        </td>
                                        <td class="account-cell">
                                            {% if investment.payment_account %}
                                                <div class="bank-info">
                                                    <strong>{{ investment.payment_account.name }}</strong>
                                                    <small>{{ investment.payment_account.bank_name }}</small>
                                                    {% if investment.payment_account.account_holder %}
                                                    <small>صاحب حساب: {{ investment.payment_account.account_holder }}</small>
                                                    {% endif %}
                                                    {% if investment.payment_account.account_number %}
                                                    <small>شماره حساب: {{ investment.payment_account.account_number }}</small>
                                                    {% endif %}
                                                    {% if investment.payment_account.card_number %}
                                                    <small>شماره کارت: {{ investment.payment_account.card_number }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-end">{{ investment.amount|floatformat:0 }}</td>
                                        <td>
                                            <input type="text"
                                                   class="form-control amount-input user-amount-input"
                                                   data-item-type="investment"
                                                   data-item-id="{{ investment.id }}"
                                                   data-calculated="{{ investment.amount }}"
                                                   placeholder="مبلغ واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   class="form-check-input verify-checkbox"
                                                   data-item-type="investment"
                                                   data-item-id="{{ investment.id }}"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-graph-up"></i>
                            <h5>هیچ سرمایه‌گذاری ثبت نشده</h5>
                            <p class="text-muted">برای این روز هیچ سرمایه‌گذاری ثبت نشده است.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- بخش چک‌ها و نسیه‌ها -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-bank me-2"></i> چک‌های سررسید شده
                        </span>
                        <span class="badge bg-primary">{{ cheques|length }} چک</span>
                    </div>
                    <div class="card-body">
                        {% if cheques %}
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>شماره چک</th>
                                        <th>صادرکننده</th>
                                        <th>بانک</th>
                                        <th>حساب بانکی</th>
                                        <th>مبلغ محاسبه شده</th>
                                        <th class="text-center">ورود مبلغ</th>
                                        <th class="text-center">تایید</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cheque in cheques %}
                                    <tr class="calculated-row">
                                        <td>
                                            <div class="fw-bold">{{ cheque.check_number }}</div>
                                            <small class="text-muted">{{ cheque.invoice.branch.name }}</small>
                                        </td>
                                        <td>{{ cheque.owner_name }} {{ cheque.owner_family }}</td>
                                        <td>{{ cheque.bank_name|default:"نامشخص" }}</td>
                                        <td class="account-cell">
                                            {% if cheque.invoice.pos_device %}
                                                <div class="bank-info">
                                                    <strong>{{ cheque.invoice.pos_device.name }}</strong>
                                                    <small>{{ cheque.invoice.pos_device.bank_name }}</small>
                                                    {% if cheque.invoice.pos_device.account_holder %}
                                                    <small>صاحب حساب: {{ cheque.invoice.pos_device.account_holder }}</small>
                                                    {% endif %}
                                                    {% if cheque.invoice.pos_device.account_number %}
                                                    <small>شماره حساب: {{ cheque.invoice.pos_device.account_number }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-end">{{ cheque.amount|floatformat:0 }}</td>
                                        <td>
                                            <input type="text"
                                                   class="form-control amount-input user-amount-input"
                                                   data-item-type="cheque"
                                                   data-item-id="{{ cheque.id }}"
                                                   data-calculated="{{ cheque.amount }}"
                                                   placeholder="مبلغ واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   class="form-check-input verify-checkbox"
                                                   data-item-type="cheque"
                                                   data-item-id="{{ cheque.id }}"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-bank"></i>
                            <h5>هیچ چکی وجود ندارد</h5>
                            <p class="text-muted">برای امروز هیچ چکی سررسید نشده است.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-clock-history me-2"></i> نسیه‌های سررسید شده
                        </span>
                        <span class="badge bg-primary">{{ credits|length }} نسیه</span>
                    </div>
                    <div class="card-body">
                        {% if credits %}
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>مشتری</th>
                                        <th>تلفن</th>
                                        <th>شعبه</th>
                                        <th>حساب بانکی</th>
                                        <th>مبلغ محاسبه شده</th>
                                        <th class="text-center">ورود مبلغ</th>
                                        <th class="text-center">تایید</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for credit in credits %}
                                    <tr class="calculated-row">
                                        <td>
                                            <div class="fw-bold">{{ credit.customer_name }}</div>
                                            {% if credit.customer_family %}
                                                <div>{{ credit.customer_family }}</div>
                                            {% endif %}
                                        </td>
                                        <td>{{ credit.phone|default:"-" }}</td>
                                        <td>{{ credit.invoice.branch.name }}</td>
                                        <td class="account-cell">
                                            {% if credit.invoice.pos_device %}
                                                <div class="bank-info">
                                                    <strong>{{ credit.invoice.pos_device.name }}</strong>
                                                    <small>{{ credit.invoice.pos_device.bank_name }}</small>
                                                    {% if credit.invoice.pos_device.account_holder %}
                                                    <small>صاحب حساب: {{ credit.invoice.pos_device.account_holder }}</small>
                                                    {% endif %}
                                                    {% if credit.invoice.pos_device.account_number %}
                                                    <small>شماره حساب: {{ credit.invoice.pos_device.account_number }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-end">{{ credit.credit_amount|floatformat:0 }}</td>
                                        <td>
                                            <input type="text"
                                                   class="form-control amount-input user-amount-input"
                                                   data-item-type="credit"
                                                   data-item-id="{{ credit.id }}"
                                                   data-calculated="{{ credit.credit_amount }}"
                                                   placeholder="مبلغ واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   class="form-check-input verify-checkbox"
                                                   data-item-type="credit"
                                                   data-item-id="{{ credit.id }}"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-clock-history"></i>
                            <h5>هیچ نسیه‌ای وجود ندارد</h5>
                            <p class="text-muted">برای امروز هیچ نسیه‌ای سررسید نشده است.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌های عملیات -->
        {% if not daily_status.is_verified %}
        <div class="action-buttons">
            <button class="btn action-btn btn-secondary" onclick="window.location.href='{% url 'cash_management:calendar' %}'">
                <i class="bi bi-arrow-right"></i>
                بازگشت به تقویم
            </button>

            <button class="btn action-btn btn-secondary" onclick="cancelChanges()">
                <i class="bi bi-x-circle"></i>
                انصراف
            </button>

            <button class="btn action-btn btn-verify" onclick="finalizeDay()" id="finalizeBtn">
                <i class="bi bi-check-circle"></i>
                تایید نهایی و ثبت در صندوق
            </button>
        </div>
        {% endif %}

        <!-- مودال تایید -->
        <!-- ... مودال بدون تغییر ... -->

        <!-- فوتر -->
        <div class="footer">
            سیستم مدیریت صندوق - نسخه 1.0
            <br>
            تمامی حقوق محفوظ است © {% now "Y" %}
        </div>
    </div>
<!-- ================ مودال تایید آیتم ================ -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="verificationModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    تایید آیتم با تفاوت مبلغ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>توجه!</strong> مبلغ وارد شده با مبلغ محاسبه شده متفاوت است.
                </div>
                
                <div class="row mb-3">
                    <div class="col-12 mb-2">
                        <label class="form-label small text-muted mb-1">نوع آیتم</label>
                        <div class="form-control bg-light py-2" id="modal-item-type">-</div>
                    </div>
                    
                    <div class="col-md-6 mb-2">
                        <label class="form-label small text-muted mb-1">مبلغ محاسبه شده</label>
                        <div class="form-control bg-light text-end fw-bold py-2" id="modal-calculated-amount">0</div>
                    </div>
                    
                    <div class="col-md-6 mb-2">
                        <label class="form-label small text-muted mb-1">مبلغ وارد شده</label>
                        <div class="form-control bg-light text-end fw-bold py-2" id="modal-user-amount">0</div>
                    </div>
                </div>
                
                <div class="mb-3" id="modal-difference-section">
                    <label class="form-label small text-danger mb-1">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        اختلاف مبلغ
                    </label>
                    <div class="form-control bg-danger bg-opacity-10 text-danger text-end fw-bold py-2" id="modal-difference">0</div>
                </div>
                
                <div class="mb-3">
                    <label for="modal-reason" class="form-label small text-muted mb-1">
                        <i class="bi bi-chat-left-text me-1"></i>
                        علت تفاوت (اختیاری)
                    </label>
                    <textarea class="form-control" id="modal-reason" rows="3" 
                              placeholder="در صورت نیاز، علت تفاوت را توضیح دهید..."></textarea>
                    <div class="form-text">این توضیحات در گزارش مغایرت ثبت خواهد شد.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    انصراف
                </button>
                <button type="button" class="btn btn-success" id="confirmVerification">
                    <i class="bi bi-check-circle me-1"></i>
                    تایید و ثبت
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ================ پایان مودال ================ -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // متغیرهای سراسری
        let currentVerificationData = null;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // تابع تبدیل اعداد فارسی به انگلیسی
        function convertToEnglish(numStr) {
            if (!numStr) return "0";

            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];

            let result = numStr.toString();

            for (let i = 0; i < 10; i++) {
                const persianRegex = new RegExp(persianDigits[i], 'g');
                const arabicRegex = new RegExp(arabicDigits[i], 'g');
                result = result.replace(persianRegex, i);
                result = result.replace(arabicRegex, i);
            }

            result = result.replace(/[٬,]/g, '');
            result = result.replace(/\s/g, '');

            return result || "0";
        }

        // تابع فرمت عدد به فارسی
        function formatNumber(num) {
            if (!num || num === "0") return "۰";
            const numInt = parseInt(convertToEnglish(num));
            if (isNaN(numInt)) return "۰";
            return numInt.toLocaleString('fa-IR');
        }

        // رویداد کلیک روی چک‌باکس تایید
        $(document).on('click', '.verify-checkbox', function(e) {
            if ($('#isVerified').val() === 'true') {
                this.checked = !this.checked;
                return;
            }

            const checkbox = $(this);
            const itemType = checkbox.data('item-type');
            const itemId = checkbox.data('item-id') || checkbox.data('branch-id');
            const paymentType = checkbox.data('payment-type') || '';

            // پیدا کردن input مربوطه
            let userInput;
            if (itemType.includes('branch')) {
                userInput = $(`.user-amount-input[data-item-type="${itemType}"][data-branch-id="${itemId}"]`);
            } else {
                userInput = $(`.user-amount-input[data-item-type="${itemType}"][data-item-id="${itemId}"]`);
            }

            const calculatedAmount = parseFloat(userInput.data('calculated')) || 0;
            const userAmount = parseFloat(convertToEnglish(userInput.val())) || 0;

            // ذخیره داده‌ها برای مودال
            currentVerificationData = {
                checkbox: checkbox,
                userInput: userInput,
                itemType: itemType,
                itemId: itemId,
                paymentType: paymentType,
                calculatedAmount: calculatedAmount,
                userAmount: userAmount,
                date: $('#currentDate').val()
            };

            // نمایش مودال
            $('#modal-item-type').text(getItemTypeName(itemType));
            $('#modal-calculated-amount').text(formatNumber(calculatedAmount) + ' تومان');
            $('#modal-user-amount').text(formatNumber(userAmount) + ' تومان');

            // نمایش اختلاف اگر وجود دارد
            const difference = Math.abs(userAmount - calculatedAmount);
            if (difference > 0) {
                $('#modal-difference-section').show();
                $('#modal-difference').text(formatNumber(difference) + ' تومان');
            } else {
                $('#modal-difference-section').hide();
            }

            $('#verificationModal').modal('show');
            e.preventDefault();
        });

        // فرمت اعداد هنگام تایپ
        $(document).on('input', '.user-amount-input', function() {
            let value = $(this).val();
            value = convertToEnglish(value);
            $(this).val(value);
        });

        // فرمت اعداد هنگام از دست دادن فوکوس
        $(document).on('blur', '.user-amount-input', function() {
            let value = $(this).val();
            if (value) {
                value = formatNumber(value);
                $(this).val(value);
            }
        });

        // تابع انصراف
        function cancelChanges() {
            if (confirm('آیا از انصراف مطمئن هستید؟ تغییرات ذخیره نشده از بین می‌روند.')) {
                window.location.href = "{% url 'cash_management:calendar' %}";
            }
        }

        // تابع تایید نهایی روز
        function finalizeDay() {
            if (!confirm('آیا از تایید نهایی این روز مطمئن هستید؟ پس از تایید، امکان ویرایش وجود نخواهد داشت و اطلاعات در صندوق ثبت می‌شوند.')) {
                return;
            }

            const data = {
                date: $('#currentDate').val()
            };

            $.ajax({
                url: '{% url "cash_management:finalize_day" %}',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        showMessage('روز با موفقیت تایید و در صندوق ثبت شد');
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showMessage('خطا: ' + response.error, 'danger');
                    }
                },
                error: function() {
                    showMessage('خطا در ارتباط با سرور', 'danger');
                }
            });
        }

        // فرمت اعداد هنگام لود صفحه
        $(document).ready(function() {
            $('.user-amount-input').each(function() {
                const value = $(this).val();
                if (value) {
                    $(this).val(formatNumber(value));
                }
            });
        });
        
        
        
        function getItemTypeName(type) {
        const types = {
            'branch_cash': 'نقدی شعبه',
            'branch_pos': 'پوز شعبه',
            'investment': 'سرمایه‌گذاری',
            'cheque': 'چک',
            'credit': 'نسیه'
        };
        return types[type] || type;
    }

    // رویداد کلیک روی چک‌باکس تایید
    $(document).on('click', '.verify-checkbox', function(e) {
        if ($('#isVerified').val() === 'true') {
            this.checked = !this.checked;
            showMessage('این روز قبلاً تایید شده و قابل ویرایش نیست', 'warning');
            return;
        }
        
        const checkbox = $(this);
        const itemType = checkbox.data('item-type');
        const itemId = checkbox.data('item-id') || checkbox.data('branch-id');
        const paymentType = checkbox.data('payment-type') || '';
        
        console.log('تیک زده شد:', {itemType, itemId, paymentType});
        
        // پیدا کردن input مربوطه
        let userInput;
        let calculatedAmount = 0;
        
        if (itemType.includes('branch')) {
            userInput = $(`.user-amount-input[data-item-type="${itemType}"][data-branch-id="${itemId}"]`);
            calculatedAmount = parseFloat(userInput.data('calculated')) || 0;
            console.log('شعبه - calculated:', calculatedAmount);
        } else {
            userInput = $(`.user-amount-input[data-item-type="${itemType}"][data-item-id="${itemId}"]`);
            calculatedAmount = parseFloat(userInput.data('calculated')) || 0;
            console.log('سایر - calculated:', calculatedAmount);
        }
        
        const userAmountStr = userInput.val() || '0';
        const userAmount = parseFloat(convertToEnglish(userAmountStr)) || 0;
        
        console.log('userAmount:', userAmount);
        
        // بررسی اینکه آیا مبلغ وارد شده است
        if (userAmount <= 0) {
            showMessage('لطفاً ابتدا مبلغ را وارد کنید', 'warning');
            checkbox.prop('checked', false);
            return;
        }
        
        // ذخیره داده‌ها برای ارسال
        currentVerificationData = {
            checkbox: checkbox,
            userInput: userInput,
            itemType: itemType,
            itemId: itemId,
            paymentType: paymentType,
            calculatedAmount: calculatedAmount,
            userAmount: userAmount,
            date: $('#currentDate').val()
        };
        
        console.log('currentVerificationData:', currentVerificationData);
        
        // اگر تفاوت وجود دارد، نمایش مودال برای توضیح علت
        const difference = Math.abs(userAmount - calculatedAmount);
        console.log('difference:', difference);
        
        if (difference > 0) {
            // نمایش مودال برای وارد کردن علت تفاوت
            showDifferenceModal(calculatedAmount, userAmount, difference);
        } else {
            // اگر تفاوتی نیست، مستقیم تایید کن
            confirmVerificationWithoutDifference();
        }
        
        e.preventDefault();
    });

    // نمایش مودال برای تفاوت
    function showDifferenceModal(calculated, user, difference) {
        $('#modal-item-type').text(getItemTypeName(currentVerificationData.itemType));
        $('#modal-calculated-amount').text(formatNumber(calculated) + ' تومان');
        $('#modal-user-amount').text(formatNumber(user) + ' تومان');
        $('#modal-difference-section').show();
        $('#modal-difference').text(formatNumber(difference) + ' تومان');
        $('#modal-reason').val('');
        $('#verificationModal').modal('show');
    }



    
    
    
// اتصال دکمه تایید مودال - نسخه اصلاح شده
$(document).on('click', '#confirmVerification', function() {
    console.log('🚀 دکمه تایید در مودال کلیک شد');
    
    if (!currentVerificationData) {
        showMessage('داده‌ها برای تایید یافت نشد', 'danger');
        $('#verificationModal').modal('hide');
        return;
    }
    
    // داده‌ها را در یک متغیر محلی ذخیره کن
    const verificationData = {
        checkbox: currentVerificationData.checkbox,
        userInput: currentVerificationData.userInput,
        itemType: currentVerificationData.itemType,
        itemId: currentVerificationData.itemId,
        paymentType: currentVerificationData.paymentType
    };
    
    const data = {
        item_type: currentVerificationData.itemType,
        item_id: currentVerificationData.itemId,
        payment_type: currentVerificationData.paymentType || '',
        calculated_amount: currentVerificationData.calculatedAmount,
        user_amount: currentVerificationData.userAmount,
        reason: $('#modal-reason').val(),
        date: currentVerificationData.date
    };
    
    console.log('📤 ارسال داده‌ها از مودال:', data);
    
    // بستن مودال
    $('#verificationModal').modal('hide');
    
    // پاک کردن فرم
    $('#modal-reason').val('');
    
    // ارسال درخواست با داده‌های محلی
    sendVerificationRequest(data, verificationData);
    
    // currentVerificationData را پاک کن (اما دیرتر)
    setTimeout(() => {
        currentVerificationData = null;
    }, 1000);
});    
    // تابع ارسال درخواست تایید - نسخه اصلاح شده
function sendVerificationRequest(data, verificationData) {
    // از verificationData پارامتر استفاده کن، اگر نبود از currentVerificationData
    const vData = verificationData || currentVerificationData;
    
    console.log('📤 ارسال درخواست تایید:', data);
    console.log('📊 verificationData:', vData);
    
    // نمایش لودر
    showLoader();
    
    $.ajax({
        url: '{% url "cash_management:verify_item" %}',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            console.log('✅ پاسخ سرور:', response);
            if (response.success) {
                // غیرفعال کردن input و checkbox اگر vData وجود دارد
                if (vData && vData.userInput && vData.userInput.length > 0) {
                    vData.userInput.prop('disabled', true);
                    console.log('✅ اینپوت غیرفعال شد');
                }
                
                if (vData && vData.checkbox && vData.checkbox.length > 0) {
                    vData.checkbox.prop('checked', true).prop('disabled', true);
                    console.log('✅ تیک غیرفعال شد');
                }
                
                // به‌روزرسانی وضعیت
                if (vData) {
                    updateVerificationStatus(vData);
                }
                
                // نمایش پیام موفقیت
                showMessage('آیتم با موفقیت تایید شد');
                
                // به‌روزرسانی جمع کل
                updateTotalAmounts();
            } else {
                showMessage('خطا: ' + response.error, 'danger');
                // اگر تیک هنوز فعال است، آن را برگردان
                if (vData && vData.checkbox && vData.checkbox.length > 0) {
                    vData.checkbox.prop('checked', false);
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('❌ خطا در ارسال درخواست:', error);
            showMessage('خطا در ارتباط با سرور: ' + error, 'danger');
            // اگر تیک هنوز فعال است، آن را برگردان
            if (vData && vData.checkbox && vData.checkbox.length > 0) {
                vData.checkbox.prop('checked', false);
            }
        },
        complete: function() {
            // مخفی کردن لودر
            hideLoader();
        }
    });
}
// تایید بدون تفاوت - نسخه اصلاح شده
function confirmVerificationWithoutDifference() {
    if (!currentVerificationData) {
        showMessage('داده‌ها برای تایید یافت نشد', 'danger');
        return;
    }
    
    // داده‌ها را در یک متغیر محلی ذخیره کن
    const verificationData = {
        checkbox: currentVerificationData.checkbox,
        userInput: currentVerificationData.userInput,
        itemType: currentVerificationData.itemType,
        itemId: currentVerificationData.itemId,
        paymentType: currentVerificationData.paymentType
    };
    
    const data = {
        item_type: currentVerificationData.itemType,
        item_id: currentVerificationData.itemId,
        payment_type: currentVerificationData.paymentType || '',
        calculated_amount: currentVerificationData.calculatedAmount,
        user_amount: currentVerificationData.userAmount,
        reason: '',
        date: currentVerificationData.date
    };
    
    console.log('ارسال درخواست تایید (بدون تفاوت):', data);
    
    // ارسال درخواست با داده‌های محلی
    sendVerificationRequest(data, verificationData);
    
    // currentVerificationData را پاک کن (اما دیرتر)
    setTimeout(() => {
        currentVerificationData = null;
    }, 1000);
}
// نمایش لودر
function showLoader() {
    if ($('.loader-overlay').length === 0) {
        $('body').append(`
            <div class="loader-overlay" style="
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                z-index: 99999;
                display: flex;
                justify-content: center;
                align-items: center;
            ">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
            </div>
        `);
    }
}

// مخفی کردن لودر
function hideLoader() {
    $('.loader-overlay').remove();
}
// تابع به‌روزرسانی وضعیت تایید در صفحه
function updateVerificationStatus(vData) {
    console.log('🔄 به‌روزرسانی وضعیت تایید:', vData);
    
    try {
        if (!vData) {
            console.warn('داده‌ای برای به‌روزرسانی وضعیت وجود ندارد');
            return;
        }
        
        const { itemType, itemId } = vData;
        
        // پیدا کردن المان وضعیت
        let statusElement;
        
        if (itemType.includes('branch')) {
            // برای شعبه‌ها
            const statusId = itemType.replace('branch_', '');
            statusElement = $(`#status-${statusId}-${itemId}`);
            
            if (statusElement.length) {
                statusElement.html(`
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>
                        تایید شده
                    </span>
                `);
                console.log(`✅ وضعیت ${itemType} شعبه ${itemId} به‌روز شد`);
            }
        } else {
            // برای سرمایه‌گذاری، چک و نسیه
            // پیدا کردن ردیف مربوطه در جدول
            const row = $(`.user-amount-input[data-item-type="${itemType}"][data-item-id="${itemId}"]`).closest('tr');
            
            if (row.length) {
                // اضافه کردن آیکون تایید به آخرین ستون
                const lastTd = row.find('td:last');
                lastTd.html(`
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i>
                        تایید شده
                    </span>
                `);
                console.log(`✅ وضعیت ${itemType} آیتم ${itemId} به‌روز شد`);
            }
        }
        
    } catch (error) {
        console.error('❌ خطا در به‌روزرسانی وضعیت:', error);
    }
}
// تابع به‌روزرسانی جمع کل مبالغ
function updateTotalAmounts() {
    console.log('🔄 به‌روزرسانی جمع کل مبالغ...');
    
    try {
        let totalCash = 0;
        let totalPos = 0;
        let totalInvestments = 0;
        let totalCheques = 0;
        let totalCredits = 0;
        
        // جمع مبالغ نقدی تایید شده
        $('.user-amount-input[data-item-type="branch_cash"]:disabled').each(function() {
            const amount = parseFloat(convertToEnglish($(this).val())) || 0;
            totalCash += amount;
        });
        
        // جمع مبالغ پوز تایید شده
        $('.user-amount-input[data-item-type="branch_pos"]:disabled').each(function() {
            const amount = parseFloat(convertToEnglish($(this).val())) || 0;
            totalPos += amount;
        });
        
        // جمع سرمایه‌گذاری‌های تایید شده
        $('.user-amount-input[data-item-type="investment"]:disabled').each(function() {
            const amount = parseFloat(convertToEnglish($(this).val())) || 0;
            totalInvestments += amount;
        });
        
        // جمع چک‌های تایید شده
        $('.user-amount-input[data-item-type="cheque"]:disabled').each(function() {
            const amount = parseFloat(convertToEnglish($(this).val())) || 0;
            totalCheques += amount;
        });
        
        // جمع نسیه‌های تایید شده
        $('.user-amount-input[data-item-type="credit"]:disabled').each(function() {
            const amount = parseFloat(convertToEnglish($(this).val())) || 0;
            totalCredits += amount;
        });
        
        // به‌روزرسانی نمایش
        $('#total-cash').text(formatNumber(totalCash));
        $('#total-pos').text(formatNumber(totalPos));
        $('#total-investments').text(formatNumber(totalInvestments));
        $('#total-cheques').text(formatNumber(totalCheques));
        $('#total-credits').text(formatNumber(totalCredits));
        
        // محاسبه کل روز
        const totalAll = totalCash + totalPos + totalInvestments + totalCheques + totalCredits;
        $('#total-all').text(formatNumber(totalAll));
        
        console.log('💰 جمع‌های به‌روز شده:', {
            totalCash, totalPos, totalInvestments, totalCheques, totalCredits, totalAll
        });
        
    } catch (error) {
        console.error('❌ خطا در به‌روزرسانی جمع کل:', error);
    }
}
// تابع نمایش پیام
function showMessage(message, type = 'success') {
    console.log('💬 نمایش پیام:', message, type);
    
    // حذف پیام‌های قبلی
    $('.alert-dismissible').remove();
    
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 
                      type === 'info' ? 'alert-info' : 'alert-danger';
    
    const icon = type === 'success' ? 'bi-check-circle' : 
                 type === 'warning' ? 'bi-exclamation-triangle' : 
                 type === 'info' ? 'bi-info-circle' : 'bi-exclamation-circle';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
             style="z-index: 9999; max-width: 500px;" role="alert">
            <i class="bi ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    // بعد از 5 ثانیه پیام را پاک کن
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
    
    </script>



</body>
</html>
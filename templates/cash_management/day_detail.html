
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جزئیات روز {{ jalali_date }}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">

    <style>
        /* استایل‌های قبلی باقی می‌مانند */
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        /* ... استایل‌های قبلی باقی می‌مانند ... */

        /* استایل‌های جدید برای دستگاه‌های پوز */
        .pos-device-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .pos-device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .pos-device-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .pos-device-bank {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .pos-device-details {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .pos-device-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2e7d32;
            text-align: left;
            direction: ltr;
        }

        .account-badge {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .bank-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        .bank-info small {
            display: block;
            color: #6c757d;
        }

        .device-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        /* استایل برای جدول‌ها */
        .table-sm th, .table-sm td {
            padding: 8px;
            font-size: 0.85rem;
        }

        .table-separator {
            border-top: 2px solid #dee2e6 !important;
        }

        .device-row {
            background-color: #f8f9fa !important;
        }

        .device-row td {
            padding-left: 40px !important;
        }

        .no-device-row {
            background-color: #fff3cd !important;
            color: #856404;
        }

        .account-cell {
            max-width: 200px;
            word-wrap: break-word;
        }

        /* استایل‌های responsive */
        @media (max-width: 768px) {
            .pos-device-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .pos-device-bank {
                margin-top: 5px;
            }
            
            .bank-info {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-main">
        <!-- هدر - بدون تغییر -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <a href="{% url 'cash_management:calendar' %}" class="back-btn">
                        <i class="bi bi-arrow-right"></i>
                        بازگشت به تقویم
                    </a>
                </div>
                <div class="user-info">
                    <i class="bi bi-person-circle"></i>
                    <span>{{ user.get_full_name|default:user.username }}</span>
                </div>
            </div>

            <div class="date-header">
                <div class="date-badge">
                    <i class="bi bi-calendar-date"></i>
                    تاریخ شمسی: {{ jalali_date }}
                </div>
                <div class="date-badge">
                    <i class="bi bi-calendar"></i>
                    تاریخ میلادی: {{ gregorian_date }}
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-cash-stack me-2"></i>
                    جزئیات گردش مالی روزانه
                </h1>
                <div>
                    {% if daily_status.is_verified %}
                    <span class="status-badge status-verified">
                        <i class="bi bi-check-circle me-2"></i> تایید شده
                        {% if daily_status.verified_by %}
                        <span class="ms-2">توسط: {{ daily_status.verified_by.get_full_name|default:daily_status.verified_by.username }}</span>
                        {% endif %}
                    </span>
                    {% else %}
                    <span class="status-badge status-pending">
                        <i class="bi bi-exclamation-circle me-2"></i> 
                        {% if has_unverified_non_zero %}
                            نیاز به بررسی
                        {% else %}
                            آماده تایید
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- اطلاعات روز -->
        <input type="hidden" id="currentDate" value="{{ date_str }}">
        <input type="hidden" id="isVerified" value="{{ daily_status.is_verified|yesno:'true,false' }}">
        {% csrf_token %}

        <!-- کارت‌های مجموع - بدون تغییر -->
        <div class="row mb-5">
            <!-- ... کارت‌های مجموع ... -->
        </div>

        <!-- بخش اصلی -->
        <div class="row">
            <!-- بخش شعب با دستگاه‌های پوز -->
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-shop me-2"></i> گردش شعب
                        </span>
                        <span class="badge bg-primary">{{ branch_data|length }} شعبه</span>
                    </div>
                    <div class="card-body">
                        {% if branch_data %}
                            {% for item in branch_data %}
                            <div class="branch-section mb-4 p-3 border rounded">
                                <!-- هدر شعبه -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="bi bi-building me-2"></i>
                                        <strong>{{ item.branch.name }}</strong>
                                    </h5>
                                    {% if item.branch_cash.is_verified %}
                                    <span class="badge bg-success">تایید شده</span>
                                    {% endif %}
                                </div>
                                
                                <!-- جدول اطلاعات فاکتورها -->
                                <div class="table-responsive mb-3">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th colspan="4" class="text-center">
                                                    گزارش فاکتورهای {{ item.branch.name }}
                                                    <small class="text-muted">
                                                        ({{ item.total_invoices }} فاکتور)
                                                    </small>
                                                </th>
                                            </tr>
                                            <tr>
                                                <th>نوع</th>
                                                <th>دستگاه/حساب</th>
                                                <th>تعداد</th>
                                                <th class="text-end">مبلغ (تومان)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- ردیف نقدی -->
                                            <tr class="calculated-row">
                                                <td>
                                                    <i class="bi bi-cash-coin text-success me-2"></i>
                                                    <strong>نقدی</strong>
                                                </td>
                                                <td>-</td>
                                                <td>{{ item.cash_invoice_count }}</td>
                                                <td class="text-end fw-bold">
                                                    {{ item.cash_total|floatformat:0 }}
                                                </td>
                                            </tr>
                                            
                                            <!-- ردیف پوز با تفکیک دستگاه -->
                                            {% if item.pos_devices_details %}
                                                {% for pos in item.pos_devices_details %}
                                                <tr class="device-row">
                                                    <td>
                                                        {% if forloop.first %}
                                                        <i class="bi bi-credit-card text-primary me-2"></i>
                                                        <strong>پوز</strong>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="d-flex flex-column">
                                                            <strong>{{ pos.device_name }}</strong>
                                                            <small class="text-muted">{{ pos.bank_name }}</small>
                                                            {% if pos.account_holder %}
                                                            <small class="text-muted">صاحب حساب: {{ pos.account_holder }}</small>
                                                            {% endif %}
                                                            {% if pos.account_number %}
                                                            <small class="text-muted">شماره حساب: {{ pos.account_number }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                    <td>{{ pos.count }}</td>
                                                    <td class="text-end">
                                                        {{ pos.amount|floatformat:0 }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr class="calculated-row">
                                                    <td>
                                                        <i class="bi bi-credit-card text-primary me-2"></i>
                                                        <strong>پوز</strong>
                                                    </td>
                                                    <td>بدون دستگاه</td>
                                                    <td>{{ item.pos_invoice_count }}</td>
                                                    <td class="text-end fw-bold">
                                                        {{ item.pos_total|floatformat:0 }}
                                                    </td>
                                                </tr>
                                            {% endif %}
                                            
                                            <!-- ردیف جمع کل -->
                                            <tr class="table-success table-separator">
                                                <td colspan="2"><strong>جمع کل این شعبه</strong></td>
                                                <td>{{ item.cash_invoice_count|add:item.pos_invoice_count }}</td>
                                                <td class="text-end fw-bold">
                                                    {{ item.cash_total|add:item.pos_total|floatformat:0 }}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- فیلدهای ورودی مبالغ -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-cash-coin text-success"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control amount-input user-amount-input" 
                                                   data-item-type="branch_cash"
                                                   data-branch-id="{{ item.branch.id }}"
                                                   data-payment-type="cash"
                                                   data-calculated="{{ item.cash_total }}"
                                                   placeholder="مبلغ نقدی واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                            <span class="input-group-text">تومان</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input type="checkbox" 
                                                       class="form-check-input verify-checkbox" 
                                                       data-item-type="branch_cash"
                                                       data-branch-id="{{ item.branch.id }}"
                                                       data-payment-type="cash"
                                                       {% if daily_status.is_verified %}disabled{% endif %}
                                                       id="verify-cash-{{ item.branch.id }}">
                                                <label class="form-check-label small" for="verify-cash-{{ item.branch.id }}">
                                                    تایید نقدی
                                                </label>
                                            </div>
                                            <span class="verification-status small" id="status-cash-{{ item.branch.id }}"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-credit-card text-primary"></i>
                                            </span>
                                            <input type="text" 
                                                   class="form-control amount-input user-amount-input" 
                                                   data-item-type="branch_pos"
                                                   data-branch-id="{{ item.branch.id }}"
                                                   data-payment-type="pos"
                                                   data-calculated="{{ item.pos_total }}"
                                                   placeholder="مبلغ پوز واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                            <span class="input-group-text">تومان</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input type="checkbox" 
                                                       class="form-check-input verify-checkbox" 
                                                       data-item-type="branch_pos"
                                                       data-branch-id="{{ item.branch.id }}"
                                                       data-payment-type="pos"
                                                       {% if daily_status.is_verified %}disabled{% endif %}
                                                       id="verify-pos-{{ item.branch.id }}">
                                                <label class="form-check-label small" for="verify-pos-{{ item.branch.id }}">
                                                    تایید پوز
                                                </label>
                                            </div>
                                            <span class="verification-status small" id="status-pos-{{ item.branch.id }}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="bi bi-shop"></i>
                                <h5>هیچ شعبه‌ای یافت نشد</h5>
                                <p class="text-muted">لطفاً ابتدا شعبه‌ها را در سیستم تعریف کنید.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- بخش سرمایه‌گذاری‌ها با حساب بانکی -->
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-graph-up me-2"></i> سرمایه‌گذاری‌ها
                        </span>
                        <span class="badge bg-primary">{{ investments|length }} مورد</span>
                    </div>
                    <div class="card-body">
                        {% if investments %}
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>سرمایه‌گذار</th>
                                        <th>روش پرداخت</th>
                                        <th>حساب بانکی</th>
                                        <th>مبلغ محاسبه شده</th>
                                        <th class="text-center">ورود مبلغ</th>
                                        <th class="text-center">تایید</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for investment in investments %}
                                    <tr class="calculated-row">
                                        <td>
                                            <div class="fw-bold">{{ investment.investor.firstname }} {{ investment.investor.lastname }}</div>
                                            <small class="text-muted">{{ investment.investor.melicode }}</small>
                                        </td>
                                        <td>
                                            {% if investment.payment_method == 'cash' %}
                                                <span class="badge bg-success">نقدی</span>
                                            {% elif investment.payment_method == 'bank_transfer' %}
                                                <span class="badge bg-primary">واریز به حساب</span>
                                            {% endif %}
                                        </td>
                                        <td class="account-cell">
                                            {% if investment.payment_account %}
                                                <div class="bank-info">
                                                    <strong>{{ investment.payment_account.name }}</strong>
                                                    <small>{{ investment.payment_account.bank_name }}</small>
                                                    {% if investment.payment_account.account_holder %}
                                                    <small>صاحب حساب: {{ investment.payment_account.account_holder }}</small>
                                                    {% endif %}
                                                    {% if investment.payment_account.account_number %}
                                                    <small>شماره حساب: {{ investment.payment_account.account_number }}</small>
                                                    {% endif %}
                                                    {% if investment.payment_account.card_number %}
                                                    <small>شماره کارت: {{ investment.payment_account.card_number }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-end">{{ investment.amount|floatformat:0 }}</td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control amount-input user-amount-input" 
                                                   data-item-type="investment"
                                                   data-item-id="{{ investment.id }}"
                                                   data-calculated="{{ investment.amount }}"
                                                   placeholder="مبلغ واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox" 
                                                   class="form-check-input verify-checkbox" 
                                                   data-item-type="investment"
                                                   data-item-id="{{ investment.id }}"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-graph-up"></i>
                            <h5>هیچ سرمایه‌گذاری ثبت نشده</h5>
                            <p class="text-muted">برای این روز هیچ سرمایه‌گذاری ثبت نشده است.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- بخش چک‌ها و نسیه‌ها -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-bank me-2"></i> چک‌های سررسید شده
                        </span>
                        <span class="badge bg-primary">{{ cheques|length }} چک</span>
                    </div>
                    <div class="card-body">
                        {% if cheques %}
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>شماره چک</th>
                                        <th>صادرکننده</th>
                                        <th>بانک</th>
                                        <th>حساب بانکی</th>
                                        <th>مبلغ محاسبه شده</th>
                                        <th class="text-center">ورود مبلغ</th>
                                        <th class="text-center">تایید</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cheque in cheques %}
                                    <tr class="calculated-row">
                                        <td>
                                            <div class="fw-bold">{{ cheque.check_number }}</div>
                                            <small class="text-muted">{{ cheque.invoice.branch.name }}</small>
                                        </td>
                                        <td>{{ cheque.owner_name }} {{ cheque.owner_family }}</td>
                                        <td>{{ cheque.bank_name|default:"نامشخص" }}</td>
                                        <td class="account-cell">
                                            {% if cheque.invoice.pos_device %}
                                                <div class="bank-info">
                                                    <strong>{{ cheque.invoice.pos_device.name }}</strong>
                                                    <small>{{ cheque.invoice.pos_device.bank_name }}</small>
                                                    {% if cheque.invoice.pos_device.account_holder %}
                                                    <small>صاحب حساب: {{ cheque.invoice.pos_device.account_holder }}</small>
                                                    {% endif %}
                                                    {% if cheque.invoice.pos_device.account_number %}
                                                    <small>شماره حساب: {{ cheque.invoice.pos_device.account_number }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-end">{{ cheque.amount|floatformat:0 }}</td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control amount-input user-amount-input" 
                                                   data-item-type="cheque"
                                                   data-item-id="{{ cheque.id }}"
                                                   data-calculated="{{ cheque.amount }}"
                                                   placeholder="مبلغ واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox" 
                                                   class="form-check-input verify-checkbox" 
                                                   data-item-type="cheque"
                                                   data-item-id="{{ cheque.id }}"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-bank"></i>
                            <h5>هیچ چکی وجود ندارد</h5>
                            <p class="text-muted">برای امروز هیچ چکی سررسید نشده است.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card-custom">
                    <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-clock-history me-2"></i> نسیه‌های سررسید شده
                        </span>
                        <span class="badge bg-primary">{{ credits|length }} نسیه</span>
                    </div>
                    <div class="card-body">
                        {% if credits %}
                        <div class="table-responsive">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>مشتری</th>
                                        <th>تلفن</th>
                                        <th>شعبه</th>
                                        <th>حساب بانکی</th>
                                        <th>مبلغ محاسبه شده</th>
                                        <th class="text-center">ورود مبلغ</th>
                                        <th class="text-center">تایید</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for credit in credits %}
                                    <tr class="calculated-row">
                                        <td>
                                            <div class="fw-bold">{{ credit.customer_name }}</div>
                                            {% if credit.customer_family %}
                                                <div>{{ credit.customer_family }}</div>
                                            {% endif %}
                                        </td>
                                        <td>{{ credit.phone|default:"-" }}</td>
                                        <td>{{ credit.invoice.branch.name }}</td>
                                        <td class="account-cell">
                                            {% if credit.invoice.pos_device %}
                                                <div class="bank-info">
                                                    <strong>{{ credit.invoice.pos_device.name }}</strong>
                                                    <small>{{ credit.invoice.pos_device.bank_name }}</small>
                                                    {% if credit.invoice.pos_device.account_holder %}
                                                    <small>صاحب حساب: {{ credit.invoice.pos_device.account_holder }}</small>
                                                    {% endif %}
                                                    {% if credit.invoice.pos_device.account_number %}
                                                    <small>شماره حساب: {{ credit.invoice.pos_device.account_number }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="fw-bold text-end">{{ credit.credit_amount|floatformat:0 }}</td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control amount-input user-amount-input" 
                                                   data-item-type="credit"
                                                   data-item-id="{{ credit.id }}"
                                                   data-calculated="{{ credit.credit_amount }}"
                                                   placeholder="مبلغ واقعی"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                        <td class="text-center">
                                            <input type="checkbox" 
                                                   class="form-check-input verify-checkbox" 
                                                   data-item-type="credit"
                                                   data-item-id="{{ credit.id }}"
                                                   {% if daily_status.is_verified %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-clock-history"></i>
                            <h5>هیچ نسیه‌ای وجود ندارد</h5>
                            <p class="text-muted">برای امروز هیچ نسیه‌ای سررسید نشده است.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌های عملیات -->
        {% if not daily_status.is_verified %}
        <div class="action-buttons">
            <button class="btn action-btn btn-secondary" onclick="window.location.href='{% url 'cash_management:calendar' %}'">
                <i class="bi bi-arrow-right"></i>
                بازگشت به تقویم
            </button>
            
            <button class="btn action-btn btn-secondary" onclick="cancelChanges()">
                <i class="bi bi-x-circle"></i>
                انصراف
            </button>
            
            <button class="btn action-btn btn-verify" onclick="finalizeDay()" id="finalizeBtn">
                <i class="bi bi-check-circle"></i>
                تایید نهایی و ثبت در صندوق
            </button>
        </div>
        {% endif %}

        <!-- مودال تایید -->
        <!-- ... مودال بدون تغییر ... -->

        <!-- فوتر -->
        <div class="footer">
            سیستم مدیریت صندوق - نسخه 1.0
            <br>
            تمامی حقوق محفوظ است © {% now "Y" %}
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // متغیرهای سراسری
        let currentVerificationData = null;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // تابع تبدیل اعداد فارسی به انگلیسی
        function convertToEnglish(numStr) {
            if (!numStr) return "0";

            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];

            let result = numStr.toString();

            for (let i = 0; i < 10; i++) {
                const persianRegex = new RegExp(persianDigits[i], 'g');
                const arabicRegex = new RegExp(arabicDigits[i], 'g');
                result = result.replace(persianRegex, i);
                result = result.replace(arabicRegex, i);
            }

            result = result.replace(/[٬,]/g, '');
            result = result.replace(/\s/g, '');

            return result || "0";
        }

        // تابع فرمت عدد به فارسی
        function formatNumber(num) {
            if (!num || num === "0") return "۰";
            const numInt = parseInt(convertToEnglish(num));
            if (isNaN(numInt)) return "۰";
            return numInt.toLocaleString('fa-IR');
        }

        // تابع نمایش پیام
        function showMessage(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
                     style="z-index: 9999; max-width: 500px;" role="alert">
                    <i class="bi ${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            $('body').append(alertHtml);

            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }

        // رویداد کلیک روی چک‌باکس تایید
        $(document).on('click', '.verify-checkbox', function(e) {
            if ($('#isVerified').val() === 'true') {
                this.checked = !this.checked;
                return;
            }
            
            const checkbox = $(this);
            const itemType = checkbox.data('item-type');
            const itemId = checkbox.data('item-id') || checkbox.data('branch-id');
            const paymentType = checkbox.data('payment-type') || '';
            
            // پیدا کردن input مربوطه
            let userInput;
            if (itemType.includes('branch')) {
                userInput = $(`.user-amount-input[data-item-type="${itemType}"][data-branch-id="${itemId}"]`);
            } else {
                userInput = $(`.user-amount-input[data-item-type="${itemType}"][data-item-id="${itemId}"]`);
            }
            
            const calculatedAmount = parseFloat(userInput.data('calculated')) || 0;
            const userAmount = parseFloat(convertToEnglish(userInput.val())) || 0;
            
            // ذخیره داده‌ها برای مودال
            currentVerificationData = {
                checkbox: checkbox,
                userInput: userInput,
                itemType: itemType,
                itemId: itemId,
                paymentType: paymentType,
                calculatedAmount: calculatedAmount,
                userAmount: userAmount,
                date: $('#currentDate').val()
            };
            
            // نمایش مودال
            $('#modal-item-type').text(getItemTypeName(itemType));
            $('#modal-calculated-amount').text(formatNumber(calculatedAmount) + ' تومان');
            $('#modal-user-amount').text(formatNumber(userAmount) + ' تومان');
            
            // نمایش اختلاف اگر وجود دارد
            const difference = Math.abs(userAmount - calculatedAmount);
            if (difference > 0) {
                $('#modal-difference-section').show();
                $('#modal-difference').text(formatNumber(difference) + ' تومان');
            } else {
                $('#modal-difference-section').hide();
            }
            
            $('#verificationModal').modal('show');
            e.preventDefault();
        });

        // تابع دریافت نام نوع آیتم
        function getItemTypeName(type) {
            const types = {
                'branch_cash': 'نقدی شعبه',
                'branch_pos': 'پوز شعبه',
                'investment': 'سرمایه‌گذاری',
                'cheque': 'چک',
                'credit': 'نسیه'
            };
            return types[type] || type;
        }

        // تایید از مودال
        $('#confirmVerification').click(function() {
            if (!currentVerificationData) return;
            
            const data = {
                item_type: currentVerificationData.itemType,
                item_id: currentVerificationData.itemId,
                payment_type: currentVerificationData.paymentType || '',
                calculated_amount: currentVerificationData.calculatedAmount,
                user_amount: currentVerificationData.userAmount,
                reason: $('#modal-reason').val(),
                date: currentVerificationData.date
            };
            
            // ارسال درخواست AJAX به verify_item
            $.ajax({
                url: '{% url "cash_management:verify_item" %}',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        // غیرفعال کردن input و checkbox
                        currentVerificationData.userInput.prop('disabled', true);
                        currentVerificationData.checkbox.prop('checked', true).prop('disabled', true);
                        
                        // به‌روزرسانی وضعیت
                        let statusElement;
                        if (currentVerificationData.itemType.includes('branch')) {
                            const statusId = currentVerificationData.itemType.replace('branch_', '');
                            statusElement = $(`#status-${statusId}-${currentVerificationData.itemId}`);
                            if (statusElement.length) {
                                statusElement.html(`
                                    <span class="verification-badge">
                                        <i class="bi bi-check-circle"></i>
                                        تایید شده
                                    </span>
                                `);
                            }
                        }
                        
                        showMessage('آیتم با موفقیت تایید شد');
                    } else {
                        showMessage('خطا: ' + response.error, 'danger');
                        currentVerificationData.checkbox.prop('checked', false);
                    }
                },
                error: function() {
                    showMessage('خطا در ارتباط با سرور', 'danger');
                    currentVerificationData.checkbox.prop('checked', false);
                }
            });
            
            $('#verificationModal').modal('hide');
            $('#modal-reason').val('');
            currentVerificationData = null;
        });

        // فرمت اعداد هنگام تایپ
        $(document).on('input', '.user-amount-input', function() {
            let value = $(this).val();
            value = convertToEnglish(value);
            $(this).val(value);
        });

        // فرمت اعداد هنگام از دست دادن فوکوس
        $(document).on('blur', '.user-amount-input', function() {
            let value = $(this).val();
            if (value) {
                value = formatNumber(value);
                $(this).val(value);
            }
        });

        // تابع انصراف
        function cancelChanges() {
            if (confirm('آیا از انصراف مطمئن هستید؟ تغییرات ذخیره نشده از بین می‌روند.')) {
                window.location.href = "{% url 'cash_management:calendar' %}";
            }
        }

        // تابع تایید نهایی روز
        function finalizeDay() {
            if (!confirm('آیا از تایید نهایی این روز مطمئن هستید؟ پس از تایید، امکان ویرایش وجود نخواهد داشت و اطلاعات در صندوق ثبت می‌شوند.')) {
                return;
            }
            
            const data = {
                date: $('#currentDate').val()
            };
            
            $.ajax({
                url: '{% url "cash_management:finalize_day" %}',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        showMessage('روز با موفقیت تایید و در صندوق ثبت شد');
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showMessage('خطا: ' + response.error, 'danger');
                    }
                },
                error: function() {
                    showMessage('خطا در ارتباط با سرور', 'danger');
                }
            });
        }

        // فرمت اعداد هنگام لود صفحه
        $(document).ready(function() {
            $('.user-amount-input').each(function() {
                const value = $(this).val();
                if (value) {
                    $(this).val(formatNumber(value));
                }
            });
        });
    </script>



</body>
</html>
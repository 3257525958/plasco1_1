{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ù…Ø±Ø¬ÙˆØ¹ Ú©Ø§Ù„Ø§</title>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    
    <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ Ùˆ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* ğŸ”´ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† Ø§Ø³ØªØ§ÛŒÙ„ daily_invoices.html */
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --blue-light: #e3f2fd;
            --blue-dark: #2196f3;
            --orange: #FF9800;
            --orange-light: #ffe0b2;
            --red-light: #ffebee;
            --red-dark: #d32f2f;
            --green-light: #e8f5e9;
            --green-dark: #2E7D32;
            --purple-light: #f3e5f5;
            --purple-dark: #7b1fa2;
            --yellow-light: #fff9c4;
            --yellow-dark: #f9a825;
            
            /* Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª */
            --cash-color: #27ae60;
            --cash-bg: #d5f4e6;
            --pos-color: #2980b9;
            --pos-bg: #d6eaf8;
            --check-color: #d35400;
            --check-bg: #fdebd0;
            --credit-color: #8e44ad;
            --credit-bg: #e8daef;
            --total-color: #16a085;
            --total-bg: #d1f2eb;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            direction: rtl;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        /* ÙÛŒÙ„ØªØ±Ù‡Ø§ */
        .filter-section {
            background-color: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            flex-grow: 1;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .filter-input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: white;
            transition: all 0.3s;
            min-width: 150px;
            height: 38px;
        }

        .date-filter-container {
            position: relative;
        }

        .shamsi-date-input {
            width: 160px;
            padding: 8px 12px;
            padding-right: 35px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--input-bg);
            text-align: center;
            cursor: pointer;
            font-family: 'Vazirmatn', sans-serif;
            height: 38px;
        }

        .calendar-icon {
            position: absolute;
            left: 10px;
            color: var(--primary-color);
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-decoration: none;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--blue-dark);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--green-dark);
            color: white;
        }

        .btn-success:hover {
            background-color: #1b5e20;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--red-dark);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c62828;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--orange);
            color: white;
        }

        .btn-warning:hover {
            background-color: #f57c00;
            transform: translateY(-2px);
        }

        /* Ø¬Ø¯ÙˆÙ„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .invoices-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .invoices-table th {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px;
            text-align: center;
            position: sticky;
            top: 0;
            white-space: nowrap;
            z-index: 10;
        }

        .invoices-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: center;
            vertical-align: middle;
        }

        .invoices-table tr:nth-child(even) {
            background-color: var(--light-bg);
        }

        .invoices-table tr:hover {
            background-color: #e8f5e9;
            transition: background-color 0.2s;
        }

        .invoice-row {
            cursor: pointer;
        }

        .invoice-row.selected {
            background-color: #e3f2fd !important;
            border-left: 4px solid var(--blue-dark);
        }

        /* Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ */
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table th {
            background-color: var(--green-dark);
            color: white;
            padding: 10px;
            text-align: center;
        }

        .items-table td {
            padding: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .item-row.selected {
            background-color: #e8f5e9 !important;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .paid {
            background-color: var(--green-light);
            color: var(--green-dark);
            border: 1px solid var(--green-dark);
        }

        .unpaid {
            background-color: var(--red-light);
            color: var(--red-dark);
            border: 1px solid var(--red-dark);
        }

        /* Ù…ÙˆØ¯Ø§Ù„ */
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ø¢Ù…Ø§Ø± */
        .stats-card {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-right: 4px solid var(--primary-color);
            margin-bottom: 10px;
        }

        .stats-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .stats-label {
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-undo-alt"></i> Ø³ÛŒØ³ØªÙ… Ù…Ø±Ø¬ÙˆØ¹ Ú©Ø§Ù„Ø§</h1>
            <p>Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§Ú©ØªÙˆØ± Ùˆ Ù…Ø±Ø¬ÙˆØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</p>
        </div>

        <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
        <div class="filter-section">
            <div class="filter-controls">
                <div class="filter-item">
                    <span class="filter-label"><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÛŒØ®:</span>
                    <div class="date-filter-container">
                        <input type="text" id="date-filter" class="shamsi-date-input"
                               placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®"
                               value="{{ today_jalali }}">
                        <i class="fas fa-calendar-alt calendar-icon" id="calendar-trigger"></i>
                    </div>
                </div>

                <div class="filter-item">
                    <span class="filter-label"><i class="fas fa-store"></i> Ø´Ø¹Ø¨Ù‡:</span>
                    <select id="branch-filter" class="filter-input">
                        <option value="all">Ù‡Ù…Ù‡ Ø´Ø¹Ø¨Ù‡â€ŒÙ‡Ø§</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-actions">
                    <button id="search-btn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Ø¬Ø³ØªØ¬Ùˆ
                    </button>
                    <button id="refresh-btn" class="btn btn-success">
                        <i class="fas fa-sync-alt"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø¢Ù…Ø§Ø± -->
        <div class="row" id="stats-section" style="display: none;">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-value" id="total-invoices">0</div>
                    <div class="stats-label">ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-value" id="selected-items">0</div>
                    <div class="stats-label">Ø¢ÛŒØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-value" id="total-return">0</div>
                    <div class="stats-label">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø¬ÙˆØ¹</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-value" id="return-amount">0</div>
                    <div class="stats-label">Ù…Ø¨Ù„Øº Ù…Ø±Ø¬ÙˆØ¹</div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-file-invoice me-2"></i>
                        ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®: <span id="selected-date">{{ today_jalali }}</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="invoices-table">
                                <thead>
                                    <tr>
                                        <th width="50">#</th>
                                        <th>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</th>
                                        <th>Ø´Ø¹Ø¨Ù‡</th>
                                        <th>Ù…Ø´ØªØ±ÛŒ</th>
                                        <th>Ù…Ø¨Ù„Øº</th>
                                        <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-body">
                                    <!-- ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                                    <tr>
                                        <td colspan="6" class="text-center py-5">
                                            <i class="fas fa-file-invoice fa-2x text-muted mb-3"></i>
                                            <p class="text-muted">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ØŒ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-boxes me-2"></i>
                        Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±: <span id="selected-invoice">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="invoice-info" class="p-3" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small><i class="fas fa-user"></i> Ù…Ø´ØªØ±ÛŒ: <span id="invoice-customer"></span></small><br>
                                        <small><i class="fas fa-phone"></i> ØªÙ„ÙÙ†: <span id="invoice-phone"></span></small>
                                    </div>
                                    <div class="col-md-6">
                                        <small><i class="fas fa-credit-card"></i> Ù¾Ø±Ø¯Ø§Ø®Øª: <span id="invoice-payment"></span></small><br>
                                        <small><i class="fas fa-calendar"></i> ØªØ§Ø±ÛŒØ®: <span id="invoice-date"></span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th width="30">
                                            <input type="checkbox" id="select-all-items">
                                        </th>
                                        <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
                                        <th>ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯</th>
                                        <th>Ù‚ÛŒÙ…Øª</th>
                                        <th>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø¬ÙˆØ¹</th>
                                    </tr>
                                </thead>
                                <tbody id="items-body">
                                    <!-- Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="no-items" class="text-center py-5">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <div>
                        <button id="process-return-btn" class="btn btn-danger" disabled>
                            <i class="fas fa-undo-alt me-2"></i> Ø«Ø¨Øª Ù…Ø±Ø¬ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒÙ‡Ø§
                        </button>
                        <button id="select-all-btn" class="btn btn-outline-primary">
                            <i class="fas fa-check-double me-2"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
                        </button>
                        <button id="deselect-all-btn" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i> Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨
                        </button>
                    </div>
                    <div>
                        <button id="show-logs-btn" class="btn btn-outline-info">
                            <i class="fas fa-history me-2"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø±Ø¬ÙˆØ¹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÛŒÛŒØ¯ Ù…Ø±Ø¬ÙˆØ¹ -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        ØªØ£ÛŒÛŒØ¯ Ù…Ø±Ø¬ÙˆØ¹ Ú©Ø§Ù„Ø§
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        Ø¢ÛŒØ§ Ø§Ø² Ù…Ø±Ø¬ÙˆØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ
                    </div>
                    
                    <div id="return-summary">
                        <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</strong> <span id="modal-item-count">0</span></p>
                        <p><strong>Ù…Ø¬Ù…ÙˆØ¹ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø¬ÙˆØ¹:</strong> <span id="modal-total-quantity">0</span> Ø¹Ø¯Ø¯</p>
                        <p><strong>ÙØ§Ú©ØªÙˆØ±:</strong> <span id="modal-invoice-number"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="return-reason" class="form-label">Ø¯Ù„ÛŒÙ„ Ù…Ø±Ø¬ÙˆØ¹ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                        <textarea id="return-reason" class="form-control" rows="2" 
                                  placeholder="Ø¯Ù„ÛŒÙ„ Ù…Ø±Ø¬ÙˆØ¹ Ú©Ø§Ù„Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i> Ø§Ù†ØµØ±Ø§Ù
                    </button>
                    <button type="button" class="btn btn-danger" id="confirm-return-btn">
                        <i class="fas fa-check me-2"></i> ØªØ£ÛŒÛŒØ¯ Ù…Ø±Ø¬ÙˆØ¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ global
        let selectedInvoiceId = null;
        let selectedItems = {};
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ loading
        function showLoading() {
            $('#loading-overlay').fadeIn();
        }
        
        function hideLoading() {
            $('#loading-overlay').fadeOut();
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¯Ø§Ø¯
        function formatNumber(num) {
            if (!num) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
        function searchInvoices() {
            const date = $('#date-filter').val().trim();
            const branchId = $('#branch-filter').val();
            
            if (!date) {
                alert('Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            showLoading();
            
            $.ajax({
                url: "{% url 'invoice_app:get_invoices_by_date' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    date: date,
                    branch_id: branchId
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.status === 'success') {
                        displayInvoices(response.invoices);
                        $('#selected-date').text(date);
                        $('#stats-section').show();
                        $('#total-invoices').text(formatNumber(response.count));
                        
                        // Ø±ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§
                        selectedInvoiceId = null;
                        selectedItems = {};
                        updateStats();
                        updateProcessButton();
                        clearItemsTable();
                    } else {
                        alert('Ø®Ø·Ø§: ' + response.message);
                    }
                },
                error: function() {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§');
                },
                complete: function() {
                    hideLoading();
                }
            });
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
        function displayInvoices(invoices) {
            const $tbody = $('#invoices-body');
            $tbody.empty();
            
            if (invoices.length === 0) {
                $tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-file-invoice fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                        </td>
                    </tr>
                `);
                return;
            }
            
            invoices.forEach((invoice, index) => {
                const isSelected = invoice.id === selectedInvoiceId;
                const paidStatus = invoice.is_paid ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡';
                const paidClass = invoice.is_paid ? 'paid' : 'unpaid';
                
                const row = `
                    <tr class="invoice-row ${isSelected ? 'selected' : ''}" 
                        onclick="selectInvoice(${invoice.id})"
                        style="cursor: pointer;">
                        <td>${index + 1}</td>
                        <td>
                            <strong>${invoice.serial_number}</strong>
                        </td>
                        <td>${invoice.branch_name}</td>
                        <td>${invoice.customer_name}</td>
                        <td>${formatNumber(invoice.total_amount)}</td>
                        <td>
                            <span class="status-badge ${paidClass}">${paidStatus}</span>
                        </td>
                    </tr>
                `;
                $tbody.append(row);
            });
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§Ú©ØªÙˆØ±
        function selectInvoice(invoiceId) {
            if (selectedInvoiceId === invoiceId) return;
            
            selectedInvoiceId = invoiceId;
            selectedItems = {};
            
            // Ø¢Ù¾Ø¯ÛŒØª Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ selected
            $('.invoice-row').removeClass('selected');
            $(`[onclick="selectInvoice(${invoiceId})"]`).addClass('selected');
            
            // Ù„ÙˆØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±
            loadInvoiceItems(invoiceId);
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±
        function loadInvoiceItems(invoiceId) {
            showLoading();
            
            $.ajax({
                url: `/invoice/api/get-invoice-items/${invoiceId}/`,
                method: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        displayInvoiceItems(response.invoice, response.items);
                        updateStats();
                    } else {
                        alert('Ø®Ø·Ø§: ' + response.message);
                    }
                },
                error: function() {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±');
                },
                complete: function() {
                    hideLoading();
                }
            });
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±
        function displayInvoiceItems(invoice, items) {
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±
            $('#invoice-info').show();
            $('#selected-invoice').text(invoice.serial_number);
            $('#invoice-customer').text(invoice.customer_name);
            $('#invoice-phone').text(invoice.customer_phone || '-');
            $('#invoice-payment').text(invoice.payment_method);
            $('#invoice-date').text(invoice.created_at);
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
            const $tbody = $('#items-body');
            const $noItems = $('#no-items');
            
            $tbody.empty();
            $noItems.hide();
            
            if (items.length === 0) {
                $noItems.show();
                return;
            }
            
            items.forEach((item, index) => {
                const isSelected = selectedItems[item.id] || false;
                const returnQuantity = isSelected ? selectedItems[item.id].quantity : 0;
                
                const row = `
                    <tr class="item-row ${isSelected ? 'selected' : ''}">
                        <td>
                            <input type="checkbox" class="item-checkbox" 
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleItemSelection(${item.id}, ${item.quantity})">
                        </td>
                        <td>${item.product_name}</td>
                        <td>${formatNumber(item.quantity)}</td>
                        <td>${formatNumber(item.price)}</td>
                        <td>
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   min="0" 
                                   max="${item.quantity}"
                                   value="${returnQuantity}"
                                   onchange="updateReturnQuantity(${item.id}, this.value, ${item.quantity})"
                                   ${isSelected ? '' : 'disabled'}
                                   style="width: 80px; display: inline-block;">
                        </td>
                    </tr>
                `;
                $tbody.append(row);
            });
            
            // Ø¢Ù¾Ø¯ÛŒØª select all
            const allSelected = Object.keys(selectedItems).length === items.length;
            $('#select-all-items').prop('checked', allSelected);
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
        function clearItemsTable() {
            $('#items-body').empty();
            $('#no-items').show();
            $('#invoice-info').hide();
            $('#selected-invoice').text('Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ toggle Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒØªÙ…
        function toggleItemSelection(itemId, maxQuantity) {
            if (selectedItems[itemId]) {
                delete selectedItems[itemId];
            } else {
                selectedItems[itemId] = { quantity: 1 };
            }
            
            updateRowSelection(itemId);
            updateStats();
            updateProcessButton();
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø±Ø¯ÛŒÙ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
        function updateRowSelection(itemId) {
            const $row = $(`.item-checkbox[onchange*="${itemId}"]`).closest('tr');
            const $input = $row.find('input[type="number"]');
            
            if (selectedItems[itemId]) {
                $row.addClass('selected');
                $row.find('.item-checkbox').prop('checked', true);
                $input.prop('disabled', false);
            } else {
                $row.removeClass('selected');
                $row.find('.item-checkbox').prop('checked', false);
                $input.prop('disabled', true).val(0);
            }
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø¬ÙˆØ¹
        function updateReturnQuantity(itemId, quantity, maxQuantity) {
            quantity = parseInt(quantity) || 0;
            
            if (quantity < 0) quantity = 0;
            if (quantity > maxQuantity) quantity = maxQuantity;
            
            if (quantity === 0) {
                delete selectedItems[itemId];
                updateRowSelection(itemId);
            } else {
                selectedItems[itemId] = { quantity: quantity };
            }
            
            updateStats();
            updateProcessButton();
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
        function selectAllItems() {
            const $items = $('#items-body tr');
            
            $items.each(function() {
                const itemId = parseInt($(this).find('.item-checkbox').attr('onchange').match(/\d+/)[0]);
                const maxQuantity = parseInt($(this).find('input[type="number"]').attr('max'));
                
                if (!selectedItems[itemId]) {
                    selectedItems[itemId] = { quantity: 1 };
                    $(this).addClass('selected');
                    $(this).find('.item-checkbox').prop('checked', true);
                    $(this).find('input[type="number"]').prop('disabled', false).val(1);
                }
            });
            
            $('#select-all-items').prop('checked', true);
            updateStats();
            updateProcessButton();
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
        function deselectAllItems() {
            const $items = $('#items-body tr');
            
            $items.each(function() {
                const itemId = parseInt($(this).find('.item-checkbox').attr('onchange').match(/\d+/)[0]);
                
                delete selectedItems[itemId];
                $(this).removeClass('selected');
                $(this).find('.item-checkbox').prop('checked', false);
                $(this).find('input[type="number"]').prop('disabled', true).val(0);
            });
            
            $('#select-all-items').prop('checked', false);
            updateStats();
            updateProcessButton();
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
        function updateStats() {
            const selectedCount = Object.keys(selectedItems).length;
            let totalReturnQuantity = 0;
            
            Object.values(selectedItems).forEach(item => {
                totalReturnQuantity += item.quantity;
            });
            
            $('#selected-items').text(formatNumber(selectedCount));
            $('#total-return').text(formatNumber(totalReturnQuantity));
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´
        function updateProcessButton() {
            const selectedCount = Object.keys(selectedItems).length;
            $('#process-return-btn').prop('disabled', selectedCount === 0 || !selectedInvoiceId);
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÛŒÛŒØ¯
        function showConfirmModal() {
            if (!selectedInvoiceId || Object.keys(selectedItems).length === 0) {
                alert('Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø¬ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            let totalQuantity = 0;
            Object.values(selectedItems).forEach(data => {
                totalQuantity += data.quantity;
            });
            
            $('#modal-item-count').text(formatNumber(Object.keys(selectedItems).length));
            $('#modal-total-quantity').text(formatNumber(totalQuantity));
            
            const $selectedInvoice = $('.invoice-row.selected');
            const invoiceNumber = $selectedInvoice.find('td:nth-child(2)').text().trim();
            $('#modal-invoice-number').text(invoiceNumber);
            
            $('#confirmModal').modal('show');
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Event Listeners
        $(document).ready(function() {
            // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ…
            $("#date-filter").persianDatepicker({
                observer: true,
                format: 'YYYY/MM/DD',
                autoClose: true,
                initialValue: false,
                initialValueType: 'persian'
            });
            
            $('#calendar-trigger').click(function() {
                $('#date-filter').persianDatepicker('show');
            });
            
            // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            $('#search-btn').click(searchInvoices);
            
            $('#refresh-btn').click(function() {
                searchInvoices();
            });
            
            $('#select-all-btn').click(selectAllItems);
            $('#deselect-all-btn').click(deselectAllItems);
            
            $('#select-all-items').change(function() {
                if ($(this).is(':checked')) {
                    selectAllItems();
                } else {
                    deselectAllItems();
                }
            });
            
            $('#process-return-btn').click(showConfirmModal);
            
            // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
            searchInvoices();
        });
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø±Ø¬ÙˆØ¹
function processReturn() {
    const reason = $('#return-reason').val();
    
    // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¬ÙˆØ¹
    const returnItems = [];
    
    Object.entries(selectedItems).forEach(([itemId, data]) => {
        returnItems.push({
            item_id: parseInt(itemId),
            return_quantity: data.quantity
        });
    });
    
    console.log('ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¬ÙˆØ¹:', {
        invoice_id: selectedInvoiceId,
        return_items: returnItems,
        return_reason: reason
    });
    
    showLoading();
    
    $.ajax({
        url: "{% url 'invoice_app:process_return' %}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            invoice_id: selectedInvoiceId,
            return_items: returnItems,
            return_reason: reason
        }),
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            console.log('ğŸ“¥ Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:', response);
            
            if (response.status === 'success') {
                $('#confirmModal').modal('hide');
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                alert('âœ… ' + response.message);
                
                if (response.invoice_deleted) {
                    // Ø§Ú¯Ø± ÙØ§Ú©ØªÙˆØ± Ø­Ø°Ù Ø´Ø¯
                    selectedInvoiceId = null;
                    selectedItems = {};
                    clearItemsTable();
                    
                    // Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ù„ÛŒØ³Øª
                    $(`.invoice-row[onclick*="${selectedInvoiceId}"]`).remove();
                } else {
                    // Ø§Ú¯Ø± ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯
                    // Ø±ÛŒÙØ±Ø´ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
                    loadInvoiceItems(selectedInvoiceId);
                }
                
                // Ø±ÛŒØ³Øª ÙØ±Ù…
                $('#return-reason').val('');
                selectedItems = {};
                updateStats();
                updateProcessButton();
                
                // Ø±ÛŒÙØ±Ø´ Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
                searchInvoices();
                
            } else {
                alert('âŒ ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ Ø®Ø·Ø§ÛŒ AJAX:', xhr.responseText);
            
            let errorMsg = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø±Ø¬ÙˆØ¹';
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.message) {
                    errorMsg = response.message;
                }
            } catch (e) {
                errorMsg = xhr.statusText;
            }
            
            alert('âŒ ' + errorMsg);
        },
        complete: function() {
            hideLoading();
        }
    });
}

// Event listener Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ ØªØ£ÛŒÛŒØ¯
$(document).ready(function() {
    // ... Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ ...
    
    $('#confirm-return-btn').click(processReturn);
    
    // Ù‡Ù…Ú†Ù†ÛŒÙ† Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Enter Ø¯Ø± textarea
    $('#return-reason').keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            processReturn();
        }
    });
});
    </script>
</body>
</html>
{#{% load static %}#}
{#<!DOCTYPE html>#}
{#<html lang="fa" dir="rtl">#}
{#<head>#}
{#    <meta charset="UTF-8">#}
{#    <meta name="viewport" content="width=device-width, initial-scale=1.0">#}
{#    <title>ویرایش فاکتور - فروشگاه پلاستیک و لوازم آشپرخانه موسوی</title>#}
{##}
{#    <!-- فونت‌ها و آیکون‌ها -->#}
{#    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">#}
{#    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">#}
{##}
{#    <!-- کتابخانه‌های تاریخ شمسی -->#}
{#    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">#}
{##}
{#    <style>#}
{#        :root {#}
{#            --primary-color: #4CAF50;#}
{#            --secondary-color: #388E3C;#}
{#            --accent-color: #2E7D32;#}
{#            --text-color: #2c3e50;#}
{#            --light-bg: #f9f9f9;#}
{#            --border-color: #ddd;#}
{#            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);#}
{#            --input-bg: #f1f8e9;#}
{#        }#}
{##}
{#        * {#}
{#            box-sizing: border-box;#}
{#            margin: 0;#}
{#            padding: 0;#}
{#            font-family: 'Vazirmatn', sans-serif;#}
{#        }#}
{##}
{#        body {#}
{#            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);#}
{#            min-height: 100vh;#}
{#            padding: 20px;#}
{#            color: var(--text-color);#}
{#            direction: rtl;#}
{#        }#}
{##}
{#        .edit-invoice-container {#}
{#            max-width: 1400px;#}
{#            margin: 0 auto;#}
{#            background: white;#}
{#            border-radius: 20px;#}
{#            overflow: hidden;#}
{#            box-shadow: var(--shadow);#}
{#            padding: 30px;#}
{#        }#}
{##}
{#        .header-section {#}
{#            display: flex;#}
{#            justify-content: space-between;#}
{#            align-items: flex-start;#}
{#            margin-bottom: 30px;#}
{#            padding-bottom: 20px;#}
{#            border-bottom: 2px solid var(--border-color);#}
{#            flex-wrap: wrap;#}
{#            gap: 20px;#}
{#        }#}
{##}
{#        .search-section {#}
{#            margin-bottom: 20px;#}
{#            position: relative;#}
{#        }#}
{##}
{#        .search-container {#}
{#            position: relative;#}
{#        }#}
{##}
{#        .search-label {#}
{#            display: block;#}
{#            margin-bottom: 8px;#}
{#            font-size: 16px;#}
{#            color: #555;#}
{#            font-weight: bold;#}
{#        }#}
{##}
{#        .search-input {#}
{#            width: 100%;#}
{#            padding: 12px 45px 12px 12px;#}
{#            font-size: 16px;#}
{#            border: 2px solid var(--primary-color);#}
{#            border-radius: 8px;#}
{#            transition: all 0.3s;#}
{#            background: var(--input-bg);#}
{#        }#}
{##}
{#        .search-input:focus {#}
{#            border-color: var(--accent-color);#}
{#            box-shadow: 0 0 8px rgba(46, 125, 50, 0.3);#}
{#            outline: none;#}
{#        }#}
{##}
{#        .search-btn {#}
{#            position: absolute;#}
{#            left: 12px;#}
{#            top: 50%;#}
{#            transform: translateY(-50%);#}
{#            background: none;#}
{#            border: none;#}
{#            color: var(--primary-color);#}
{#            font-size: 18px;#}
{#            cursor: pointer;#}
{#        }#}
{##}
{#        .search-hint {#}
{#            margin-top: 5px;#}
{#            font-size: 14px;#}
{#            color: #666;#}
{#            line-height: 1.4;#}
{#        }#}
{##}
{#        /* استایل اصلی برای لیست نتایج جستجو */#}
{#        .search-results {#}
{#            border: 1px solid var(--border-color);#}
{#            border-radius: 5px;#}
{#            max-height: 500px;#}
{#            min-height: 300px;#}
{#            overflow-y: auto;#}
{#            margin-top: 8px;#}
{#            background: white;#}
{#            box-shadow: 0 4px 8px rgba(0,0,0,0.1);#}
{#            display: none;#}
{#            z-index: 1000;#}
{#            position: absolute;#}
{#            width: 100%;#}
{#        }#}
{##}
{#        .search-result-item {#}
{#            padding: 12px;#}
{#            cursor: pointer;#}
{#            border-bottom: 1px solid var(--border-color);#}
{#            transition: background 0.2s;#}
{#            line-height: 1.5;#}
{#        }#}
{##}
{#        .search-result-item:hover {#}
{#            background-color: var(--light-bg);#}
{#        }#}
{##}
{#        .search-result-item:last-child {#}
{#            border-bottom: none;#}
{#        }#}
{##}
{#        .invoice-header {#}
{#            display: flex;#}
{#            justify-content: space-between;#}
{#            align-items: center;#}
{#            margin-bottom: 8px;#}
{#        }#}
{##}
{#        .invoice-number {#}
{#            color: var(--primary-color);#}
{#            font-size: 16px;#}
{#            font-weight: bold;#}
{#        }#}
{##}
{#        .invoice-date {#}
{#            color: #666;#}
{#            font-size: 14px;#}
{#            background: #f0f0f0;#}
{#            padding: 2px 6px;#}
{#            border-radius: 4px;#}
{#        }#}
{##}
{#        .invoice-details {#}
{#            font-size: 14px;#}
{#        }#}
{##}
{#        .seller-info, .store-info, .products-info {#}
{#            margin-bottom: 4px;#}
{#            display: flex;#}
{#            align-items: center;#}
{#            color: #555;#}
{#        }#}
{##}
{#        .seller-info i, .store-info i, .products-info i {#}
{#            margin-left: 8px;#}
{#            color: var(--primary-color);#}
{#            width: 16px;#}
{#            text-align: center;#}
{#        }#}
{##}
{#        .products-info {#}
{#            color: #777;#}
{#            font-size: 13px;#}
{#            background: #f8f8f8;#}
{#            padding: 4px 8px;#}
{#            border-radius: 4px;#}
{#            margin-top: 4px;#}
{#        }#}
{##}
{#        .invoice-details {#}
{#            display: none;#}
{#            margin-top: 20px;#}
{#        }#}
{##}
{#        .invoice-info {#}
{#            background: #f9f9f9;#}
{#            padding: 15px;#}
{#            border-radius: 8px;#}
{#            margin-bottom: 20px;#}
{#        }#}
{##}
{#        .info-item {#}
{#            margin-bottom: 10px;#}
{#            padding: 8px;#}
{#            background-color: #f8f9fa;#}
{#            border-radius: 5px;#}
{#        }#}
{##}
{#        /* استایل‌های جدید برای جستجوی کالا */#}
{#        .product-search-container {#}
{#            position: relative;#}
{#            width: 100%;#}
{#        }#}
{#        #}
{#        .product-search-input {#}
{#            width: 100%;#}
{#            padding: 12px 15px;#}
{#            border: 1px solid var(--border-color);#}
{#            border-radius: 8px;#}
{#            font-size: 16px;#}
{#            background: white;#}
{#        }#}
{#        #}
{#        .product-search-input:focus {#}
{#            border-color: var(--primary-color);#}
{#            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);#}
{#            outline: none;#}
{#        }#}
{#        #}
{#        .product-search-results {#}
{#            position: absolute;#}
{#            top: 100%;#}
{#            left: 0;#}
{#            right: 0;#}
{#            background: white;#}
{#            border: 2px solid var(--primary-color);#}
{#            border-radius: 8px;#}
{#            box-shadow: 0 6px 15px rgba(0,0,0,0.15);#}
{#            z-index: 1003;#}
{#            display: none;#}
{#            max-height: 300px;#}
{#            overflow-y: auto;#}
{#            margin-top: 5px;#}
{#        }#}
{#        #}
{#        .product-search-result-item {#}
{#            padding: 12px 15px;#}
{#            border-bottom: 1px solid #eee;#}
{#            cursor: pointer;#}
{#            transition: background 0.3s;#}
{#            font-size: 16px;#}
{#            text-align: right;#}
{#        }#}
{#        #}
{#        .product-search-result-item:hover {#}
{#            background-color: #f1f8e9;#}
{#        }#}
{#        #}
{#        .product-search-result-item.new-product {#}
{#            color: #28a745;#}
{#            font-weight: bold;#}
{#        }#}
{#        #}
{#        .product-search-result-item.error {#}
{#            color: #dc3545;#}
{#        }#}
{#        #}
{#        .search-loading {#}
{#            padding: 15px;#}
{#            text-align: center;#}
{#            color: var(--primary-color);#}
{#        }#}
{#        #}
{#        .search-loading i {#}
{#            margin-left: 8px;#}
{#        }#}
{##}
{#        /* استایل برای تضمین نمایش صحیح تقویم */#}
{#        .pdatepicker-gui {#}
{#            z-index: 10000 !important;#}
{#            font-family: 'Vazirmatn', sans-serif !important;#}
{#        }#}
{##}
{#        .pdatepicker-gui .pdatepicker-day {#}
{#            cursor: pointer !important;#}
{#        }#}
{##}
{#        .invoice-table {#}
{#            width: 100%;#}
{#            border-collapse: collapse;#}
{#            margin: 25px 0;#}
{#            box-shadow: 0 0 10px rgba(0,0,0,0.05);#}
{#        }#}
{##}
{#        .invoice-table th {#}
{#            background-color: var(--primary-color);#}
{#            color: white;#}
{#            padding: 15px;#}
{#            text-align: center;#}
{#            font-size: 18px;#}
{#        }#}
{##}
{#        .invoice-table td {#}
{#            padding: 12px 15px;#}
{#            border-bottom: 1px solid var(--border-color);#}
{#            text-align: center;#}
{#            vertical-align: middle;#}
{#        }#}
{##}
{#        .invoice-table input {#}
{#            width: 100%;#}
{#            padding: 12px 15px;#}
{#            border: 1px solid var(--border-color);#}
{#            border-radius: 8px;#}
{#            text-align: center;#}
{#            font-size: 18px;#}
{#            transition: all 0.3s;#}
{#        }#}
{##}
{#        .price-input {#}
{#            font-size: 20px !important;#}
{#            font-weight: bold;#}
{#            padding: 14px 15px !important;#}
{#            background-color: #f8fff8;#}
{#        }#}
{##}
{#        .line-total-input {#}
{#            font-size: 20px !important;#}
{#            font-weight: bold;#}
{#            padding: 14px 15px !important;#}
{#            background-color: #e8f5e9;#}
{#            border: 1px solid #4CAF50;#}
{#            cursor: not-allowed;#}
{#        }#}
{##}
{#        .price-words {#}
{#            font-size: 12px;#}
{#            color: #666;#}
{#            margin-top: 5px;#}
{#            text-align: center;#}
{#            direction: rtl;#}
{#            height: 20px;#}
{#            overflow: hidden;#}
{#            text-overflow: ellipsis;#}
{#            white-space: nowrap;#}
{#        }#}
{##}
{#        .invoice-summary {#}
{#            margin-top: 30px;#}
{#            padding: 20px;#}
{#            background-color: #f9f9f9;#}
{#            border-radius: 10px;#}
{#            border: 1px solid #ddd;#}
{#        }#}
{##}
{#        .summary-item {#}
{#            display: flex;#}
{#            justify-content: space-between;#}
{#            margin-bottom: 10px;#}
{#            font-size: 18px;#}
{#        }#}
{##}
{#        .summary-item.total-payable {#}
{#            font-weight: bold;#}
{#            font-size: 20px;#}
{#            color: #2E7D32;#}
{#            border-top: 2px solid #ddd;#}
{#            padding-top: 10px;#}
{#            margin-top: 10px;#}
{#        }#}
{##}
{#        .actions {#}
{#            display: flex;#}
{#            justify-content: flex-end;#}
{#            gap: 15px;#}
{#            margin-top: 20px;#}
{#            flex-wrap: wrap;#}
{#        }#}
{##}
{#        .btn {#}
{#            padding: 14px 30px;#}
{#            border: none;#}
{#            border-radius: 50px;#}
{#            font-size: 18px;#}
{#            font-weight: bold;#}
{#            cursor: pointer;#}
{#            display: flex;#}
{#            align-items: center;#}
{#            gap: 10px;#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .btn-primary {#}
{#            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));#}
{#            color: white;#}
{#            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);#}
{#        }#}
{##}
{#        .btn-secondary {#}
{#            background: #f5f5f5;#}
{#            color: var(--text-color);#}
{#            border: 1px solid var(--border-color);#}
{#        }#}
{##}
{#        .btn-danger {#}
{#            background: #f44336;#}
{#            color: white;#}
{#        }#}
{##}
{#        .btn-back {#}
{#            background: #9e9e9e;#}
{#            color: white;#}
{#        }#}
{##}
{#        .btn:hover {#}
{#            transform: translateY(-3px);#}
{#            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);#}
{#        }#}
{##}
{#        .btn:active {#}
{#            transform: translateY(0);#}
{#        }#}
{##}
{#        .error-message {#}
{#            color: #d32f2f;#}
{#            background-color: #ffebee;#}
{#            padding: 15px;#}
{#            border-radius: 8px;#}
{#            margin: 15px 0;#}
{#            border-left: 4px solid #d32f2f;#}
{#            font-size: 18px;#}
{#        }#}
{##}
{#        .success-message {#}
{#            color: #2E7D32;#}
{#            background-color: #e8f5e9;#}
{#            padding: 15px;#}
{#            border-radius: 8px;#}
{#            margin: 15px 0;#}
{#            border-left: 4px solid #2E7D32;#}
{#            font-size: 18px;#}
{#        }#}
{##}
{#        /* استایل برای وضعیت خالی */#}
{#        .empty-results {#}
{#            padding: 20px;#}
{#            text-align: center;#}
{#            color: #666;#}
{#            font-style: italic;#}
{#        }#}
{##}
{#        /* استایل برای اسکرول بار */#}
{#        .search-results::-webkit-scrollbar,#}
{#        .product-search-results::-webkit-scrollbar {#}
{#            width: 8px;#}
{#        }#}
{##}
{#        .search-results::-webkit-scrollbar-track,#}
{#        .product-search-results::-webkit-scrollbar-track {#}
{#            background: #f1f1f1;#}
{#            border-radius: 4px;#}
{#        }#}
{##}
{#        .search-results::-webkit-scrollbar-thumb,#}
{#        .product-search-results::-webkit-scrollbar-thumb {#}
{#            background: var(--primary-color);#}
{#            border-radius: 4px;#}
{#        }#}
{##}
{#        .search-results::-webkit-scrollbar-thumb:hover,#}
{#        .product-search-results::-webkit-scrollbar-thumb:hover {#}
{#            background: var(--accent-color);#}
{#        }#}
{##}
{#        /* استایل‌های مودال انتظار */#}
{#        .loading-modal {#}
{#            display: none;#}
{#            position: fixed;#}
{#            top: 0;#}
{#            left: 0;#}
{#            width: 100%;#}
{#            height: 100%;#}
{#            background-color: rgba(0, 0, 0, 0.8);#}
{#            z-index: 9999;#}
{#            justify-content: center;#}
{#            align-items: center;#}
{#            flex-direction: column;#}
{#            backdrop-filter: blur(5px);#}
{#        }#}
{##}
{#        .loading-content {#}
{#            background: white;#}
{#            padding: 40px;#}
{#            border-radius: 20px;#}
{#            text-align: center;#}
{#            max-width: 500px;#}
{#            width: 90%;#}
{#            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);#}
{#            animation: fadeIn 0.3s ease-out;#}
{#        }#}
{##}
{#        @keyframes fadeIn {#}
{#            from { opacity: 0; transform: translateY(-20px); }#}
{#            to { opacity: 1; transform: translateY(0); }#}
{#        }#}
{##}
{#        .loading-spinner {#}
{#            font-size: 48px;#}
{#            color: var(--primary-color);#}
{#            margin-bottom: 20px;#}
{#            animation: spin 1s linear infinite;#}
{#        }#}
{##}
{#        @keyframes spin {#}
{#            0% { transform: rotate(0deg); }#}
{#            100% { transform: rotate(360deg); }#}
{#        }#}
{##}
{#        .loading-message {#}
{#            font-size: 20px;#}
{#            color: var(--text-color);#}
{#            margin-bottom: 15px;#}
{#            font-weight: bold;#}
{#        }#}
{##}
{#        .loading-submessage {#}
{#            font-size: 16px;#}
{#            color: #666;#}
{#            margin-top: 10px;#}
{#        }#}
{##}
{#        /* استایل برای غیرفعال کردن صفحه */#}
{#        .page-disabled {#}
{#            pointer-events: none;#}
{#            opacity: 0.7;#}
{#            transition: opacity 0.3s;#}
{#        }#}
{##}
{#        /* استایل برای دکمه غیرفعال */#}
{#        .btn:disabled {#}
{#            opacity: 0.6;#}
{#            cursor: not-allowed;#}
{#            transform: none !important;#}
{#            box-shadow: none !important;#}
{#        }#}
{##}
{#        /* استایل برای حالت پردازش */#}
{#        .processing {#}
{#            pointer-events: none;#}
{#            opacity: 0.7;#}
{#        }#}
{##}
{#        @media (max-width: 768px) {#}
{#            .edit-invoice-container {#}
{#                padding: 15px;#}
{#                border-radius: 15px;#}
{#            }#}
{##}
{#            .invoice-table {#}
{#                display: block;#}
{#                width: 100%;#}
{#                overflow-x: auto;#}
{#                -webkit-overflow-scrolling: touch;#}
{#            }#}
{#            #}
{#            .invoice-table thead {#}
{#                display: none;#}
{#            }#}
{#            #}
{#            .invoice-table tbody {#}
{#                display: flex;#}
{#                flex-direction: column;#}
{#                gap: 15px;#}
{#            }#}
{#            #}
{#            .item-row {#}
{#                display: flex;#}
{#                flex-direction: column;#}
{#                border: 1px solid var(--border-color);#}
{#                border-radius: 10px;#}
{#                padding: 15px;#}
{#                background: #f9f9f9;#}
{#            }#}
{#            #}
{#            .invoice-table td {#}
{#                display: flex;#}
{#                flex-direction: column;#}
{#                padding: 10px 5px;#}
{#                border: none;#}
{#                text-align: right;#}
{#                width: 100% !important;#}
{#            }#}
{#            #}
{#            .invoice-table td::before {#}
{#                content: attr(data-label);#}
{#                font-weight: bold;#}
{#                margin-bottom: 8px;#}
{#                color: var(--primary-color);#}
{#                font-size: 16px;#}
{#            }#}
{##}
{#            .btn {#}
{#                padding: 12px 20px;#}
{#                font-size: 16px;#}
{#                width: 100%;#}
{#                justify-content: center;#}
{#                margin-bottom: 10px;#}
{#            }#}
{##}
{#            .actions {#}
{#                flex-direction: column-reverse;#}
{#                gap: 10px;#}
{#            }#}
{##}
{#            .search-results {#}
{#                min-height: 250px;#}
{#            }#}
{##}
{#            .invoice-header {#}
{#                flex-direction: column;#}
{#                align-items: flex-start;#}
{#                gap: 5px;#}
{#            }#}
{##}
{#            .invoice-date {#}
{#                align-self: flex-start;#}
{#            }#}
{#        }#}
{##}
{#        @media (max-width: 480px) {#}
{#            body {#}
{#                padding: 10px;#}
{#            }#}
{#            #}
{#            .edit-invoice-container {#}
{#                padding: 10px;#}
{#                border-radius: 10px;#}
{#            }#}
{#            #}
{#            .search-input, .product-search-input {#}
{#                padding: 10px;#}
{#                font-size: 14px;#}
{#            }#}
{#            #}
{#            .btn {#}
{#                padding: 10px 15px;#}
{#                font-size: 14px;#}
{#            }#}
{#            #}
{#            .invoice-table td {#}
{#                padding: 8px 0;#}
{#            }#}
{#        }#}
{#    </style>#}
{#</head>#}
{#<body>#}
{#    <div class="edit-invoice-container">#}
{#        <div class="header-section">#}
{#            <h1>ویرایش فاکتور</h1>#}
{#        </div>#}
{##}
{#        <div class="search-section">#}
{#            <div class="search-container">#}
{#                <label class="search-label">جستجوی فاکتور برای ویرایش:</label>#}
{#                <input type="text" id="edit-invoice-search" class="search-input" #}
{#                       placeholder="شماره فاکتور، نام فروشنده، نام خانوادگی، نام فروشگاه یا نام کالا...">#}
{#                <button type="button" class="search-btn">#}
{#                    <i class="fas fa-search"></i>#}
{#                </button>#}
{#                <div id="edit-invoice-search-results" class="search-results">#}
{#                    <div class="empty-results">برای جستجو، حداقل ۲ کاراکتر وارد کنید</div>#}
{#                </div>#}
{#            </div>#}
{#            <div class="search-hint">#}
{#                برای جستجو، حداقل ۲ کاراکتر وارد کنید - جستجو بر اساس: شماره فاکتور، نام فروشنده، نام خانوادگی، نام فروشگاه و نام کالا#}
{#            </div>#}
{#        </div>#}
{##}
{#        <div id="invoice-details" class="invoice-details">#}
{#            <h3>مشخصات فاکتور</h3>#}
{#            <div id="invoice-info" class="invoice-info">#}
{#                <!-- اطلاعات فاکتور اینجا نمایش داده می‌شود -->#}
{#            </div>#}
{##}
{#            <h3>لیست کالاهای فاکتور</h3>#}
{#            <table class="invoice-table">#}
{#                <thead>#}
{#                    <tr>#}
{#                        <th width="30%" data-label="نام کالا">نام کالا</th>#}
{#                        <th width="15%" data-label="قیمت خرید">قیمت خرید (تومان)</th>#}
{#                        <th width="10%" data-label="تعداد">تعداد</th>#}
{#                        <th width="15%" data-label="جمع کل">جمع کل (تومان)</th>#}
{#                        <th width="15%" data-label="تخفیف">تخفیف (تومان)</th>#}
{#                        <th width="15%" data-label="عملیات">عملیات</th>#}
{#                    </tr>#}
{#                </thead>#}
{#                <tbody id="invoice-items-list">#}
{#                    <!-- آیتم‌های فاکتور اینجا نمایش داده می‌شوند -->#}
{#                </tbody>#}
{#            </table>#}
{##}
{#            <button id="add-item-btn" class="btn btn-secondary">#}
{#                <i class="fas fa-plus"></i> اضافه کردن کالا#}
{#            </button>#}
{##}
{#            <div class="invoice-summary">#}
{#                <div class="summary-item">#}
{#                    <span>تعداد اقلام:</span>#}
{#                    <span id="total-items">0</span>#}
{#                </div>#}
{#                <div class="summary-item">#}
{#                    <span>جمع کل فاکتور:</span>#}
{#                    <span id="total-amount">0 تومان</span>#}
{#                </div>#}
{#                <div class="summary-item">#}
{#                    <span>تخفیف کل:</span>#}
{#                    <span id="total-discount">0 تومان</span>#}
{#                </div>#}
{#                <div class="summary-item total-payable">#}
{#                    <span>قابل پرداخت:</span>#}
{#                    <span id="final-amount">0 تومان</span>#}
{#                </div>#}
{#            </div>#}
{##}
{#            <div class="actions">#}
{#                <button id="edit-invoice-back-btn" class="btn btn-back">#}
{#                    <i class="fas fa-arrow-right"></i> بازگشت#}
{#                </button>#}
{#                <button id="edit-invoice-submit-btn" class="btn btn-primary">#}
{#                    <i class="fas fa-save"></i> ذخیره تغییرات#}
{#                </button>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <div id="messages"></div>#}
{#    </div>#}
{##}
{#    <!-- مودال انتظار -->#}
{#    <div id="loadingModal" class="loading-modal">#}
{#        <div class="loading-content">#}
{#            <div class="loading-spinner">#}
{#                <i class="fas fa-spinner"></i>#}
{#            </div>#}
{#            <div class="loading-message" id="loadingMessage">#}
{#                در حال ذخیره تغییرات...#}
{#            </div>#}
{#            <div class="loading-submessage">#}
{#                لطفاً منتظر بمانید#}
{#            </div>#}
{#            <div id="loadingProgress" style="margin-top: 20px; color: #666; font-size: 14px;">#}
{#                <!-- نمایش وضعیت پیشرفت -->#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{##}
{#    <!-- کتابخانه‌های JavaScript -->#}
{#    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>#}
{#    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>#}
{#    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>#}
{##}
{#    <script>#}
{#        // متغیرهای global برای مدیریت ویرایش فاکتور#}
{#        let editingInvoice = null;#}
{#        let editingInvoiceItems = [];#}
{#        let invoiceSearchTimeout = null;#}
{#        let isSubmitting = false; // برای جلوگیری از کلیک‌های مکرر#}
{#        #}
{#        // تابع تبدیل اعداد فارسی و عربی به انگلیسی#}
{#        function convertPersianToEnglishNumbers(input) {#}
{#            if (!input) return input;#}
{#            #}
{#            const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];#}
{#            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];#}
{#            #}
{#            let output = input;#}
{#            for (let i = 0; i < 10; i++) {#}
{#                let persianRegex = new RegExp(persianNumbers[i], 'g');#}
{#                let arabicRegex = new RegExp(arabicNumbers[i], 'g');#}
{#                output = output.replace(persianRegex, i).replace(arabicRegex, i);#}
{#            }#}
{#            #}
{#            return output;#}
{#        }#}
{#        #}
{#        // تابع تبدیل عدد به حروف فارسی#}
{#        function numberToWords(number) {#}
{#            if (number === 0) return "صفر";#}
{#            #}
{#            const ones = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];#}
{#            const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];#}
{#            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصd", "نهصد"];#}
{#            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];#}
{#            #}
{#            let result = "";#}
{#            #}
{#            // میلیون‌ها#}
{#            if (number >= 1000000) {#}
{#                result += numberToWords(Math.floor(number / 1000000)) + " میلیون ";#}
{#                number %= 1000000;#}
{#            }#}
{#            #}
{#            // هزارها#}
{#            if (number >= 1000) {#}
{#                result += numberToWords(Math.floor(number / 1000)) + " هزار ";#}
{#                number %= 1000;#}
{#            }#}
{#            #}
{#            // صدها#}
{#            if (number >= 100) {#}
{#                result += hundreds[Math.floor(number / 100)] + " و ";#}
{#                number %= 100;#}
{#            }#}
{#            #}
{#            // دهگان و یکان#}
{#            if (number >= 10 && number < 20) {#}
{#                result += teens[number - 10];#}
{#            } else {#}
{#                if (number >= 20) {#}
{#                    result += tens[Math.floor(number / 10)];#}
{#                    number %= 10;#}
{#                    if (number > 0) result += " و ";#}
{#                }#}
{#                #}
{#                if (number > 0) {#}
{#                    result += ones[number];#}
{#                }#}
{#            }#}
{#            #}
{#            return result.trim().replace(/ و $/, "");#}
{#        }#}
{#        #}
{#        // تابع به‌روزرسانی مبلغ به حروف#}
{#        function updatePriceWords(input) {#}
{#            const value = parseInt(input.val()) || 0;#}
{#            const words = numberToWords(value);#}
{#            input.siblings('.price-words').text(words + " تومان");#}
{#        }#}
{#        #}
{#        // محاسبه جمع‌های فاکتور#}
{#        function calculateTotals() {#}
{#            let totalItems = 0;#}
{#            let totalAmount = 0;#}
{#            let totalDiscount = 0;#}
{#            #}
{#            $('.item-row').each(function() {#}
{#                const quantity = parseInt($(this).find('input[name="quantity[]"]').val()) || 0;#}
{#                const unitPrice = parseFloat($(this).find('input[name="unit_price[]"]').val()) || 0;#}
{#                const discount = parseFloat($(this).find('input[name="discount[]"]').val()) || 0;#}
{#                const lineTotal = quantity * unitPrice;#}
{#                #}
{#                // به‌روزرسانی جمع کل خط#}
{#                $(this).find('.line-total-input').val(lineTotal);#}
{#                updatePriceWords($(this).find('.line-total-input'));#}
{#                #}
{#                totalItems += quantity;#}
{#                totalAmount += lineTotal;#}
{#                totalDiscount += discount;#}
{#            });#}
{#            #}
{#            $('#total-items').text(totalItems);#}
{#            $('#total-amount').text(totalAmount.toLocaleString('fa-IR') + ' تومان');#}
{#            $('#total-discount').text(totalDiscount.toLocaleString('fa-IR') + ' تومان');#}
{#            $('#final-amount').text((totalAmount - totalDiscount).toLocaleString('fa-IR') + ' تومان');#}
{#        }#}
{#        #}
{#        // تابع برای نمایش پیام#}
{#        function showMessage(message, type) {#}
{#            const messageClass = type === 'error' ? 'error-message' : 'success-message';#}
{#            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';#}
{#            #}
{#            $('#messages').html(`#}
{#                <div class="${messageClass}">#}
{#                    <i class="fas ${icon}"></i> ${message}#}
{#                </div>#}
{#            `);#}
{#            #}
{#            if (type !== 'error') {#}
{#                setTimeout(() => {#}
{#                    $('#messages').empty();#}
{#                }, 5000);#}
{#            }#}
{#        }#}
{#        #}
{#        // تابع جستجوی کالا برای ویرایش فاکتور#}
{#        function initProductSearchForEdit($input) {#}
{#            const $container = $input.closest('td');#}
{#            let $results = $container.find('.product-search-results');#}
{#            #}
{#            // اگر نتایج جستجو وجود ندارد، ایجاد کن#}
{#            if ($results.length === 0) {#}
{#                $results = $('<div class="product-search-results"></div>');#}
{#                $container.append($results);#}
{#            }#}
{#            #}
{#            // جستجوی تاخیری#}
{#            let searchTimeout;#}
{#            #}
{#            $input.on('input', function() {#}
{#                clearTimeout(searchTimeout);#}
{#                #}
{#                const query = $(this).val().trim();#}
{#                const queryEnglish = convertPersianToEnglishNumbers(query);#}
{#                #}
{#                if (queryEnglish.length < 2) {#}
{#                    $results.empty().hide();#}
{#                    return;#}
{#                }#}
{#                #}
{#                $results.html('<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> در حال جستجو...</div>').show();#}
{#                #}
{#                searchTimeout = setTimeout(() => {#}
{#                    performProductSearch(queryEnglish, $results, $input);#}
{#                }, 300);#}
{#            });#}
{#            #}
{#            // انتخاب نتیجه#}
{#            $results.on('click', '.product-search-result-item', function() {#}
{#                const productName = $(this).data('name');#}
{#                $input.val(productName);#}
{#                $results.empty().hide();#}
{#                #}
{#                // فوکوس روی قیمت#}
{#                $input.closest('tr').find('.unit-price').focus();#}
{#            });#}
{#            #}
{#            // مخفی کردن نتایج#}
{#            $(document).on('click', function(e) {#}
{#                if (!$results.is(e.target) && #}
{#                    $results.has(e.target).length === 0 &&#}
{#                    !$input.is(e.target)) {#}
{#                    $results.hide();#}
{#                }#}
{#            });#}
{#            #}
{#            // نمایش نتایج هنگام فوکوس#}
{#            $input.on('focus', function() {#}
{#                if ($results.children().length > 0) {#}
{#                    $results.show();#}
{#                }#}
{#            });#}
{#        }#}
{#        #}
{#        // اجرای جستجوی کالا#}
{#        function performProductSearch(query, $results, $input) {#}
{#            $.ajax({#}
{#                url: "{% url 'search_products_invoice_edit' %}",#}
{#                data: { #}
{#                    q: query,#}
{#                    _: new Date().getTime()#}
{#                },#}
{#                dataType: 'json',#}
{#                timeout: 5000,#}
{#                success: function(data) {#}
{#                    console.log('نتایج جستجوی کالا:', data);#}
{#                    #}
{#                    $results.empty();#}
{#                    #}
{#                    if (data.error) {#}
{#                        $results.append(`#}
{#                            <div class="product-search-result-item error">#}
{#                                <i class="fas fa-exclamation-triangle"></i>#}
{#                                خطا: ${data.error}#}
{#                            </div>#}
{#                        `);#}
{#                        return;#}
{#                    }#}
{#                    #}
{#                    if (!data.results || data.results.length === 0) {#}
{#                        $results.append(`#}
{#                            <div class="product-search-result-item new-product" data-name="${query.replace(/"/g, '&quot;')}">#}
{#                                <i class="fas fa-plus-circle"></i>#}
{#                                ایجاد کالای جدید: "${query}"#}
{#                            </div>#}
{#                        `);#}
{#                        return;#}
{#                    }#}
{#                    #}
{#                    const uniqueProducts = {};#}
{#                    data.results.forEach(item => {#}
{#                        if (item && item.text && !uniqueProducts[item.text]) {#}
{#                            uniqueProducts[item.text] = true;#}
{#                            #}
{#                            const isNew = item.type === 'new_product';#}
{#                            const icon = isNew ? 'fa-plus-circle' : 'fa-box';#}
{#                            const label = isNew ? ' (جدید)' : '';#}
{#                            #}
{#                            $results.append(`#}
{#                                <div class="product-search-result-item ${isNew ? 'new-product' : ''}" #}
{#                                     data-name="${String(item.text).replace(/"/g, '&quot;')}">#}
{#                                    <i class="fas ${icon}"></i>#}
{#                                    ${item.text}${label}#}
{#                                </div>#}
{#                            `);#}
{#                        }#}
{#                    });#}
{#                    #}
{#                    // اگر هیچ نتیجه‌ای نبود#}
{#                    if (Object.keys(uniqueProducts).length === 0) {#}
{#                        $results.append(`#}
{#                            <div class="product-search-result-item new-product" data-name="${query.replace(/"/g, '&quot;')}">#}
{#                                <i class="fas fa-plus-circle"></i>#}
{#                                ایجاد کالای جدید: "${query}"#}
{#                            </div>#}
{#                        `);#}
{#                    }#}
{#                    #}
{#                    $results.show();#}
{#                },#}
{#                error: function(xhr, status, error) {#}
{#                    console.error('خطا در جستجوی کالا:', error);#}
{#                    $results.html(`#}
{#                        <div class="product-search-result-item error">#}
{#                            <i class="fas fa-exclamation-triangle"></i>#}
{#                            خطا در اتصال به سرور#}
{#                        </div>#}
{#                    `);#}
{#                }#}
{#            });#}
{#        }#}
{#        #}
{#        // جستجوی فاکتور برای ویرایش#}
{#        $('#edit-invoice-search').on('input', function() {#}
{#            const query = $(this).val().trim();#}
{#            const convertedQuery = convertPersianToEnglishNumbers(query);#}
{#            #}
{#            if (convertedQuery.length < 2) {#}
{#                $('#edit-invoice-search-results').hide().empty();#}
{#                return;#}
{#            }#}
{#            #}
{#            clearTimeout(invoiceSearchTimeout);#}
{#            invoiceSearchTimeout = setTimeout(function() {#}
{#                $.ajax({#}
{#                    url: "{% url 'search_invoices_for_edit' %}",#}
{#                    data: { q: convertedQuery },#}
{#                    dataType: 'json',#}
{#                    success: function(data) {#}
{#                        if (data.results && data.results.length > 0) {#}
{#                            let html = '';#}
{#                            data.results.forEach(invoice => {#}
{#                                html += `#}
{#                                    <div class="search-result-item" data-invoice-id="${invoice.id}">#}
{#                                        <div class="invoice-header">#}
{#                                            <strong class="invoice-number">${invoice.serial_number}</strong>#}
{#                                            <span class="invoice-date">${invoice.date}</span>#}
{#                                        </div>#}
{#                                        <div class="invoice-details">#}
{#                                            <div class="seller-info">#}
{#                                                <i class="fas fa-user"></i> ${invoice.seller_name}#}
{#                                            </div>#}
{#                                            <div class="store-info">#}
{#                                                <i class="fas fa-store"></i> ${invoice.store_name}#}
{#                                            </div>#}
{#                                            <div class="products-info">#}
{#                                                <i class="fas fa-box"></i> ${invoice.products}#}
{#                                            </div>#}
{#                                        </div>#}
{#                                    </div>#}
{#                                `;#}
{#                            });#}
{#                            $('#edit-invoice-search-results').html(html).show();#}
{#                        } else {#}
{#                            $('#edit-invoice-search-results').html('<div class="search-result-item">هیچ فاکتوری یافت نشد</div>').show();#}
{#                        }#}
{#                    },#}
{#                    error: function(xhr, status, error) {#}
{#                        console.error('Error in invoice search for edit:', error);#}
{#                        showMessage('خطا در جستجوی فاکتورها', 'error');#}
{#                    }#}
{#                });#}
{#            }, 300);#}
{#        });#}
{#        #}
{#        // انتخاب فاکتور از نتایج جستجو#}
{#        $(document).on('click', '#edit-invoice-search-results .search-result-item', function() {#}
{#            const invoiceId = $(this).data('invoice-id');#}
{#            const invoiceText = $(this).find('strong').text();#}
{#            $('#edit-invoice-search').val(invoiceText);#}
{#            $('#edit-invoice-search-results').hide();#}
{#            #}
{#            // دریافت جزئیات فاکتور#}
{#            $.ajax({#}
{#                url: "{% url 'get_invoice_for_edit' %}",#}
{#                data: { invoice_id: invoiceId },#}
{#                dataType: 'json',#}
{#                success: function(data) {#}
{#                    if (data.success) {#}
{#                        editingInvoice = data.invoice;#}
{#                        editingInvoiceItems = data.items;#}
{#                        #}
{#                        // نمایش اطلاعات فاکتور#}
{#                        $('#invoice-info').html(`#}
{#                            <div class="info-item"><strong>شماره فاکتور:</strong> ${editingInvoice.serial_number}</div>#}
{#                            <div class="info-item"><strong>فروشنده:</strong> ${editingInvoice.seller_name}</div>#}
{#                            <div class="info-item">#}
{#                                <strong>تاریخ صدور فاکتور:</strong>#}
{#                                <div class="date-input-container">#}
{#                                    <input type="text" id="edit-issue-date" class="shamsi-date-input"#}
{#                                           placeholder="برای انتخاب تاریخ کلیک کنید"#}
{#                                           value="${editingInvoice.date}" name="issue_date" autocomplete="off">#}
{#                                    <i class="fas fa-calendar-alt calendar-icon" id="edit-calendar-trigger"></i>#}
{#                                </div>#}
{#                                <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">#}
{#                                    <i class="fas fa-mouse-pointer"></i> برای انتخاب تاریخ کلیک کنید#}
{#                                </small>#}
{#                            </div>#}
{#                            <input type="hidden" id="invoice-id" value="${editingInvoice.id}">#}
{#                        `);#}
{#                        #}
{#                        // مقداردهی اولیه تقویم شمسی برای فیلد تاریخ#}
{#                        $("#edit-issue-date").persianDatepicker({#}
{#                            observer: true,#}
{#                            format: 'YYYY/MM/DD',#}
{#                            autoClose: true,#}
{#                            initialValue: true,#}
{#                            initialValueType: 'persian',#}
{#                            onSelect: function (unix) {#}
{#                                let date = new persianDate(unix);#}
{#                                let formattedDate = date.format("YYYY/MM/DD");#}
{#                                document.getElementById('edit-issue-date').value = formattedDate;#}
{#                            }#}
{#                        });#}
{#                        #}
{#                        // نمایش تقویم هنگام کلیک روی آیکون تقویم#}
{#                        document.getElementById('edit-calendar-trigger').addEventListener('click', function () {#}
{#                            $("#edit-issue-date").persianDatepicker('show');#}
{#                        });#}
{#                        #}
{#                        // نمایش آیتم‌های فاکتور#}
{#                        updateInvoiceItemsList();#}
{#                        #}
{#                        $('#invoice-details').show();#}
{#                    } else {#}
{#                        showMessage(data.error, 'error');#}
{#                    }#}
{#                },#}
{#                error: function(xhr, status, error) {#}
{#                    console.error('Error getting invoice details:', error);#}
{#                    showMessage('خطا در دریافت اطلاعات فاکتور', 'error');#}
{#                }#}
{#            });#}
{#        });#}
{#        #}
{#        // به روزرسانی لیست آیتم‌های فاکتور#}
{#        function updateInvoiceItemsList() {#}
{#            const $itemsList = $('#invoice-items-list');#}
{#            $itemsList.empty();#}
{#            #}
{#            editingInvoiceItems.forEach((item, index) => {#}
{#                const row = `#}
{#                    <tr class="item-row" data-item-index="${index}">#}
{#                        <td data-label="نام کالا">#}
{#                            <div class="product-search-container">#}
{#                                <input type="text" class="product-search-input product-name" name="product_name[]" value="${item.product_name}" placeholder="جستجوی نام کالا" required>#}
{#                            </div>#}
{#                        </td>#}
{#                        <td data-label="قیمت خرید">#}
{#                            <input type="number" class="unit-price price-input" name="unit_price[]" value="${item.unit_price}" min="0" step="100" required>#}
{#                            <div class="price-words"></div>#}
{#                        </td>#}
{#                        <td data-label="تعداد">#}
{#                            <input type="number" name="quantity[]" value="${item.quantity}" min="1" required>#}
{#                        </td>#}
{#                        <td data-label="جمع کل">#}
{#                            <input type="number" class="line-total-input" readonly>#}
{#                            <div class="price-words"></div>#}
{#                        </td>#}
{#                        <td data-label="تخفیف">#}
{#                            <input type="number" name="discount[]" value="${item.discount}" min="0" step="100">#}
{#                        </td>#}
{#                        <td data-label="عملیات">#}
{#                            <button type="button" class="btn btn-danger remove-item" data-index="${index}">#}
{#                                <i class="fas fa-trash"></i>#}
{#                            </button>#}
{#                        </td>#}
{#                    </tr>#}
{#                `;#}
{#                $itemsList.append(row);#}
{#                #}
{#                // محاسبه اولیه برای این سطر#}
{#                const quantity = parseInt(item.quantity) || 0;#}
{#                const unitPrice = parseFloat(item.unit_price) || 0;#}
{#                const lineTotal = quantity * unitPrice;#}
{#                #}
{#                $itemsList.find('tr:last-child .line-total-input').val(lineTotal);#}
{#                updatePriceWords($itemsList.find('tr:last-child .line-total-input'));#}
{#                updatePriceWords($itemsList.find('tr:last-child .unit-price'));#}
{#                #}
{#                // فعال‌سازی جستجوی کالا برای این سطر#}
{#                initProductSearchForEdit($itemsList.find('tr:last-child .product-name'));#}
{#            });#}
{#            #}
{#            calculateTotals();#}
{#        }#}
{#        #}
{#        // افزودن آیتم جدید#}
{#        $('#add-item-btn').click(function() {#}
{#            const newIndex = editingInvoiceItems.length;#}
{#            const newRow = `#}
{#                <tr class="item-row" data-item-index="${newIndex}">#}
{#                    <td data-label="نام کالا">#}
{#                        <div class="product-search-container">#}
{#                            <input type="text" class="product-search-input product-name" name="product_name[]" placeholder="جستجوی نام کالا" required>#}
{#                        </div>#}
{#                    </td>#}
{#                    <td data-label="قیمت خرید">#}
{#                        <input type="number" class="unit-price price-input" name="unit_price[]" min="0" step="100" value="0" required>#}
{#                        <div class="price-words"></div>#}
{#                    </td>#}
{#                    <td data-label="تعداد">#}
{#                        <input type="number" name="quantity[]" value="1" min="1" required>#}
{#                    </td>#}
{#                    <td data-label="جمع کل">#}
{#                        <input type="number" class="line-total-input" readonly>#}
{#                        <div class="price-words"></div>#}
{#                    </td>#}
{#                    <td data-label="تخفیف">#}
{#                        <input type="number" name="discount[]" value="0" min="0" step="100">#}
{#                    </td>#}
{#                    <td data-label="عملیات">#}
{#                        <button type="button" class="btn btn-danger remove-item" data-index="${newIndex}">#}
{#                            <i class="fas fa-trash"></i>#}
{#                        </button>#}
{#                    </td>#}
{#                </tr>#}
{#            `;#}
{#            #}
{#            $('#invoice-items-list').append(newRow);#}
{#            editingInvoiceItems.push({#}
{#                product_name: '',#}
{#                quantity: 1,#}
{#                unit_price: 0,#}
{#                discount: 0#}
{#            });#}
{#            #}
{#            // فعال‌سازی جستجوی کالا برای سطر جدید#}
{#            initProductSearchForEdit($('#invoice-items-list tr:last-child .product-name'));#}
{#            #}
{#            // افزودن رویداد برای محاسبه#}
{#            $('#invoice-items-list tr:last-child input').on('input', calculateTotals);#}
{#            #}
{#            // فعال‌سازی نمایش مبلغ به حروف#}
{#            $('#invoice-items-list tr:last-child .unit-price').on('input', function() {#}
{#                updatePriceWords($(this));#}
{#            });#}
{#        });#}
{#        #}
{#        // حذف آیتم#}
{#        $(document).on('click', '.remove-item', function() {#}
{#            const index = $(this).data('index');#}
{#            if (editingInvoiceItems.length > 1) {#}
{#                $(this).closest('tr').remove();#}
{#                editingInvoiceItems.splice(index, 1);#}
{#                #}
{#                // به روزرسانی index برای همه سطرها#}
{#                $('.item-row').each(function(i) {#}
{#                    $(this).attr('data-item-index', i);#}
{#                    $(this).find('.remove-item').attr('data-index', i);#}
{#                });#}
{#                #}
{#                calculateTotals();#}
{#            } else {#}
{#                showMessage('حداقل یک کالا باید وجود داشته باشد', 'error');#}
{#            }#}
{#        });#}
{#        #}
{#        // محاسبه هنگام تغییر مقادیر#}
{#        $(document).on('input', 'input[name="quantity[]"], input[name="unit_price[]"], input[name="discount[]"]', function() {#}
{#            calculateTotals();#}
{#        });#}
{#        #}
{#        // به‌روزرسانی مبلغ به حروف هنگام تغییر قیمت#}
{#        $(document).on('input', '.unit-price', function() {#}
{#            updatePriceWords($(this));#}
{#        });#}
{#        #}
{#        // =============================================#}
{#        // توابع جدید برای مدیریت مودال و ثبت فاکتور#}
{#        // =============================================#}
{#        #}
{#        /**#}
{#         * نمایش مودال انتظار#}
{#         */#}
{#        function showLoadingModal(message = 'در حال ذخیره تغییرات...') {#}
{#            $('#loadingMessage').text(message);#}
{#            $('#loadingModal').fadeIn(300);#}
{#            $('body').addClass('page-disabled');#}
{#            #}
{#            // غیرفعال کردن دکمه ذخیره#}
{#            $('#edit-invoice-submit-btn').prop('disabled', true);#}
{#            #}
{#            // غیرفعال کردن سایر دکمه‌های عملیات#}
{#            $('#add-item-btn, .remove-item, #edit-invoice-back-btn').prop('disabled', true);#}
{#            #}
{#            // غیرفعال کردن فیلدهای ورودی#}
{#            $('input, select, textarea').prop('disabled', true);#}
{#        }#}
{#        #}
{#        /**#}
{#         * پنهان کردن مودال انتظار#}
{#         */#}
{#        function hideLoadingModal() {#}
{#            $('#loadingModal').fadeOut(300);#}
{#            $('body').removeClass('page-disabled');#}
{#            #}
{#            // فعال کردن مجدد دکمه ذخیره#}
{#            $('#edit-invoice-submit-btn').prop('disabled', false);#}
{#            #}
{#            // فعال کردن مجدد سایر دکمه‌ها#}
{#            $('#add-item-btn, .remove-item, #edit-invoice-back-btn').prop('disabled', false);#}
{#            #}
{#            // فعال کردن مجدد فیلدهای ورودی#}
{#            $('input, select, textarea').prop('disabled', false);#}
{#        }#}
{#        #}
{#        /**#}
{#         * نمایش موفقیت و بازگشت به صفحه اصلی#}
{#         */#}
{#        function showSuccessAndRedirect() {#}
{#            // تغییر پیام مودال به موفقیت#}
{#            $('#loadingMessage').text('تغییرات با موفقیت ذخیره شد!');#}
{#            $('.loading-spinner i')#}
{#                .removeClass('fa-spinner fa-spin')#}
{#                .addClass('fa-check-circle')#}
{#                .css('color', '#4CAF50');#}
{#            #}
{#            // پس از 2 ثانیه مودال را ببند و به صفحه اصلی برو#}
{#            setTimeout(() => {#}
{#                hideLoadingModal();#}
{#                #}
{#                // نمایش پیام موفقیت#}
{#                showMessage('تغییرات با موفقیت ذخیره شد و در حال بازگشت به صفحه اصلی...', 'success');#}
{#                #}
{#                // بازگشت به صفحه اصلی پس از 3 ثانیه#}
{#                setTimeout(() => {#}
{#                    window.location.href = "{% url 'home' %}";#}
{#                }, 2000);#}
{#                #}
{#            }, 2000);#}
{#        }#}
{#        #}
{#        /**#}
{#         * نمایش خطا#}
{#         */#}
{#        function showErrorAndReset(message) {#}
{#            // تغییر پیام مودال به خطا#}
{#            $('#loadingMessage').text('خطا در ذخیره تغییرات');#}
{#            $('.loading-spinner i')#}
{#                .removeClass('fa-spinner fa-spin')#}
{#                .addClass('fa-times-circle')#}
{#                .css('color', '#F44336');#}
{#            #}
{#            // پس از 2 ثانیه مودال را ببند#}
{#            setTimeout(() => {#}
{#                hideLoadingModal();#}
{#                showMessage(message, 'error');#}
{#                isSubmitting = false; // فعال کردن مجدد امکان ثبت#}
{#            }, 2000);#}
{#        }#}
{#        #}
{#        // ثبت تغییرات#}
{#        $('#edit-invoice-submit-btn').click(function() {#}
{#            // اگر در حال ثبت هستیم، از ثبت مجدد جلوگیری کن#}
{#            if (isSubmitting) {#}
{#                showMessage('در حال ذخیره تغییرات هستید، لطفاً منتظر بمانید', 'warning');#}
{#                return;#}
{#            }#}
{#            #}
{#            if (!editingInvoice) {#}
{#                showMessage('لطفاً ابتدا یک فاکتور انتخاب کنید', 'error');#}
{#                return;#}
{#            }#}
{#            #}
{#            // علامت‌گذاری که در حال ثبت هستیم#}
{#            isSubmitting = true;#}
{#            #}
{#            // جمع‌آوری داده‌های فرم#}
{#            const formData = {#}
{#                invoice_id: $('#invoice-id').val(),#}
{#                issue_date: $('#edit-issue-date').val(),#}
{#                items: []#}
{#            };#}
{#            #}
{#            let isValid = true;#}
{#            let validationError = '';#}
{#            #}
{#            // اعتبارسنجی آیتم‌ها#}
{#            $('.item-row').each(function() {#}
{#                const productName = $(this).find('input[name="product_name[]"]').val();#}
{#                const quantity = $(this).find('input[name="quantity[]"]').val();#}
{#                const unitPrice = $(this).find('input[name="unit_price[]"]').val();#}
{#                const discount = $(this).find('input[name="discount[]"]').val();#}
{#                #}
{#                if (!productName || !productName.trim()) {#}
{#                    isValid = false;#}
{#                    validationError = 'لطفاً نام کالا را وارد کنید';#}
{#                    return false;#}
{#                }#}
{#                #}
{#                if (!quantity || quantity <= 0) {#}
{#                    isValid = false;#}
{#                    validationError = 'لطفاً تعداد معتبر وارد کنید';#}
{#                    return false;#}
{#                }#}
{#                #}
{#                if (!unitPrice || unitPrice <= 0) {#}
{#                    isValid = false;#}
{#                    validationError = 'لطفاً قیمت معتبر وارد کنید';#}
{#                    return false;#}
{#                }#}
{#                #}
{#                formData.items.push({#}
{#                    product_name: productName,#}
{#                    quantity: quantity,#}
{#                    unit_price: unitPrice,#}
{#                    discount: discount || 0#}
{#                });#}
{#            });#}
{#            #}
{#            if (!isValid) {#}
{#                isSubmitting = false; // آزاد کردن قفل#}
{#                showMessage(validationError, 'error');#}
{#                return;#}
{#            }#}
{#            #}
{#            // نمایش مودال انتظار#}
{#            showLoadingModal('در حال ذخیره تغییرات...');#}
{#            #}
{#            // ارسال درخواست به سرور#}
{#            $.ajax({#}
{#                url: "{% url 'update_invoice' %}",#}
{#                method: 'POST',#}
{#                contentType: 'application/json',#}
{#                data: JSON.stringify(formData),#}
{#                headers: {#}
{#                    'X-CSRFToken': '{{ csrf_token }}'#}
{#                },#}
{#                success: function(data) {#}
{#                    if (data.success) {#}
{#                        // نمایش موفقیت و بازگشت#}
{#                        showSuccessAndRedirect();#}
{#                    } else {#}
{#                        // نمایش خطا#}
{#                        showErrorAndReset(data.error || 'خطا در ذخیره تغییرات');#}
{#                    }#}
{#                },#}
{#                error: function(xhr, status, error) {#}
{#                    console.error('Error updating invoice:', error);#}
{#                    showErrorAndReset('خطا در ارتباط با سرور');#}
{#                },#}
{#                complete: function() {#}
{#                    // در نهایت، متغیر قفل را باز کن#}
{#                    setTimeout(() => {#}
{#                        isSubmitting = false;#}
{#                    }, 1000);#}
{#                }#}
{#            });#}
{#        });#}
{#        #}
{#        // بازگشت#}
{#        $('#edit-invoice-back-btn').click(function() {#}
{#            if (confirm('تغییرات ذخیره نشده از بین خواهند رفت. آیا مطمئن هستید؟')) {#}
{#                window.location.href = "{% url 'home' %}";#}
{#            }#}
{#        });#}
{#        #}
{#        // مخفی کردن نتایج جستجو هنگام کلیک خارج#}
{#        $(document).on('click', function(e) {#}
{#            if (!$(e.target).closest('.search-container').length) {#}
{#                $('#edit-invoice-search-results').hide();#}
{#            }#}
{#            #}
{#            // مخفی کردن نتایج جستجوی کالا#}
{#            $('.product-search-results').each(function() {#}
{#                if (!$(this).is(e.target) && $(this).has(e.target).length === 0) {#}
{#                    $(this).hide();#}
{#                }#}
{#            });#}
{#        });#}
{#        #}
{#        $(document).ready(function() {#}
{#            console.log('صفحه ویرایش فاکتور لود شد');#}
{#            #}
{#            // مدیریت نمایش ریسپانسیو در موبایل#}
{#            function checkMobileView() {#}
{#                if ($(window).width() <= 768) {#}
{#                    $('.invoice-table thead').hide();#}
{#                    $('.item-row').addClass('mobile-view');#}
{#                } else {#}
{#                    $('.invoice-table thead').show();#}
{#                    $('.item-row').removeClass('mobile-view');#}
{#                }#}
{#            }#}
{#            #}
{#            // بررسی هنگام لود و تغییر سایز صفحه#}
{#            $(window).on('load resize', checkMobileView);#}
{#        });#}
{#    </script>#}
{#</body>#}
{#</html>#}

<!-- templates/edit_invoice.html -->
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ویرایش فاکتور - فروشگاه پلاستیک و لوازم آشپرخانه موسوی</title>

    <!-- فونت‌ها و آیکون‌ها -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">

    <!-- کتابخانه‌های تاریخ شمسی -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">

    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --accent-color: #2E7D32;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            direction: rtl;
        }

        .edit-invoice-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-section {
            margin-bottom: 20px;
            position: relative;
        }

        .search-container {
            position: relative;
        }

        .search-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #555;
            font-weight: bold;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            font-size: 16px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s;
            background: var(--input-bg);
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px rgba(46, 125, 50, 0.3);
            outline: none;
        }

        .search-btn {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 18px;
            cursor: pointer;
        }

        .search-hint {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* استایل اصلی برای لیست نتایج جستجو */
        .search-results {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 500px;
            min-height: 300px;
            overflow-y: auto;
            margin-top: 8px;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
            line-height: 1.5;
        }

        .search-result-item:hover {
            background-color: var(--light-bg);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .invoice-number {
            color: var(--primary-color);
            font-size: 16px;
            font-weight: bold;
        }

        .invoice-date {
            color: #666;
            font-size: 14px;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .invoice-details {
            font-size: 14px;
        }

        .seller-info, .store-info, .products-info {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            color: #555;
        }

        .seller-info i, .store-info i, .products-info i {
            margin-left: 8px;
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }

        .products-info {
            color: #777;
            font-size: 13px;
            background: #f8f8f8;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
        }

        .invoice-details {
            display: none;
            margin-top: 20px;
        }

        .invoice-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        /* استایل‌های جدید برای جستجوی کالا */
        .product-search-container {
            position: relative;
            width: 100%;
        }
        
        .product-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .product-search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
            outline: none;
        }
        
        .product-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            z-index: 1003;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 5px;
        }
        
        .product-search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
            text-align: right;
        }
        
        .product-search-result-item:hover {
            background-color: #f1f8e9;
        }
        
        .product-search-result-item.new-product {
            color: #28a745;
            font-weight: bold;
        }
        
        .product-search-result-item.error {
            color: #dc3545;
        }
        
        .search-loading {
            padding: 15px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .search-loading i {
            margin-left: 8px;
        }

        /* استایل برای تضمین نمایش صحیح تقویم */
        .pdatepicker-gui {
            z-index: 10000 !important;
            font-family: 'Vazirmatn', sans-serif !important;
        }

        .pdatepicker-gui .pdatepicker-day {
            cursor: pointer !important;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        .invoice-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
        }

        .invoice-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            vertical-align: middle;
        }

        .invoice-table input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .price-input {
            font-size: 20px !important;
            font-weight: bold;
            padding: 14px 15px !important;
            background-color: #f8fff8;
        }

        .line-total-input {
            font-size: 20px !important;
            font-weight: bold;
            padding: 14px 15px !important;
            background-color: #e8f5e9;
            border: 1px solid #4CAF50;
            cursor: not-allowed;
        }

        .price-words {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
            direction: rtl;
            height: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .invoice-summary {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .summary-item.total-payable {
            font-weight: bold;
            font-size: 20px;
            color: #2E7D32;
            border-top: 2px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-back {
            background: #9e9e9e;
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #d32f2f;
            font-size: 18px;
        }

        .success-message {
            color: #2E7D32;
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2E7D32;
            font-size: 18px;
        }

        /* استایل برای وضعیت خالی */
        .empty-results {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        /* استایل برای اسکرول بار */
        .search-results::-webkit-scrollbar,
        .product-search-results::-webkit-scrollbar {
            width: 8px;
        }

        .search-results::-webkit-scrollbar-track,
        .product-search-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb,
        .product-search-results::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .search-results::-webkit-scrollbar-thumb:hover,
        .product-search-results::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        /* استایل‌های مودال انتظار */
        .loading-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-spinner {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            font-size: 20px;
            color: var(--text-color);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .loading-submessage {
            font-size: 16px;
            color: #666;
            margin-top: 10px;
        }

        /* استایل برای غیرفعال کردن صفحه */
        .page-disabled {
            pointer-events: none;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        /* استایل برای دکمه غیرفعال */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* استایل برای حالت پردازش */
        .processing {
            pointer-events: none;
            opacity: 0.7;
        }

        /* استایل برای فیلدهای تاریخ */
        .date-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 300px;
        }

        .shamsi-date-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .calendar-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
        }

        /* استایل برای نمایش ریسپانسیو موبایل */
        .mobile-view .invoice-table {
            display: block;
        }

        .mobile-view .invoice-table thead {
            display: none;
        }

        .mobile-view .item-row {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }

        .mobile-view .invoice-table td {
            display: flex;
            flex-direction: column;
            padding: 10px 5px;
            border: none;
            text-align: right;
            width: 100% !important;
        }

        .mobile-view .invoice-table td::before {
            content: attr(data-label);
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .edit-invoice-container {
                padding: 15px;
                border-radius: 15px;
            }

            .invoice-table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .invoice-table thead {
                display: none;
            }
            
            .invoice-table tbody {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .item-row {
                display: flex;
                flex-direction: column;
                border: 1px solid var(--border-color);
                border-radius: 10px;
                padding: 15px;
                background: #f9f9f9;
            }
            
            .invoice-table td {
                display: flex;
                flex-direction: column;
                padding: 10px 5px;
                border: none;
                text-align: right;
                width: 100% !important;
            }
            
            .invoice-table td::before {
                content: attr(data-label);
                font-weight: bold;
                margin-bottom: 8px;
                color: var(--primary-color);
                font-size: 16px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 16px;
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }

            .actions {
                flex-direction: column-reverse;
                gap: 10px;
            }

            .search-results {
                min-height: 250px;
            }

            .invoice-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .invoice-date {
                align-self: flex-start;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .edit-invoice-container {
                padding: 10px;
                border-radius: 10px;
            }
            
            .search-input, .product-search-input {
                padding: 10px;
                font-size: 14px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .invoice-table td {
                padding: 8px 0;
            }
            
            .summary-item {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }
            
            .summary-item span:first-child {
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <div class="edit-invoice-container">
        <div class="header-section">
            <h1>ویرایش فاکتور</h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-edit" style="color: var(--primary-color); font-size: 24px;"></i>
                <span style="color: #666; font-size: 14px;">ویرایش فاکتور و مدیریت کالاها</span>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <label class="search-label">جستجوی فاکتور برای ویرایش:</label>
                <input type="text" id="edit-invoice-search" class="search-input" 
                       placeholder="شماره فاکتور، نام فروشنده، نام خانوادگی، نام فروشگاه یا نام کالا...">
                <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <div id="edit-invoice-search-results" class="search-results">
                    <div class="empty-results">برای جستجو، حداقل ۲ کاراکتر وارد کنید</div>
                </div>
            </div>
            <div class="search-hint">
                <i class="fas fa-info-circle"></i> برای جستجو، حداقل ۲ کاراکتر وارد کنید - جستجو بر اساس: شماره فاکتور، نام فروشنده، نام خانوادگی، نام فروشگاه و نام کالا
            </div>
        </div>

        <div id="invoice-details" class="invoice-details">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-file-invoice-dollar"></i> ویرایش فاکتور</h2>
                <div style="display: flex; align-items: center; gap: 10px; color: #666;">
                    <i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i>
                    <small>تغیرات در اینجا بر روی قیمت‌گذاری و موجودی کالاها تأثیر می‌گذارد</small>
                </div>
            </div>

            <div id="invoice-info" class="invoice-info">
                <!-- اطلاعات فاکتور اینجا نمایش داده می‌شود -->
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3><i class="fas fa-boxes"></i> لیست کالاهای فاکتور</h3>
                <small style="color: #666;">تعداد اقلام: <span id="total-items-preview">0</span></small>
            </div>

            <table class="invoice-table">
                <thead>
                    <tr>
                        <th width="30%" data-label="نام کالا">
                            <i class="fas fa-tag"></i> نام کالا
                        </th>
                        <th width="15%" data-label="قیمت خرید">
                            <i class="fas fa-dollar-sign"></i> قیمت خرید (تومان)
                        </th>
                        <th width="10%" data-label="تعداد">
                            <i class="fas fa-sort-amount-up"></i> تعداد
                        </th>
                        <th width="15%" data-label="جمع کل">
                            <i class="fas fa-calculator"></i> جمع کل (تومان)
                        </th>
                        <th width="15%" data-label="تخفیف">
                            <i class="fas fa-percentage"></i> تخفیف (تومان)
                        </th>
                        <th width="15%" data-label="عملیات">
                            <i class="fas fa-cog"></i> عملیات
                        </th>
                    </tr>
                </thead>
                <tbody id="invoice-items-list">
                    <!-- آیتم‌های فاکتور اینجا نمایش داده می‌شوند -->
                </tbody>
            </table>

            <button id="add-item-btn" class="btn btn-secondary">
                <i class="fas fa-plus-circle"></i> اضافه کردن کالا
            </button>

            <div class="invoice-summary">
                <div class="summary-item">
                    <span>تعداد اقلام:</span>
                    <span id="total-items">0</span>
                </div>
                <div class="summary-item">
                    <span>جمع کل فاکتور:</span>
                    <span id="total-amount">0 تومان</span>
                </div>
                <div class="summary-item">
                    <span>تخفیف کل:</span>
                    <span id="total-discount">0 تومان</span>
                </div>
                <div class="summary-item total-payable">
                    <span>قابل پرداخت:</span>
                    <span id="final-amount">0 تومان</span>
                </div>
            </div>

            <div class="actions">
                <button id="edit-invoice-back-btn" class="btn btn-back">
                    <i class="fas fa-arrow-right"></i> بازگشت
                </button>
                <button id="edit-invoice-submit-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> ذخیره تغییرات
                </button>
            </div>
        </div>

        <div id="messages"></div>
    </div>

    <!-- مودال انتظار -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-spinner"></i>
            </div>
            <div class="loading-message" id="loadingMessage">
                در حال ذخیره تغییرات...
            </div>
            <div class="loading-submessage">
                لطفاً منتظر بمانید
            </div>
            <div id="loadingProgress" style="margin-top: 20px; color: #666; font-size: 14px;">
                <!-- نمایش وضعیت پیشرفت -->
            </div>
        </div>
    </div>

    <!-- کتابخانه‌های JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <script>
        // متغیرهای global برای مدیریت ویرایش فاکتور
        let editingInvoice = null;
        let editingInvoiceItems = [];
        let invoiceSearchTimeout = null;
        let isSubmitting = false;
        
        // تابع تبدیل اعداد فارسی و عربی به انگلیسی
        function convertPersianToEnglishNumbers(input) {
            if (!input) return input;
            
            const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            
            let output = input;
            for (let i = 0; i < 10; i++) {
                let persianRegex = new RegExp(persianNumbers[i], 'g');
                let arabicRegex = new RegExp(arabicNumbers[i], 'g');
                output = output.replace(persianRegex, i).replace(arabicRegex, i);
            }
            
            return output;
        }
        
        // تابع تبدیل عدد به حروف فارسی
        function numberToWords(number) {
            if (number === 0) return "صفر";
            
            const ones = ["", "یک", "دو", "سه", "چهار", "پنج", "شش", "هفت", "هشت", "نه"];
            const tens = ["", "ده", "بیست", "سی", "چهل", "پنجاه", "شصت", "هفتاد", "هشتاد", "نود"];
            const hundreds = ["", "صد", "دویست", "سیصد", "چهارصد", "پانصد", "ششصد", "هفتصد", "هشتصد", "نهصد"];
            const teens = ["ده", "یازده", "دوازده", "سیزده", "چهارده", "پانزده", "شانزده", "هفده", "هجده", "نوزده"];
            
            let result = "";
            
            // میلیون‌ها
            if (number >= 1000000) {
                result += numberToWords(Math.floor(number / 1000000)) + " میلیون ";
                number %= 1000000;
            }
            
            // هزارها
            if (number >= 1000) {
                result += numberToWords(Math.floor(number / 1000)) + " هزار ";
                number %= 1000;
            }
            
            // صدها
            if (number >= 100) {
                result += hundreds[Math.floor(number / 100)] + " و ";
                number %= 100;
            }
            
            // دهگان و یکان
            if (number >= 10 && number < 20) {
                result += teens[number - 10];
            } else {
                if (number >= 20) {
                    result += tens[Math.floor(number / 10)];
                    number %= 10;
                    if (number > 0) result += " و ";
                }
                
                if (number > 0) {
                    result += ones[number];
                }
            }
            
            return result.trim().replace(/ و $/, "");
        }
        
        // تابع به‌روزرسانی مبلغ به حروف
        function updatePriceWords(input) {
            const value = parseInt(input.val()) || 0;
            const words = numberToWords(value);
            input.siblings('.price-words').text(words + " تومان");
        }
        
        // محاسبه جمع‌های فاکتور
        function calculateTotals() {
            let totalItems = 0;
            let totalAmount = 0;
            let totalDiscount = 0;
            
            $('.item-row').each(function() {
                const quantity = parseInt($(this).find('input[name="quantity[]"]').val()) || 0;
                const unitPrice = parseFloat($(this).find('input[name="unit_price[]"]').val()) || 0;
                const discount = parseFloat($(this).find('input[name="discount[]"]').val()) || 0;
                const lineTotal = quantity * unitPrice;
                
                $(this).find('.line-total-input').val(lineTotal);
                updatePriceWords($(this).find('.line-total-input'));
                
                totalItems += quantity;
                totalAmount += lineTotal;
                totalDiscount += discount;
            });
            
            $('#total-items').text(totalItems);
            $('#total-items-preview').text(totalItems);
            $('#total-amount').text(totalAmount.toLocaleString('fa-IR') + ' تومان');
            $('#total-discount').text(totalDiscount.toLocaleString('fa-IR') + ' تومان');
            $('#final-amount').text((totalAmount - totalDiscount).toLocaleString('fa-IR') + ' تومان');
            
            return {
                totalItems,
                totalAmount,
                totalDiscount,
                finalAmount: totalAmount - totalDiscount
            };
        }
        
        // تابع برای نمایش پیام
        function showMessage(message, type) {
            const messageClass = type === 'error' ? 'error-message' : 'success-message';
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            
            $('#messages').html(`
                <div class="${messageClass}">
                    <i class="fas ${icon}"></i> ${message}
                </div>
            `);
            
            if (type !== 'error') {
                setTimeout(() => {
                    $('#messages').empty();
                }, 5000);
            }
        }
        
        // تابع جستجوی کالا برای ویرایش فاکتور
        function initProductSearchForEdit($input) {
            const $container = $input.closest('td');
            let $results = $container.find('.product-search-results');
            
            if ($results.length === 0) {
                $results = $('<div class="product-search-results"></div>');
                $container.append($results);
            }
            
            let searchTimeout;
            
            $input.on('input', function() {
                clearTimeout(searchTimeout);
                
                const query = $(this).val().trim();
                const queryEnglish = convertPersianToEnglishNumbers(query);
                
                if (queryEnglish.length < 2) {
                    $results.empty().hide();
                    return;
                }
                
                $results.html('<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> در حال جستجو...</div>').show();
                
                searchTimeout = setTimeout(() => {
                    performProductSearch(queryEnglish, $results, $input);
                }, 300);
            });
            
            $results.on('click', '.product-search-result-item', function() {
                const productName = $(this).data('name');
                $input.val(productName);
                $results.empty().hide();
                
                setTimeout(() => {
                    $input.closest('tr').find('.unit-price').focus();
                }, 100);
            });
            
            $(document).on('click', function(e) {
                if (!$results.is(e.target) && 
                    $results.has(e.target).length === 0 &&
                    !$input.is(e.target)) {
                    $results.hide();
                }
            });
            
            $input.on('focus', function() {
                if ($results.children().length > 0) {
                    $results.show();
                }
            });
        }
        
        // اجرای جستجوی کالا
        function performProductSearch(query, $results, $input) {
            $.ajax({
                url: "{% url 'search_products_invoice_edit' %}",
                data: { 
                    q: query,
                    _: new Date().getTime()
                },
                dataType: 'json',
                timeout: 5000,
                success: function(data) {
                    console.log('نتایج جستجوی کالا:', data);
                    
                    $results.empty();
                    
                    if (data.error) {
                        $results.append(`
                            <div class="product-search-result-item error">
                                <i class="fas fa-exclamation-triangle"></i>
                                خطا: ${data.error}
                            </div>
                        `);
                        return;
                    }
                    
                    if (!data.results || data.results.length === 0) {
                        $results.append(`
                            <div class="product-search-result-item new-product" data-name="${query.replace(/"/g, '&quot;')}">
                                <i class="fas fa-plus-circle"></i>
                                ایجاد کالای جدید: "${query}"
                            </div>
                        `);
                        return;
                    }
                    
                    const uniqueProducts = {};
                    data.results.forEach(item => {
                        if (item && item.text && !uniqueProducts[item.text]) {
                            uniqueProducts[item.text] = true;
                            
                            const isNew = item.type === 'new_product';
                            const icon = isNew ? 'fa-plus-circle' : 'fa-box';
                            const label = isNew ? ' (جدید)' : '';
                            
                            $results.append(`
                                <div class="product-search-result-item ${isNew ? 'new-product' : ''}" 
                                     data-name="${String(item.text).replace(/"/g, '&quot;')}">
                                    <i class="fas ${icon}"></i>
                                    ${item.text}${label}
                                </div>
                            `);
                        }
                    });
                    
                    if (Object.keys(uniqueProducts).length === 0) {
                        $results.append(`
                            <div class="product-search-result-item new-product" data-name="${query.replace(/"/g, '&quot;')}">
                                <i class="fas fa-plus-circle"></i>
                                ایجاد کالای جدید: "${query}"
                            </div>
                        `);
                    }
                    
                    $results.show();
                },
                error: function(xhr, status, error) {
                    console.error('خطا در جستجوی کالا:', error);
                    $results.html(`
                        <div class="product-search-result-item error">
                            <i class="fas fa-exclamation-triangle"></i>
                            خطا در اتصال به سرور
                        </div>
                    `);
                }
            });
        }
        
        // جستجوی فاکتور برای ویرایش
        $('#edit-invoice-search').on('input', function() {
            const query = $(this).val().trim();
            const convertedQuery = convertPersianToEnglishNumbers(query);
            
            if (convertedQuery.length < 2) {
                $('#edit-invoice-search-results').hide().empty();
                return;
            }
            
            clearTimeout(invoiceSearchTimeout);
            invoiceSearchTimeout = setTimeout(function() {
                $.ajax({
                    url: "{% url 'search_invoices_for_edit' %}",
                    data: { q: convertedQuery },
                    dataType: 'json',
                    success: function(data) {
                        if (data.results && data.results.length > 0) {
                            let html = '';
                            data.results.forEach(invoice => {
                                html += `
                                    <div class="search-result-item" data-invoice-id="${invoice.id}">
                                        <div class="invoice-header">
                                            <strong class="invoice-number">${invoice.serial_number}</strong>
                                            <span class="invoice-date">${invoice.date}</span>
                                        </div>
                                        <div class="invoice-details">
                                            <div class="seller-info">
                                                <i class="fas fa-user"></i> ${invoice.seller_name}
                                            </div>
                                            <div class="store-info">
                                                <i class="fas fa-store"></i> ${invoice.store_name}
                                            </div>
                                            <div class="products-info">
                                                <i class="fas fa-box"></i> ${invoice.products}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            $('#edit-invoice-search-results').html(html).show();
                        } else {
                            $('#edit-invoice-search-results').html('<div class="search-result-item">هیچ فاکتوری یافت نشد</div>').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error in invoice search for edit:', error);
                        showMessage('خطا در جستجوی فاکتورها', 'error');
                    }
                });
            }, 300);
        });
        
        // انتخاب فاکتور از نتایج جستجو
        $(document).on('click', '#edit-invoice-search-results .search-result-item', function() {
            const invoiceId = $(this).data('invoice-id');
            const invoiceText = $(this).find('strong').text();
            $('#edit-invoice-search').val(invoiceText);
            $('#edit-invoice-search-results').hide();
            
            showLoadingModal('در حال دریافت اطلاعات فاکتور...');
            
            $.ajax({
                url: "{% url 'get_invoice_for_edit' %}",
                data: { invoice_id: invoiceId },
                dataType: 'json',
                success: function(data) {
                    hideLoadingModal();
                    if (data.success) {
                        editingInvoice = data.invoice;
                        editingInvoiceItems = data.items;
                        
                        $('#invoice-info').html(`
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="info-item">
                                    <i class="fas fa-hashtag"></i>
                                    <strong>شماره فاکتور:</strong> ${editingInvoice.serial_number}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-user-tag"></i>
                                    <strong>فروشنده:</strong> ${editingInvoice.seller_name}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-store"></i>
                                    <strong>فروشگاه:</strong> ${editingInvoice.store_name || 'ندارد'}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <strong>تاریخ صدور فاکتور:</strong>
                                    <div class="date-input-container">
                                        <input type="text" id="edit-issue-date" class="shamsi-date-input"
                                               placeholder="برای انتخاب تاریخ کلیک کنید"
                                               value="${editingInvoice.date}" name="issue_date" autocomplete="off">
                                        <i class="fas fa-calendar-alt calendar-icon" id="edit-calendar-trigger"></i>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="invoice-id" value="${editingInvoice.id}">
                        `);
                        
                        $("#edit-issue-date").persianDatepicker({
                            observer: true,
                            format: 'YYYY/MM/DD',
                            autoClose: true,
                            initialValue: true,
                            initialValueType: 'persian',
                            onSelect: function (unix) {
                                let date = new persianDate(unix);
                                let formattedDate = date.format("YYYY/MM/DD");
                                document.getElementById('edit-issue-date').value = formattedDate;
                            }
                        });
                        
                        document.getElementById('edit-calendar-trigger').addEventListener('click', function () {
                            $("#edit-issue-date").persianDatepicker('show');
                        });
                        
                        updateInvoiceItemsList();
                        
                        $('#invoice-details').show();
                        
                        $('html, body').animate({
                            scrollTop: $('#invoice-details').offset().top - 50
                        }, 500);
                        
                    } else {
                        showMessage(data.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    hideLoadingModal();
                    console.error('Error getting invoice details:', error);
                    showMessage('خطا در دریافت اطلاعات فاکتور', 'error');
                }
            });
        });
        
        // به روزرسانی لیست آیتم‌های فاکتور
        function updateInvoiceItemsList() {
            const $itemsList = $('#invoice-items-list');
            $itemsList.empty();
            
            if (editingInvoiceItems.length === 0) {
                $itemsList.html(`
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            هیچ کالایی در این فاکتور وجود ندارد
                        </td>
                    </tr>
                `);
                return;
            }
            
            editingInvoiceItems.forEach((item, index) => {
                const row = `
                    <tr class="item-row" data-item-index="${index}">
                        <td data-label="نام کالا">
                            <div class="product-search-container">
                                <input type="text" class="product-search-input product-name" name="product_name[]" value="${item.product_name || ''}" placeholder="جستجوی نام کالا" required>
                                <input type="hidden" name="item_id[]" value="${item.id || ''}">
                            </div>
                        </td>
                        <td data-label="قیمت خرید">
                            <input type="number" class="unit-price price-input" name="unit_price[]" value="${item.unit_price || 0}" min="0" step="100" required>
                            <div class="price-words"></div>
                        </td>
                        <td data-label="تعداد">
                            <input type="number" name="quantity[]" value="${item.quantity || 1}" min="1" required>
                        </td>
                        <td data-label="جمع کل">
                            <input type="number" class="line-total-input" readonly>
                            <div class="price-words"></div>
                        </td>
                        <td data-label="تخفیف">
                            <input type="number" name="discount[]" value="${item.discount || 0}" min="0" step="100">
                        </td>
                        <td data-label="عملیات">
                            <button type="button" class="btn btn-danger remove-item" data-index="${index}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `;
                $itemsList.append(row);
                
                const quantity = parseInt(item.quantity) || 0;
                const unitPrice = parseFloat(item.unit_price) || 0;
                const lineTotal = quantity * unitPrice;
                
                $itemsList.find('tr:last-child .line-total-input').val(lineTotal);
                updatePriceWords($itemsList.find('tr:last-child .line-total-input'));
                updatePriceWords($itemsList.find('tr:last-child .unit-price'));
                
                initProductSearchForEdit($itemsList.find('tr:last-child .product-name'));
            });
            
            calculateTotals();
        }
        
        // افزودن آیتم جدید
        $('#add-item-btn').click(function() {
            const newIndex = editingInvoiceItems.length;
            const newRow = `
                <tr class="item-row" data-item-index="${newIndex}">
                    <td data-label="نام کالا">
                        <div class="product-search-container">
                            <input type="text" class="product-search-input product-name" name="product_name[]" placeholder="جستجوی نام کالا" required>
                            <input type="hidden" name="item_id[]" value="">
                        </div>
                    </td>
                    <td data-label="قیمت خرید">
                        <input type="number" class="unit-price price-input" name="unit_price[]" min="0" step="100" value="0" required>
                        <div class="price-words"></div>
                    </td>
                    <td data-label="تعداد">
                        <input type="number" name="quantity[]" value="1" min="1" required>
                    </td>
                    <td data-label="جمع کل">
                        <input type="number" class="line-total-input" readonly>
                        <div class="price-words"></div>
                    </td>
                    <td data-label="تخفیف">
                        <input type="number" name="discount[]" value="0" min="0" step="100">
                    </td>
                    <td data-label="عملیات">
                        <button type="button" class="btn btn-danger remove-item" data-index="${newIndex}">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                </tr>
            `;
            
            $('#invoice-items-list').append(newRow);
            editingInvoiceItems.push({
                product_name: '',
                quantity: 1,
                unit_price: 0,
                discount: 0,
                id: null
            });
            
            initProductSearchForEdit($('#invoice-items-list tr:last-child .product-name'));
            
            $('#invoice-items-list tr:last-child input').on('input', calculateTotals);
            
            $('#invoice-items-list tr:last-child .unit-price').on('input', function() {
                updatePriceWords($(this));
            });
            
            calculateTotals();
            
            setTimeout(() => {
                $('#invoice-items-list tr:last-child .product-name').focus();
            }, 100);
        });
        
        // حذف آیتم
        $(document).on('click', '.remove-item', function() {
            const index = $(this).data('index');
            if (editingInvoiceItems.length > 1) {
                $(this).closest('tr').remove();
                editingInvoiceItems.splice(index, 1);
                
                $('.item-row').each(function(i) {
                    $(this).attr('data-item-index', i);
                    $(this).find('.remove-item').attr('data-index', i);
                });
                
                calculateTotals();
                
                showMessage('کالا با موفقیت حذف شد', 'success');
            } else {
                showMessage('حداقل یک کالا باید وجود داشته باشد', 'error');
            }
        });
        
        // محاسبه هنگام تغییر مقادیر
        $(document).on('input', 'input[name="quantity[]"], input[name="unit_price[]"], input[name="discount[]"]', function() {
            const totals = calculateTotals();
            
            const $row = $(this).closest('tr');
            const quantity = parseInt($row.find('input[name="quantity[]"]').val()) || 0;
            const unitPrice = parseFloat($row.find('input[name="unit_price[]"]').val()) || 0;
            const lineTotal = quantity * unitPrice;
            $row.find('.line-total-input').val(lineTotal);
            updatePriceWords($row.find('.line-total-input'));
        });
        
        // به‌روزرسانی مبلغ به حروف هنگام تغییر قیمت
        $(document).on('input', '.unit-price', function() {
            updatePriceWords($(this));
        });
        
        // =============================================
        // توابع مدیریت مودال و ثبت فاکتور
        // =============================================
        
        /**
         * نمایش مودال انتظار
         */
        function showLoadingModal(message = 'در حال ذخیره تغییرات...') {
            $('#loadingMessage').text(message);
            $('#loadingProgress').html('');
            $('#loadingModal').fadeIn(300);
            $('body').addClass('page-disabled');
            
            $('#edit-invoice-submit-btn').prop('disabled', true);
            $('#add-item-btn, .remove-item, #edit-invoice-back-btn').prop('disabled', true);
            $('input, select, textarea').prop('disabled', true);
        }
        
        /**
         * پنهان کردن مودال انتظار
         */
        function hideLoadingModal() {
            $('#loadingModal').fadeOut(300);
            $('body').removeClass('page-disabled');
            
            $('#edit-invoice-submit-btn').prop('disabled', false);
            $('#add-item-btn, .remove-item, #edit-invoice-back-btn').prop('disabled', false);
            $('input, select, textarea').prop('disabled', false);
        }
        
        /**
         * نمایش موفقیت و بازگشت
         */
        function showSuccessAndRedirect() {
            $('#loadingMessage').text('تغییرات با موفقیت ذخیره شد!');
            $('.loading-spinner i')
                .removeClass('fa-spinner fa-spin')
                .addClass('fa-check-circle')
                .css('color', '#4CAF50');
            
            $('#loadingProgress').html('<i class="fas fa-check-circle"></i> تمام عملیات با موفقیت انجام شد.');
            
            setTimeout(() => {
                hideLoadingModal();
                
                showMessage('تغییرات با موفقیت ذخیره شد. در حال بارگذاری مجدد صفحه...', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            }, 2000);
        }
        
        /**
         * نمایش خطا
         */
        function showErrorAndReset(message) {
            $('#loadingMessage').text('خطا در ذخیره تغییرات');
            $('.loading-spinner i')
                .removeClass('fa-spinner fa-spin')
                .addClass('fa-times-circle')
                .css('color', '#F44336');
            
            $('#loadingProgress').html(`<i class="fas fa-times-circle"></i> ${message}`);
            
            setTimeout(() => {
                hideLoadingModal();
                showMessage(message, 'error');
                isSubmitting = false;
            }, 2000);
        }
        
        // ثبت تغییرات
        $('#edit-invoice-submit-btn').click(function() {
            if (isSubmitting) {
                showMessage('در حال ذخیره تغییرات هستید، لطفاً منتظر بمانید', 'warning');
                return;
            }
            
            if (!editingInvoice) {
                showMessage('لطفاً ابتدا یک فاکتور انتخاب کنید', 'error');
                return;
            }
            
            // جمع‌آوری داده‌های فرم
            const formData = {
                invoice_id: $('#invoice-id').val(),
                issue_date: $('#edit-issue-date').val(),
                items: []
            };
            
            let isValid = true;
            let validationError = '';
            
            // اعتبارسنجی آیتم‌ها
            $('.item-row').each(function() {
                const productName = $(this).find('input[name="product_name[]"]').val().trim();
                const quantity = $(this).find('input[name="quantity[]"]').val();
                const unitPrice = $(this).find('input[name="unit_price[]"]').val();
                const discount = $(this).find('input[name="discount[]"]').val();
                const itemId = $(this).find('input[name="item_id[]"]').val();
                
                if (!productName) {
                    isValid = false;
                    validationError = 'لطفاً نام کالا را وارد کنید';
                    return false;
                }
                
                if (!quantity || quantity <= 0) {
                    isValid = false;
                    validationError = 'لطفاً تعداد معتبر وارد کنید';
                    return false;
                }
                
                if (!unitPrice || unitPrice <= 0) {
                    isValid = false;
                    validationError = 'لطفاً قیمت معتبر وارد کنید';
                    return false;
                }
                
                formData.items.push({
                    id: itemId || '',
                    product_name: productName,
                    quantity: quantity,
                    unit_price: unitPrice,
                    discount: discount || 0
                });
            });
            
            if (!isValid) {
                isSubmitting = false;
                showMessage(validationError, 'error');
                return;
            }
            
            // نمایش تاییدیه
            const confirmationMessage = 
                'آیا از ذخیره تغییرات اطمینان دارید؟\n\n' +
                'توجه: این تغییرات ممکن است بر موارد زیر تأثیر بگذارد:\n' +
                '• قیمت‌گذاری کالاها\n' +
                '• موجودی انبار\n' +
                '• قیمت فروش کالاها';
            
            if (!confirm(confirmationMessage)) {
                return;
            }
            
            // علامت‌گذاری که در حال ثبت هستیم
            isSubmitting = true;
            
            // نمایش مودال انتظار
            showLoadingModal('در حال ذخیره تغییرات...');
            
            // مرحله‌بندی عملیات
            setTimeout(() => {
                $('#loadingProgress').html('<i class="fas fa-sync fa-spin"></i> مرحله 1: در حال بررسی تغییرات...');
            }, 1000);
            
            setTimeout(() => {
                $('#loadingProgress').html('<i class="fas fa-sync fa-spin"></i> مرحله 2: در حال بروزرسانی اطلاعات کالاها...');
            }, 3000);
            
            setTimeout(() => {
                $('#loadingProgress').html('<i class="fas fa-sync fa-spin"></i> مرحله 3: در حال محاسبه قیمت‌های جدید...');
            }, 5000);
            
            // ارسال درخواست به سرور
            $.ajax({
                url: "{% url 'update_invoice' %}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        // نمایش خلاصه تغییرات
                        const changes = data.changes_summary;
                        let summaryHtml = '';
                        
                        if (changes.name_changes_count > 0 || changes.price_changes_count > 0) {
                            summaryHtml += '<div style="text-align: right; margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;">';
                            summaryHtml += '<h4 style="color: #4CAF50; margin-bottom: 10px;"><i class="fas fa-clipboard-list"></i> خلاصه تغییرات اعمال شده:</h4>';
                            
                            if (changes.name_changes_count > 0) {
                                summaryHtml += '<p style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">تغییر نام کالاها:</p>';
                                changes.name_changes.forEach(change => {
                                    summaryHtml += `<p style="padding: 5px 10px; background: #e8f5e9; border-radius: 4px; margin-bottom: 5px;">
                                        <i class="fas fa-arrow-left" style="color: #4CAF50;"></i> 
                                        <span style="text-decoration: line-through; color: #666;">${change[0]}</span> 
                                        <i class="fas fa-long-arrow-alt-right" style="color: #4CAF50;"></i> 
                                        <strong>${change[1]}</strong>
                                    </p>`;
                                });
                            }
                            
                            if (changes.price_changes_count > 0) {
                                summaryHtml += '<p style="font-weight: bold; color: #2c3e50; margin-top: 15px; margin-bottom: 8px;">تغییر قیمت‌ها:</p>';
                                changes.price_changes.forEach(change => {
                                    summaryHtml += `<p style="padding: 5px 10px; background: #fff3e0; border-radius: 4px; margin-bottom: 5px;">
                                        <i class="fas fa-dollar-sign" style="color: #f39c12;"></i> 
                                        <strong>${change[0]}</strong>: 
                                        ${Number(change[1]).toLocaleString('fa-IR')} تومان
                                    </p>`;
                                });
                            }
                            
                            summaryHtml += '</div>';
                            $('#loadingProgress').html(summaryHtml);
                        } else {
                            $('#loadingProgress').html('<i class="fas fa-check-circle" style="color: #4CAF50;"></i> هیچ تغییر خاصی در کالاها شناسایی نشد.');
                        }
                        
                        // نمایش موفقیت و بازگشت
                        setTimeout(() => {
                            $('#loadingMessage').text('تغییرات با موفقیت ذخیره شد!');
                            $('.loading-spinner i')
                                .removeClass('fa-spinner fa-spin')
                                .addClass('fa-check-circle')
                                .css('color', '#4CAF50');
                            
                            setTimeout(() => {
                                showSuccessAndRedirect();
                            }, 3000);
                        }, 2000);
                    } else {
                        // نمایش خطا
                        showErrorAndReset(data.error || 'خطا در ذخیره تغییرات');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating invoice:', error);
                    let errorMessage = 'خطا در ارتباط با سرور';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    showErrorAndReset(errorMessage);
                },
                complete: function() {
                    setTimeout(() => {
                        isSubmitting = false;
                    }, 1000);
                }
            });
        });
        
        // بازگشت
        $('#edit-invoice-back-btn').click(function() {
            if (editingInvoice) {
                if (confirm('تغییرات ذخیره نشده از بین خواهند رفت. آیا مطمئن هستید؟')) {
                    window.location.href = "{% url 'home' %}";
                }
            } else {
                window.location.href = "{% url 'home' %}";
            }
        });
        
        // مخفی کردن نتایج جستجو هنگام کلیک خارج
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.search-container').length) {
                $('#edit-invoice-search-results').hide();
            }
            
            $('.product-search-results').each(function() {
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0) {
                    $(this).hide();
                }
            });
        });
        
        // کلیدهای میانبر
        $(document).on('keydown', function(e) {
            // Ctrl + Enter برای ذخیره
            if (e.ctrlKey && e.key === 'Enter') {
                if ($('#edit-invoice-submit-btn').is(':visible') && !$('#edit-invoice-submit-btn').is(':disabled')) {
                    e.preventDefault();
                    $('#edit-invoice-submit-btn').click();
                }
            }
            
            // Escape برای بازگشت
            if (e.key === 'Escape') {
                if ($('#edit-invoice-back-btn').is(':visible')) {
                    e.preventDefault();
                    $('#edit-invoice-back-btn').click();
                }
            }
        });
        
        $(document).ready(function() {
            console.log('صفحه ویرایش فاکتور لود شد');
            
            // مدیریت نمایش ریسپانسیو در موبایل
            function checkMobileView() {
                if ($(window).width() <= 768) {
                    $('.invoice-table thead').hide();
                    $('.item-row').addClass('mobile-view');
                } else {
                    $('.invoice-table thead').show();
                    $('.item-row').removeClass('mobile-view');
                }
            }
            
            $(window).on('load resize', checkMobileView);
            checkMobileView();
            
            console.log('راهنمای میانبر:');
            console.log('• Ctrl + Enter: ذخیره تغییرات');
            console.log('• Escape: بازگشت به صفحه اصلی');
        });
    </script>
</body>
</html>
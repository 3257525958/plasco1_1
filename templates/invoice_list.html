{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لیست فاکتورها</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #388E3C;
            --accent-color: #1B5E20;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --info-color: #2196F3;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --gradient-primary: linear-gradient(135deg, #2E7D32, #4CAF50);
            --gradient-success: linear-gradient(135deg, #4CAF50, #66BB6A);
            --gradient-warning: linear-gradient(135deg, #FF9800, #FFB74D);
            --gradient-danger: linear-gradient(135deg, #F44336, #EF5350);
            --gradient-info: linear-gradient(135deg, #2196F3, #42A5F5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-color);
            direction: rtl;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        .branch-info {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
        }

        .section-card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--gradient-success);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #FFB74D, #FFCC80);
            transform: translateY(-2px);
        }

        .btn-info {
            background: var(--gradient-info);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #42A5F5, #64B5F6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: #78909c;
            color: white;
        }

        .btn-secondary:hover {
            background: #546e7a;
            transform: translateY(-2px);
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .invoice-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .invoice-table td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: background 0.2s;
        }

        .invoice-table tr:hover td {
            background-color: #f8f9fa;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .checkbox-cell {
            width: 50px;
        }

        .selection-actions {
            margin-bottom: 15px;
        }

        .selection-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 20px;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .bg-success {
            background: var(--success-color) !important;
        }

        .bg-warning {
            background: var(--warning-color) !important;
        }

        .bg-danger {
            background: var(--danger-color) !important;
        }

        .progress-container {
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-success);
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .distribution-details {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid var(--info-color);
            max-height: 300px;
            overflow-y: auto;
        }

        .distribution-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .distribution-item:last-child {
            border-bottom: none;
        }

        .progress-stages {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .progress-stage {
            text-align: center;
            flex: 1;
            padding: 5px;
        }

        .progress-stage.active {
            color: var(--success-color);
            font-weight: bold;
        }

        .task-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            
            .invoice-table {
                font-size: 0.8rem;
            }
            
            .invoice-table th,
            .invoice-table td {
                padding: 8px 5px;
            }
            
            .section-card {
                padding: 12px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                min-width: 100%;
            }

            .progress-info {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-list"></i> لیست فاکتورها</h1>
        </div>

        <div class="branch-info">
            <i class="fas fa-store"></i> سیستم مدیریت فاکتورها | 
            <i class="fas fa-user"></i> کاربر: ادمین
        </div>

        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-receipt"></i> مدیریت فاکتورها</h3>
            
            <!-- فرم اصلی -->
            <form method="post" id="invoiceForm">
                {% csrf_token %}
                <input type="hidden" name="action_type" id="actionType" value="">
                
                <!-- دکمه‌های انتخاب -->
                <div class="selection-actions">
                    <button type="button" class="btn btn-primary btn-sm" id="selectAll">
                        <i class="fas fa-check-square"></i> انتخاب همه
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="deselectAll">
                        <i class="fas fa-times-circle"></i> لغو انتخاب همه
                    </button>
                </div>

                <!-- جدول فاکتورها -->
                <div class="table-responsive">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th>ردیف</th>
                                <th>شماره سریال</th>
                                <th>فروشنده</th>
                                <th>تاریخ فاکتور</th>
                                <th>تاریخ صدور</th>
                                <th>تعداد آیتم‌ها</th>
                                <th>تعداد کل</th>
                                <th>تعداد باقیمانده</th>
                                <th>وضعیت</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_invoices" value="{{ invoice.id }}" class="invoice-checkbox">
                                </td>
                                <td>
                                    <strong>{{ forloop.counter }}</strong>
                                </td>
                                <td>
                                    <strong>{{ invoice.serial_number }}</strong>
                                </td>
                                <td>{{ invoice.seller }}</td>
                                <td>{{ invoice.jalali_date }}</td>
                                <td>{{ invoice.issue_date|date:"Y/m/d" }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ invoice.items.count }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ invoice.total_quantity }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if invoice.total_remaining > 0 %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ invoice.total_remaining }}
                                    </span>
                                </td>
                                <td>
                                    {% if invoice.total_remaining == invoice.total_quantity %}
                                        <span class="status-badge bg-success">کامل</span>
                                    {% elif invoice.total_remaining == 0 %}
                                        <span class="status-badge bg-danger">اتمام</span>
                                    {% else %}
                                        <span class="status-badge bg-warning">
                                            جزیی ({{ invoice.total_remaining }}/{{ invoice.total_quantity }})
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">هیچ فاکتوری یافت نشد.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- دکمه‌های اقدام اصلی -->
                <div class="action-buttons mt-4">
                    <button type="button" class="btn btn-secondary" onclick="location.href='/'">
                        <i class="fas fa-arrow-right"></i> بازگشت به صفحه اصلی
                    </button>
                    <button type="button" class="btn btn-warning" id="resetButton">
                        <i class="fas fa-redo"></i> ریست کردن تعداد باقیمانده
                    </button>
                    <button type="button" class="btn btn-info" id="distributeButton">
                        <i class="fas fa-warehouse"></i> توزیع مساوی در انبار
                    </button>
                    <button type="button" class="btn btn-danger" id="deletePricingButton">
                        <i class="fas fa-trash-alt"></i> پاک کردن دیتای قیمت‌ها
                    </button>
                    <button type="button" class="btn btn-danger" id="clearInventoryButton">
                        <i class="fas fa-trash-alt"></i> پاک کردن تمام داده‌های انبار
                    </button>
                </div>            
            </form>
        </div>
    </div>

    <!-- مودال تایید پاک کردن دیتای قیمت‌ها -->
    <div class="modal fade" id="deletePricingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger"></i> تایید پاک کردن دیتای قیمت‌ها</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-money-bill-wave"></i>
                        <strong>هشدار جدی:</strong> این عملیات <strong class="text-danger">تمام داده‌های قیمت‌گذاری محصولات</strong> را به طور کامل پاک خواهد کرد.
                    </div>
                    <ul class="mb-3">
                        <li>تمام records های جدول قیمت‌گذاری حذف خواهند شد</li>
                        <li>این عملیات <strong>غیرقابل بازگشت</strong> است</li>
                        <li>پس از پاک‌سازی، باید داده‌های قیمت‌گذاری جدید را مجدداً وارد کنید</li>
                    </ul>
                    <p class="mb-0"><strong>آیا از انجام این عملیات اطمینان دارید؟</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> لغو عملیات
                    </button>
                    <form method="post" action="{% url 'delete_all_product_pricing' %}" id="deletePricingForm" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-check"></i> بله، پاک کردن داده‌های قیمت
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال نمایش پیشرفت توزیع -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-sync-alt fa-spin"></i> در حال توزیع کالاها...
                        <small class="d-block mt-1" id="taskIdDisplay"></small>
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong id="progressMainMessage">آماده‌سازی عملیات...</strong>
                        <div class="mt-2 small">
                            <i class="fas fa-clock"></i>
                            <span id="progressTime">شروع شده در: --:--:--</span>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-info">
                            <span id="currentInvoiceInfo">در حال آماده‌سازی...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-success" id="progressFill" style="width: 0%">
                                <span>0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-stages" id="progressStages">
                        <div class="progress-stage active" data-stage="1">آماده‌سازی</div>
                        <div class="progress-stage" data-stage="2">بارگذاری داده‌ها</div>
                        <div class="progress-stage" data-stage="3">گروه‌بندی کالاها</div>
                        <div class="progress-stage" data-stage="4">قیمت‌گذاری</div>
                        <div class="progress-stage" data-stage="5">توزیع</div>
                        <div class="progress-stage" data-stage="6">ذخیره‌سازی</div>
                        <div class="progress-stage" data-stage="7">تکمیل</div>
                    </div>
                    
                    <div class="distribution-details mt-3">
                        <h6><i class="fas fa-info-circle"></i> جزئیات عملیات:</h6>
                        <div id="distributionDetails">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i>
                                در حال بارگذاری جزئیات...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="progressCloseBtn" disabled>
                        <i class="fas fa-hourglass-half"></i> در حال پردازش...
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تایید ریست -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning"></i> تایید عملیات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        <strong>توجه:</strong> با این کار، <strong>تعداد باقیمانده</strong> برای آیتم‌های فاکتور(های) انتخاب شده، با <strong>تعداد اولیه</strong> برابر می‌شود.
                    </div>
                    <p class="mb-0">آیا از انجام این عملیات اطمینان دارید؟</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> لغو
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmReset">
                        <i class="fas fa-check"></i> تایید و ادامه
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تایید پاک کردن تمام داده‌های انبار -->
    <div class="modal fade" id="clearInventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger"></i> تایید پاک کردن تمام داده‌های انبار</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-skull-crossbones"></i>
                        <strong>هشدار جدی:</strong> این عملیات <strong class="text-danger">تمام داده‌های موجود در مدل InventoryCount</strong> را به طور کامل پاک خواهد کرد.
                    </div>
                    <ul class="mb-3">
                        <li>تمام records های جدول انبار حذف خواهند شد</li>
                        <li>این عملیات <strong>غیرقابل بازگشت</strong> است</li>
                        <li>پس از پاک‌سازی، باید داده‌های جدید را مجدداً وارد کنید</li>
                    </ul>
                    <p class="mb-0"><strong>آیا از انجام این عملیات اطمینان دارید؟</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> لغو عملیات
                    </button>
                    <form method="post" action="{% url 'clear_inventory' %}" id="clearInventoryForm" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-check"></i> بله، پاک کردن تمام داده‌ها
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تایید توزیع -->
    <div class="modal fade" id="distributionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-warehouse text-info"></i> تایید توزیع در انبار</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>ویژگی‌های توزیع هوشمند:</strong>
                        <ul class="mt-2 mb-0">
                            <li>کالاهای تکراری در فاکتورهای مختلف <strong>جمع‌زنی</strong> می‌شوند</li>
                            <li>توزیع <strong>تقریباً مساوی</strong> بین تمام شعب انجام می‌شود</li>
                            <li>اگر کالا از قبل در انبار وجود داشته باشد، <strong>تعداد اضافه</strong> می‌شود</li>
                            <li><strong>تعداد باقیمانده تمام آیتم‌ها صفر خواهد شد</strong></li>
                            <li>این عملیات غیرقابل بازگشت است</li>
                            <li><strong>درصد سود: ۷۰٪</strong></li>
                        </ul>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-lightbulb"></i>
                        <strong>مثال:</strong> اگر "قاشق" در ۲ فاکتور با مجموع ۱۰ عدد باشد، بین شعب تقسیم می‌شود (نه ۲ بار ثبت می‌شود)
                    </div>
                    <div class="alert alert-success">
                        <i class="fas fa-bolt"></i>
                        <strong>بهینه‌سازی:</strong> این عملیات برای داده‌های حجیم بهینه‌سازی شده و با هر سرعت اینترنتی کار می‌کند.
                    </div>
                    <p class="mb-0">آیا از انجام این عملیات اطمینان دارید؟</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> لغو
                    </button>
                    <button type="button" class="btn btn-info" id="confirmDistribution">
                        <i class="fas fa-check"></i> تایید و توزیع هوشمند
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentTaskId = null;
            let progressCheckInterval = null;
            let startTime = null;

            // انتخاب همه
            $('#selectAllCheckbox, #selectAll').on('click', function() {
                $('.invoice-checkbox').prop('checked', true);
                updateSelectionCount();
            });

            // لغو انتخاب همه
            $('#deselectAll').on('click', function() {
                $('.invoice-checkbox').prop('checked', false);
                updateSelectionCount();
            });

            // مدیریت دکمه ریست
            $('#resetButton').on('click', function() {
                var selectedInvoices = $('input[name="selected_invoices"]:checked');
                
                if (selectedInvoices.length === 0) {
                    showAlert('warning', 'لطفاً حداقل یک فاکتور را انتخاب کنید.');
                    return;
                }

                // نمایش مودال تایید
                var confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                confirmationModal.show();
            });

            // مدیریت دکمه توزیع
            $('#distributeButton').on('click', function() {
                var selectedInvoices = $('input[name="selected_invoices"]:checked');
                
                if (selectedInvoices.length === 0) {
                    showAlert('warning', 'لطفاً حداقل یک فاکتور را انتخاب کنید.');
                    return;
                }

                // نمایش مودال تایید توزیع
                var distributionModal = new bootstrap.Modal(document.getElementById('distributionModal'));
                distributionModal.show();
            });

            // مدیریت دکمه پاک کردن انبار
            $('#clearInventoryButton').on('click', function() {
                // نمایش مودال تایید
                var clearInventoryModal = new bootstrap.Modal(document.getElementById('clearInventoryModal'));
                clearInventoryModal.show();
            });

            // مدیریت دکمه پاک کردن دیتای قیمت‌ها
            $('#deletePricingButton').on('click', function() {
                // نمایش مودال تایید
                var deletePricingModal = new bootstrap.Modal(document.getElementById('deletePricingModal'));
                deletePricingModal.show();
            });
            
            // تایید ریست در مودال
            $('#confirmReset').on('click', function() {
                $('#invoiceForm').attr('action', "{% url 'reset_remaining_quantity' %}");
                $('#invoiceForm').submit();
                $('#confirmationModal').modal('hide');
            });

            // تایید توزیع در مودال
            $('#confirmDistribution').on('click', function() {
                $('#distributionModal').modal('hide');
                startDistribution();
            });

            // هماهنگی چک‌باکس هدر با بقیه
            $('#selectAllCheckbox').on('change', function() {
                $('.invoice-checkbox').prop('checked', this.checked);
                updateSelectionCount();
            });

            $('.invoice-checkbox').on('change', function() {
                if (!$('.invoice-checkbox:checked').length) {
                    $('#selectAllCheckbox').prop('checked', false);
                } else if ($('.invoice-checkbox:checked').length === $('.invoice-checkbox').length) {
                    $('#selectAllCheckbox').prop('checked', true);
                }
                updateSelectionCount();
            });

            // تابع شروع توزیع
            function startDistribution() {
                // نمایش مودال پیشرفت
                var progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();
                
                // تنظیم زمان شروع
                startTime = new Date();
                updateTimeDisplay();
                
                // ارسال درخواست توزیع
                distributeSelectedInvoices();
            }

            // تابع ارسال درخواست توزیع
            function distributeSelectedInvoices() {
                var formData = new FormData($('#invoiceForm')[0]);
                
                $.ajax({
                    url: "{% url 'distribute_inventory' %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function() {
                        resetProgressDisplay();
                    },
                    success: function(response) {
                        if (response.success) {
                            currentTaskId = response.task_id;
                            $('#taskIdDisplay').html('<small class="task-id">شناسه کار: ' + response.task_id + '</small>');
                            // شروع بررسی پیشرفت
                            startProgressChecking();
                        } else {
                            showAlert('error', 'خطا: ' + response.error);
                            $('#progressModal').modal('hide');
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMsg = 'خطا در ارسال درخواست: ' + error;
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        showAlert('error', errorMsg);
                        $('#progressModal').modal('hide');
                    }
                });
            }

            // شروع بررسی پیشرفت
            function startProgressChecking() {
                if (progressCheckInterval) {
                    clearInterval(progressCheckInterval);
                }
                
                progressCheckInterval = setInterval(function() {
                    checkProgress();
                }, 1500); // هر 1.5 ثانیه بررسی کن
            }

            // بررسی پیشرفت
            function checkProgress() {
                if (!currentTaskId) return;
                
                $.ajax({
                    url: "{% url 'check_distribution_progress' %}?task_id=" + currentTaskId,
                    type: 'GET',
                    success: function(response) {
                        updateProgressDisplay(response);
                        
                        // اگر عملیات کامل شد
                        if (response.status === 'completed' || response.percentage >= 100) {
                            completeProgress();
                        } else if (response.status === 'not_found') {
                            // اگر وضعیت یافت نشد
                            $('#currentInvoiceInfo').html(
                                '<i class="fas fa-exclamation-triangle text-warning"></i> وضعیت پیشرفت یافت نشد'
                            );
                        }
                    },
                    error: function() {
                        $('#currentInvoiceInfo').html(
                            '<i class="fas fa-exclamation-triangle text-danger"></i> خطا در بررسی وضعیت'
                        );
                    }
                });
            }

            // به‌روزرسانی نمایش پیشرفت
            function updateProgressDisplay(response) {
                // به‌روزرسانی نوار پیشرفت
                let percentage = Math.min(response.percentage, 100);
                $('#progressFill').css('width', percentage + '%')
                                  .text(percentage.toFixed(1) + '%');
                $('#progressPercentage').text(percentage.toFixed(1) + '%');
                
                // به‌روزرسانی پیام اصلی
                $('#currentInvoiceInfo').html(
                    '<i class="fas fa-sync-alt fa-spin"></i> ' + response.message
                );
                $('#progressMainMessage').text(response.message);
                
                // به‌روزرسانی جزئیات
                if (response.details && response.details.length > 0) {
                    let detailsHtml = '';
                    response.details.forEach(function(detail) {
                        detailsHtml += '<div class="distribution-item">' +
                                       '<span><i class="fas fa-check-circle text-success"></i> ' + detail + '</span>' +
                                       '</div>';
                    });
                    $('#distributionDetails').html(detailsHtml);
                }
                
                // به‌روزرسانی مراحل
                updateProgressStages(percentage);
                
                // به‌روزرسانی زمان
                updateTimeDisplay();
            }

            // به‌روزرسانی مراحل پیشرفت
            function updateProgressStages(percentage) {
                const stages = $('.progress-stage');
                stages.removeClass('active');
                
                if (percentage < 10) {
                    $(stages[0]).addClass('active');
                } else if (percentage < 25) {
                    $(stages[1]).addClass('active');
                } else if (percentage < 40) {
                    $(stages[2]).addClass('active');
                } else if (percentage < 50) {
                    $(stages[3]).addClass('active');
                } else if (percentage < 85) {
                    $(stages[4]).addClass('active');
                } else if (percentage < 98) {
                    $(stages[5]).addClass('active');
                } else {
                    $(stages[6]).addClass('active');
                }
            }

            // تکمیل پیشرفت
            function completeProgress() {
                if (progressCheckInterval) {
                    clearInterval(progressCheckInterval);
                    progressCheckInterval = null;
                }
                
                // تغییر وضعیت دکمه
                $('#progressCloseBtn')
                    .removeClass('btn-secondary')
                    .addClass('btn-success')
                    .html('<i class="fas fa-check"></i> توزیع کامل شد - کلیک کنید')
                    .prop('disabled', false)
                    .off('click')
                    .on('click', function() {
                        $('#progressModal').modal('hide');
                        location.reload();
                    });
                
                // نمایش پیام نهایی
                $('#currentInvoiceInfo').html(
                    '<i class="fas fa-check-circle text-success"></i> توزیع با موفقیت انجام شد!'
                );
                $('#progressMainMessage').html(
                    '<i class="fas fa-check-circle text-success"></i> <strong>عملیات با موفقیت تکمیل شد</strong>'
                );
                
                // پخش صدای اعلان
                playCompletionSound();
            }

            // ریست نمایش پیشرفت
            function resetProgressDisplay() {
                $('#progressFill').css('width', '0%').text('0%');
                $('#progressPercentage').text('0%');
                $('#currentInvoiceInfo').html('<i class="fas fa-spinner fa-spin"></i> در حال آماده‌سازی...');
                $('#progressMainMessage').text('آماده‌سازی عملیات...');
                $('#distributionDetails').html(
                    '<div class="text-center text-muted py-3">' +
                    '<i class="fas fa-spinner fa-spin"></i> در حال بارگذاری جزئیات...' +
                    '</div>'
                );
                $('#taskIdDisplay').empty();
                
                // ریست دکمه
                $('#progressCloseBtn')
                    .removeClass('btn-success')
                    .addClass('btn-secondary')
                    .html('<i class="fas fa-hourglass-half"></i> در حال پردازش...')
                    .prop('disabled', true);
            }

            // به‌روزرسانی زمان
            function updateTimeDisplay() {
                if (!startTime) return;
                
                const now = new Date();
                const diffMs = now - startTime;
                const diffSec = Math.floor(diffMs / 1000);
                const minutes = Math.floor(diffSec / 60);
                const seconds = diffSec % 60;
                
                $('#progressTime').html(
                    '<i class="fas fa-clock"></i> مدت زمان: ' + 
                    minutes.toString().padStart(2, '0') + ':' + 
                    seconds.toString().padStart(2, '0')
                );
            }

            // نمایش آلرت
            function showAlert(type, message) {
                let icon = 'info-circle';
                let color = 'info';
                
                switch(type) {
                    case 'success':
                        icon = 'check-circle';
                        color = 'success';
                        break;
                    case 'warning':
                        icon = 'exclamation-triangle';
                        color = 'warning';
                        break;
                    case 'error':
                        icon = 'times-circle';
                        color = 'danger';
                        break;
                }
                
                // ایجاد آلرت موقت
                const alertHtml = `
                    <div class="alert alert-${color} alert-dismissible fade show position-fixed" 
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                        <i class="fas fa-${icon}"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                $('body').append(alertHtml);
                
                // حذف خودکار بعد از 5 ثانیه
                setTimeout(function() {
                    $('.alert').alert('close');
                }, 5000);
            }

            // پخش صدای اعلان
            function playCompletionSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }

            // به‌روزرسانی تعداد انتخاب شده
            function updateSelectionCount() {
                const selectedCount = $('input[name="selected_invoices"]:checked').length;
                const distributeBtn = $('#distributeButton');
                const resetBtn = $('#resetButton');
                
                if (selectedCount > 0) {
                    distributeBtn.html(`<i class="fas fa-warehouse"></i> توزیع (${selectedCount} فاکتور)`);
                    resetBtn.html(`<i class="fas fa-redo"></i> ریست (${selectedCount} فاکتور)`);
                } else {
                    distributeBtn.html('<i class="fas fa-warehouse"></i> توزیع مساوی در انبار');
                    resetBtn.html('<i class="fas fa-redo"></i> ریست کردن تعداد باقیمانده');
                }
            }

            // اولیه‌سازی
            updateSelectionCount();
        });
    </script>
</body>
</html>
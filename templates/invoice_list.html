{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø­ÙØ¸ Ú©Ù†ÛŒØ¯ */
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #388E3C;
            --accent-color: #1B5E20;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --info-color: #2196F3;
            --text-color: #2c3e50;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --input-bg: #f1f8e9;
            --gradient-primary: linear-gradient(135deg, #2E7D32, #4CAF50);
            --gradient-success: linear-gradient(135deg, #4CAF50, #66BB6A);
            --gradient-warning: linear-gradient(135deg, #FF9800, #FFB74D);
            --gradient-danger: linear-gradient(135deg, #F44336, #EF5350);
            --gradient-info: linear-gradient(135deg, #2196F3, #42A5F5);
        }

        /* ØªÙ…Ø§Ù… Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ */
        /* ... */

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-list"></i> Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h1>
        </div>

        <div class="branch-info">
            <i class="fas fa-store"></i> Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ | 
            <i class="fas fa-user"></i> Ú©Ø§Ø±Ø¨Ø±: Ø§Ø¯Ù…ÛŒÙ†
        </div>

        <div class="section-card">
            <h3 class="section-title"><i class="fas fa-receipt"></i> Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h3>
            
            <!-- ÙØ±Ù… Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª -->
            <form method="post" id="invoiceForm">
                {% csrf_token %}
                <input type="hidden" name="action_type" id="actionType" value="">
                
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ -->
                <div class="selection-actions">
                    <button type="button" class="btn btn-primary btn-sm" id="selectAll">
                        <i class="fas fa-check-square"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="deselectAll">
                        <i class="fas fa-times-circle"></i> Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                    </button>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ -->
                <div class="table-responsive">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th>Ø±Ø¯ÛŒÙ</th>
                                <th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„</th>
                                <th>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</th>
                                <th>ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±</th>
                                <th>ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_invoices" value="{{ invoice.id }}" class="invoice-checkbox">
                                </td>
                                <td>
                                    <strong>{{ forloop.counter }}</strong>
                                </td>
                                <td>
                                    <strong>{{ invoice.serial_number }}</strong>
                                </td>
                                <td>{{ invoice.seller }}</td>
                                <td>{{ invoice.jalali_date }}</td>
                                <td>{{ invoice.issue_date|date:"Y/m/d" }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ invoice.items.count }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ invoice.total_quantity }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if invoice.total_remaining > 0 %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ invoice.total_remaining }}
                                    </span>
                                </td>
                                <td>
                                    {% if invoice.total_remaining == invoice.total_quantity %}
                                        <span class="status-badge bg-success">Ú©Ø§Ù…Ù„</span>
                                    {% elif invoice.total_remaining == 0 %}
                                        <span class="status-badge bg-danger">Ø§ØªÙ…Ø§Ù…</span>
                                    {% else %}
                                        <span class="status-badge bg-warning">
                                            Ø¬Ø²ÛŒÛŒ ({{ invoice.total_remaining }}/{{ invoice.total_quantity }})
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ø§ØµÙ„ÛŒ -->
                <div class="action-buttons mt-4">
                    <button type="button" class="btn btn-secondary" onclick="location.href='/'">
                        <i class="fas fa-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
                    </button>
                    <button type="button" class="btn btn-warning" id="resetButton">
                        <i class="fas fa-redo"></i> Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡
                    </button>
                    <button type="button" class="btn btn-info" id="distributeButton">
                        <i class="fas fa-warehouse"></i> ØªÙˆØ²ÛŒØ¹ Ù…Ø³Ø§ÙˆÛŒ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±
                    </button>
                    <!-- Ø¯Ú©Ù…Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ -->
                    <button type="button" class="btn btn-danger" id="deletePricingButton">
                        <i class="fas fa-trash-alt"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
                    </button>
                    <button type="button" class="btn btn-danger" id="clearInventoryButton">
                        <i class="fas fa-trash-alt"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±
                    </button>
                </div>            
            
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ -->
    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ -->
    <div class="modal fade" id="deletePricingModal" tabindex="-1" aria-hidden="true">
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ø±ÙØª ØªÙˆØ²ÛŒØ¹ REAL-TIME -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-sync-alt fa-spin text-info"></i> Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ²ÛŒØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="progress-container">
                        <div class="progress-info">
                            <span id="currentStageInfo">Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                        </div>
                        <div class="mt-2" id="statsInfo">
                            <small class="text-muted" id="itemsInfo">Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§: 0/0</small>
                            <small class="text-muted ms-3" id="productsInfo">Ú©Ø§Ù„Ø§Ù‡Ø§: 0</small>
                            <small class="text-muted ms-3" id="branchesInfo">Ø´Ø¹Ø¨: 0</small>
                        </div>
                    </div>
                    
                    <div class="distribution-details">
                        <h6><i class="fas fa-info-circle"></i> Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆØ²ÛŒØ¹:</h6>
                        <div id="distributionDetails" style="max-height: 300px; overflow-y: auto;">
                            <!-- Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆØ²ÛŒØ¹ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeProgressModal">
                        <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                    </button>
                    <button type="button" class="btn btn-success d-none" id="reloadButton" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Ø±ÙØ±Ø´ ØµÙØ­Ù‡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø³Ø§ÛŒØ± Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
    </div>
    
    <div class="modal fade" id="clearInventoryModal" tabindex="-1" aria-hidden="true">
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
    </div>
    
    <div class="modal fade" id="distributionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-warehouse text-info"></i> ØªØ§ÛŒÛŒØ¯ ØªÙˆØ²ÛŒØ¹ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ ØªÙˆØ²ÛŒØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯:</strong>
                        <ul class="mt-2 mb-0">
                            <li>Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù <strong>Ø¬Ù…Ø¹â€ŒØ²Ù†ÛŒ</strong> Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
                            <li>ØªÙˆØ²ÛŒØ¹ <strong>ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù…Ø³Ø§ÙˆÛŒ</strong> Ø¨ÛŒÙ† ØªÙ…Ø§Ù… Ø´Ø¹Ø¨ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
                            <li>Ø§Ú¯Ø± Ú©Ø§Ù„Ø§ Ø§Ø² Ù‚Ø¨Ù„ Ø¯Ø± Ø§Ù†Ø¨Ø§Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ <strong>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¶Ø§ÙÙ‡</strong> Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
                            <li><strong>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ØªÙ…Ø§Ù… Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ ØµÙØ± Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</strong></li>
                            <li>Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± background Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ - Ø¨Ø¯ÙˆÙ† timeout</li>
                            <li><strong>Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯: Û·Û°Ùª</strong></li>
                        </ul>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Ù†Ú©ØªÙ‡:</strong> ÙØ±Ø¢ÛŒÙ†Ø¯ ØªÙˆØ²ÛŒØ¹ Ø¯Ø± background Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯ Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ù†ØªÛŒØ¬Ù‡ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
                    </div>
                    <p class="mb-0">Ø¢ÛŒØ§ Ø§Ø² Ø§Ù†Ø¬Ø§Ù… Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Ù„ØºÙˆ
                    </button>
                    <button type="button" class="btn btn-info" id="confirmDistribution">
                        <i class="fas fa-check"></i> ØªØ§ÛŒÛŒØ¯ Ùˆ Ø´Ø±ÙˆØ¹ ØªÙˆØ²ÛŒØ¹
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentTaskId = null;
            let progressInterval = null;

            // Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
            $('#selectAllCheckbox, #selectAll').on('click', function() {
                $('.invoice-checkbox').prop('checked', true);
            });

            // Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
            $('#deselectAll').on('click', function() {
                $('.invoice-checkbox').prop('checked', false);
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª
            $('#resetButton').on('click', function() {
                var selectedInvoices = $('input[name="selected_invoices"]:checked');
                
                if (selectedInvoices.length === 0) {
                    alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return;
                }

                // ØªÙ†Ø¸ÛŒÙ… action Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³Øª
                $('#actionType').val('reset_quantity');
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯
                var confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                confirmationModal.show();
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ ØªÙˆØ²ÛŒØ¹
            $('#distributeButton').on('click', function() {
                var selectedInvoices = $('input[name="selected_invoices"]:checked');
                
                if (selectedInvoices.length === 0) {
                    alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    return;
                }

                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯ ØªÙˆØ²ÛŒØ¹
                var distributionModal = new bootstrap.Modal(document.getElementById('distributionModal'));
                distributionModal.show();
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù†Ø¨Ø§Ø±
            $('#clearInventoryButton').on('click', function() {
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯
                var clearInventoryModal = new bootstrap.Modal(document.getElementById('clearInventoryModal'));
                clearInventoryModal.show();
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
            $('#deletePricingButton').on('click', function() {
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯
                var deletePricingModal = new bootstrap.Modal(document.getElementById('deletePricingModal'));
                deletePricingModal.show();
            });
            
            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø§Ø² Ø·Ø±ÛŒÙ‚ Enter
            $('#deletePricingForm').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                }
            });
            
            $('#clearInventoryForm').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                }
            });

            // ØªØ§ÛŒÛŒØ¯ Ø±ÛŒØ³Øª Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
            $('#confirmReset').on('click', function() {
                $('#invoiceForm').attr('action', "{% url 'reset_remaining_quantity' %}");
                $('#invoiceForm').submit();
                $('#confirmationModal').modal('hide');
            });

            // ØªØ§ÛŒÛŒØ¯ ØªÙˆØ²ÛŒØ¹ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
            $('#confirmDistribution').on('click', function() {
                var selectedInvoices = $('input[name="selected_invoices"]:checked');
                var invoiceIds = selectedInvoices.map(function() { return this.value; }).get();
                
                // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯
                $('#distributionModal').modal('hide');
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ´Ø±ÙØª
                var progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();
                
                // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ´Ø±ÙØª
                resetProgressModal();
                
                // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø±ÙˆØ¹ ØªÙˆØ²ÛŒØ¹
                startDistribution(invoiceIds);
            });

            // Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ Ù‡Ø¯Ø± Ø¨Ø§ Ø¨Ù‚ÛŒÙ‡
            $('#selectAllCheckbox').on('change', function() {
                $('.invoice-checkbox').prop('checked', this.checked);
            });

            $('.invoice-checkbox').on('change', function() {
                if (!$('.invoice-checkbox:checked').length) {
                    $('#selectAllCheckbox').prop('checked', false);
                } else if ($('.invoice-checkbox:checked').length === $('.invoice-checkbox').length) {
                    $('#selectAllCheckbox').prop('checked', true);
                }
            });

            // ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ ØªÙˆØ²ÛŒØ¹
            function startDistribution(invoiceIds) {
                $.ajax({
                    url: "{% url 'distribute_inventory' %}",
                    method: 'POST',
                    data: {
                        'selected_invoices': invoiceIds,
                        'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            currentTaskId = response.task_id;
                            // Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø³â€ŒÙˆØ¬ÙˆÛŒ ÙˆØ¶Ø¹ÛŒØª
                            startPollingStatus();
                        } else {
                            showError('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ ØªÙˆØ²ÛŒØ¹: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + xhr.statusText);
                    }
                });
            }

            // ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø³â€ŒÙˆØ¬ÙˆÛŒ ÙˆØ¶Ø¹ÛŒØª
            function startPollingStatus() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                progressInterval = setInterval(function() {
                    if (!currentTaskId) return;
                    
                    $.getJSON("{% url 'get_distribution_status' 0 %}".replace('0', currentTaskId), function(data) {
                        updateProgress(data);
                        
                        // Ø§Ú¯Ø± Ú©Ø§Ø± ØªÙ…Ø§Ù… Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§ Ø¯Ø§Ø´Øª
                        if (data.status === 'completed' || data.status === 'failed') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            
                            if (data.status === 'completed') {
                                $('#reloadButton').removeClass('d-none');
                                $('#closeProgressModal').addClass('d-none');
                            }
                        }
                    }).fail(function() {
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª ØªÙˆØ²ÛŒØ¹');
                    });
                }, 1000); // Ù‡Ø± 1 Ø«Ø§Ù†ÛŒÙ‡
            }

            // ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ø±ÙØª
            function updateProgress(data) {
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
                $('#progressFill').css('width', data.progress + '%').text(data.progress + '%');
                $('#progressPercentage').text(data.progress + '%');
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ù„ÛŒ
                $('#currentStageInfo').html('<i class="fas fa-sync-alt fa-spin"></i> ' + data.current_stage);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
                $('#itemsInfo').text('Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§: ' + data.distributed_items + '/' + data.total_items);
                $('#productsInfo').text('Ú©Ø§Ù„Ø§Ù‡Ø§: ' + data.products_count);
                $('#branchesInfo').text('Ø´Ø¹Ø¨: ' + data.branches_count);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª
                var detailsHtml = '';
                if (data.details && data.details.length > 0) {
                    data.details.forEach(function(detail) {
                        var icon = 'ğŸ“Œ';
                        if (detail.includes('âœ…')) icon = 'âœ…';
                        else if (detail.includes('âš ï¸')) icon = 'âš ï¸';
                        else if (detail.includes('ğŸ“¦')) icon = 'ğŸ“¦';
                        else if (detail.includes('â±ï¸')) icon = 'â±ï¸';
                        
                        detailsHtml += '<div class="distribution-item">' +
                            '<span>' + icon + ' ' + detail.replace('âœ…', '').replace('âš ï¸', '').replace('ğŸ“¦', '').replace('â±ï¸', '') + '</span>' +
                            '</div>';
                    });
                }
                $('#distributionDetails').html(detailsHtml);
                
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
                $('#distributionDetails').scrollTop($('#distributionDetails')[0].scrollHeight);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                if (data.error) {
                    showError('Ø®Ø·Ø§: ' + data.error);
                }
            }

            // ØªØ§Ø¨Ø¹ Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ´Ø±ÙØª
            function resetProgressModal() {
                $('#progressFill').css('width', '0%').text('0%');
                $('#progressPercentage').text('0%');
                $('#currentStageInfo').text('Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ...');
                $('#itemsInfo').text('Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§: 0/0');
                $('#productsInfo').text('Ú©Ø§Ù„Ø§Ù‡Ø§: 0');
                $('#branchesInfo').text('Ø´Ø¹Ø¨: 0');
                $('#distributionDetails').html('');
                $('#reloadButton').addClass('d-none');
                $('#closeProgressModal').removeClass('d-none');
            }

            // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
            function showError(message) {
                $('#distributionDetails').append(
                    '<div class="distribution-item text-danger">' +
                    '<span><i class="fas fa-exclamation-circle"></i> ' + message + '</span>' +
                    '</div>'
                );
            }

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† interval Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
            $('#progressModal').on('hidden.bs.modal', function() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                currentTaskId = null;
            });
        });
    </script>
</body>
</html>
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چاپ لیبل با بارکد واقعی</title>
    <style>
        /* تنظیمات چاپ */
        @page {
            size: 80mm auto;
            margin: 0mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', Arial, sans-serif;
        }

        @media screen {
            .print-only {
                display: none !important;
            }
            .screen-only {
                display: block;
            }
        }

        @media print {
            .screen-only {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                width: 80mm;
                margin: 0 auto;
                padding: 0;
            }
        }

        /* لیبل چاپ */
        .label {
            width: 40mm;
            height: 20mm;
            position: relative;
            display: inline-block;
            overflow: visible;
            margin: 0;
            padding: 0;
        }

        /* اسم کالا - 3mm از بالا */
        .product-name {
            position: absolute;
            top: 3mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.8mm;
            font-weight: bold;
            font-family: 'Vazirmatn', sans-serif;
            line-height: 1;
            overflow: visible;
            white-space: nowrap;
            text-overflow: clip;
            margin: 0;
            padding: 0;
        }

        /* بارکد - زیر اسم کالا */
        .barcode-container {
            position: absolute;
            top: 5.5mm;
            left: 3.5mm;
            width: 33mm;
            height: 11mm;
            margin: 0;
            padding: 0;
        }

        .barcode-image {
            width: 33mm;
            height: 9mm;
            display: block;
        }

        .barcode-number {
            font-family: 'Courier New', monospace;
            font-size: 1.5mm;
            text-align: center;
            margin-top: 0.2mm;
            direction: ltr;
            font-weight: bold;
        }

        /* قیمت - زیر بارکد */
        .price {
            position: absolute;
            bottom: 0.5mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 2.5mm;
            font-weight: bold;
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* کانتینرهای چاپ */
        .print-container {
            width: 80mm;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .labels-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3mm;
        }

        /* استایل‌های صفحه نمایش */
        .screen-only {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Vazirmatn', sans-serif;
        }

        .summary-box {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: right;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #c8e6c9;
        }

        .btn {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Vazirmatn', sans-serif;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        /* پیش‌نمایش */
        .preview-label {
            width: 40mm;
            height: 20mm;
            border: 1px dashed #ccc;
            position: relative;
            display: inline-block;
            background: white;
            margin: 5px;
        }

        .preview-product-name {
            position: absolute;
            top: 3mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.8mm;
            font-weight: bold;
            font-family: 'Vazirmatn', sans-serif;
        }

        .preview-price {
            position: absolute;
            bottom: 0.5mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 2.5mm;
            font-weight: bold;
            font-family: 'Vazirmatn', sans-serif;
        }

        .preview-barcode-container {
            position: absolute;
            top: 5.5mm;
            left: 3.5mm;
            width: 33mm;
            height: 11mm;
        }

        .preview-barcode {
            width: 33mm;
            height: 9mm;
        }

        .preview-barcode-number {
            font-family: 'Courier New', monospace;
            font-size: 1.5mm;
            text-align: center;
            margin-top: 0.2mm;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
</head>
<body>
    <!-- صفحه نمایش -->
    <div class="screen-only">
        <h2>چاپ لیبل بارکد</h2>

        <div class="summary-box">
            <h3>خلاصه لیبل‌ها</h3>
            {% regroup all_labels by product_name as product_list %}
            {% for product in product_list %}
            <div class="summary-item">
                <span>{{ product.grouper }}</span>
                <strong>{{ product.list|length }} لیبل</strong>
            </div>
            {% endfor %}
            <div class="summary-item" style="background: #4CAF50; color: white;">
                <span>تعداد کل:</span>
                <strong>{{ total_labels }} عدد</strong>
            </div>
        </div>

        <!-- پیش‌نمایش -->
        <div style="text-align: center; margin: 30px 0;">
            <h3>پیش‌نمایش</h3>
            <div style="display: inline-block; padding: 10px; background: white; border-radius: 8px;">
                {% for label in all_labels|slice:":4" %}
                    {% if forloop.counter0|divisibleby:2 %}<div style="display: flex; justify-content: center; gap: 3mm;">{% endif %}
                    <div class="preview-label">
                        {% if label.show_name %}
                        <div class="preview-product-name">{{ label.product_name }}</div>
                        {% endif %}

                        <div class="preview-barcode-container">
                            <svg class="preview-barcode" data-barcode="{{ label.barcode }}"></svg>
                            <div class="preview-barcode-number">{{ label.barcode }}</div>
                        </div>

                        {% if label.show_price %}
                        <div class="preview-price" id="preview-price-{{ forloop.counter0 }}"></div>
                        {% endif %}
                    </div>
                    {% if forloop.counter|divisibleby:2 or forloop.last %}</div>{% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- دکمه‌ها -->
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="printLabels()" class="btn btn-primary">چاپ بارکد فوق پررنگ</button>
            <a href="{% url 'label_settings' %}" class="btn btn-secondary">بازگشت به تنظیمات</a>
            <a href="{% url 'label_generator' %}" class="btn btn-secondary">بازگشت به انتخاب کالا</a>
        </div>
    </div>

    <!-- بخش چاپ -->
    <div class="print-only">
        {% for label in all_labels %}
            {% if forloop.counter0|divisibleby:2 %}
            <div class="print-container">
                <div class="labels-row">
            {% endif %}

            <div class="label">
                {% if label.show_name %}
                <div class="product-name">{{ label.product_name }}</div>
                {% endif %}

                <div class="barcode-container">
                    <svg class="barcode-image" id="barcode-{{ forloop.counter0 }}"></svg>
                    <div class="barcode-number">{{ label.barcode }}</div>
                </div>

                {% if label.show_price %}
                <div class="price" id="price-{{ forloop.counter0 }}">{{ label.price|floatformat:0 }} تومان</div>
                {% endif %}
            </div>

            {% if forloop.counter|divisibleby:2 or forloop.last %}
                </div>
            </div>
            {% if not forloop.last %}
            <div style="page-break-before: always;"></div>
            {% endif %}
            {% endif %}
        {% endfor %}
    </div>

    <script>
        // تنظیمات بارکد
        const barcodeSettings = {
            format: "EAN13",
            width: 2.5,
            height: 100,
            displayValue: false,
            fontSize: 0,
            margin: 8,
            background: "#FFFFFF",
            lineColor: "#000000"
        };

        const extraThickBarcodeSettings = {
            format: "EAN13",
            width: 3.0,
            height: 100,
            displayValue: false,
            fontSize: 0,
            margin: 5,
            background: "#FFFFFF",
            lineColor: "#000000"
        };

        // تابع تبدیل به فارسی
        function toPersianNumber(englishNumber) {
            if (!englishNumber) return '۰';
            const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
            return englishNumber.toString().replace(/\d/g, function(digit) {
                return persianDigits[digit];
            });
        }

        // تولید بارکدها
        function generateBarcodes(settings) {
            // پیش‌نمایش
            document.querySelectorAll('.preview-barcode').forEach((svg, index) => {
                const barcode = svg.getAttribute('data-barcode');
                if (barcode) {
                    JsBarcode(svg, barcode, settings);
                }
            });

            // چاپ
            document.querySelectorAll('.barcode-image').forEach((svg, index) => {
                const barcode = svg.parentElement.querySelector('.barcode-number').textContent.trim();
                if (barcode) {
                    JsBarcode(svg, barcode, settings);
                }
            });

            // تبدیل قیمت‌ها به فارسی
            document.querySelectorAll('.price').forEach(element => {
                const text = element.textContent;
                const parts = text.split(' ');
                if (parts.length >= 2) {
                    const numberPart = parts[0];
                    const unitPart = parts.slice(1).join(' ');
                    const persianNumber = toPersianNumber(numberPart);
                    element.textContent = persianNumber + ' ' + unitPart;
                }
            });

            document.querySelectorAll('.preview-price').forEach((element, index) => {
                const priceElement = document.getElementById('price-' + index);
                if (priceElement) {
                    element.textContent = priceElement.textContent;
                }
            });
        }


        function printLabels() {
    if (!confirm('آیا مطمئن هستید که می‌خواهید لیبل‌ها را چاپ کنید؟')) {
        return;
    }

    generateBarcodes(extraThickBarcodeSettings);

    setTimeout(() => {
        window.print();

        // ✅ فقط این دو خط را اضافه کنید:
        fetch("{% url 'disable_print_and_clear_cart' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        });
        // ✅ پایان تغییرات

        setTimeout(() => {
            alert('چاپ انجام شد. اجازه چاپ مجدد غیرفعال شد.');
            window.location.href = "{% url 'label_generator' %}";
        }, 500);
    }, 500);
}
        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            generateBarcodes(barcodeSettings);
        });
    </script>
</body>
</html>